<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zhaoxiaowen-sven.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="FrameWork_05_Viewç»˜åˆ¶æµç¨‹">
<meta property="og:type" content="article">
<meta property="og:title" content="FrameWork_05_Viewç»˜åˆ¶æµç¨‹">
<meta property="og:url" content="https://zhaoxiaowen-sven.github.io/2021/06/20/Notes/Android/04Framework/FrameWork_05_View%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B/index.html">
<meta property="og:site_name" content="Sven&#39;s blog">
<meta property="og:description" content="FrameWork_05_Viewç»˜åˆ¶æµç¨‹">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://zhaoxiaowen-sven.github.io/pics/image-20210620184143390.png">
<meta property="og:image" content="https://zhaoxiaowen-sven.github.io/pics/image-20220717190750406.png">
<meta property="og:image" content="https://zhaoxiaowen-sven.github.io/pics/image-20210620220355400.png">
<meta property="og:image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/14/17213311a7877e9c~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp">
<meta property="og:image" content="https://zhaoxiaowen-sven.github.io/pics/image-20210620214953160.png">
<meta property="og:image" content="https://zhaoxiaowen-sven.github.io/pics/image-20210620221717118.png">
<meta property="og:image" content="https://zhaoxiaowen-sven.github.io/pics/image-20210620224045177.png">
<meta property="og:image" content="https://zhaoxiaowen-sven.github.io/pics/image-20210620224422346.png">
<meta property="og:image" content="https://zhaoxiaowen-sven.github.io/pics/image-20210620231436212.png">
<meta property="og:image" content="https://zhaoxiaowen-sven.github.io/pics/image-20210620232417701.png">
<meta property="article:published_time" content="2021-06-20T07:48:24.628Z">
<meta property="article:modified_time" content="2022-07-23T16:30:03.075Z">
<meta property="article:author" content="sven">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zhaoxiaowen-sven.github.io/pics/image-20210620184143390.png">

<link rel="canonical" href="https://zhaoxiaowen-sven.github.io/2021/06/20/Notes/Android/04Framework/FrameWork_05_View%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>FrameWork_05_Viewç»˜åˆ¶æµç¨‹ | Sven's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>
      <a target="_blank" rel="noopener" href="https://github.com/zhaoxiaowen-sven" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Sven's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhaoxiaowen-sven.github.io/2021/06/20/Notes/Android/04Framework/FrameWork_05_View%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/sven.jpeg">
      <meta itemprop="name" content="sven">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sven's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          FrameWork_05_Viewç»˜åˆ¶æµç¨‹
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-06-20 15:48:24" itemprop="dateCreated datePublished" datetime="2021-06-20T15:48:24+08:00">2021-06-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/Framework/" itemprop="url" rel="index"><span itemprop="name">Framework</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="é˜…è¯»æ¬¡æ•°" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="FrameWork-05-Viewç»˜åˆ¶æµç¨‹"><a href="#FrameWork-05-Viewç»˜åˆ¶æµç¨‹" class="headerlink" title="FrameWork_05_Viewç»˜åˆ¶æµç¨‹"></a>FrameWork_05_Viewç»˜åˆ¶æµç¨‹</h1><span id="more"></span>

<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><ul>
<li><strong>Activity :</strong> å¯¹äºæ¯ä¸€ä¸ª activity éƒ½ä¼šæœ‰æ‹¥æœ‰ä¸€ä¸ª PhoneWindowã€‚</li>
<li><strong>PhoneWindow</strong> ï¼šè¯¥ç±»ç»§æ‰¿äº Window ç±»ï¼Œæ˜¯ Window ç±»çš„å…·ä½“å®ç°ï¼Œå³æˆ‘ä»¬å¯ä»¥é€šè¿‡è¯¥ç±»å…·ä½“å»ç»˜åˆ¶çª—å£ã€‚å¹¶ä¸”ï¼Œè¯¥ç±»å†…éƒ¨åŒ…å«äº†ä¸€ä¸ª DecorView å¯¹è±¡ï¼Œè¯¥ DectorView å¯¹è±¡æ˜¯æ‰€æœ‰åº”ç”¨çª—å£çš„æ ¹ Viewã€‚</li>
<li><strong>DecorView</strong> æ˜¯ä¸€ä¸ªåº”ç”¨çª—å£çš„æ ¹å®¹å™¨ï¼Œå®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª FrameLayoutã€‚DecorView æœ‰å”¯ä¸€ä¸€ä¸ªå­ Viewï¼Œå®ƒæ˜¯ä¸€ä¸ªå‚ç›´ LinearLayoutï¼ŒåŒ…å«ä¸¤ä¸ªå­å…ƒç´ ï¼Œä¸€ä¸ªæ˜¯ TitleViewï¼ˆ ActionBar çš„å®¹å™¨ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯ ContentViewï¼ˆçª—å£å†…å®¹çš„å®¹å™¨ï¼‰ã€‚</li>
<li><strong>ContentView</strong> ï¼šæ˜¯ä¸€ä¸ª FrameLayoutï¼ˆandroid.R.id.content)ï¼Œæˆ‘ä»¬å¹³å¸¸ç”¨çš„ setContentView å°±æ˜¯è®¾ç½®å®ƒçš„å­ View ã€‚</li>
<li><strong>WindowManager :</strong> æ˜¯ä¸€ä¸ªæ¥å£ï¼Œé‡Œé¢å¸¸ç”¨çš„æ–¹æ³•æœ‰ï¼šæ·»åŠ Viewï¼Œæ›´æ–°Viewå’Œåˆ é™¤Viewã€‚ä¸»è¦æ˜¯ç”¨æ¥ç®¡ç† Window çš„ã€‚WindowManager å…·ä½“çš„å®ç°ç±»æ˜¯WindowManagerImplã€‚æœ€ç»ˆï¼ŒWindowManagerImpl ä¼šå°†ä¸šåŠ¡äº¤ç»™ WindowManagerGlobal æ¥å¤„ç†ã€‚</li>
<li><strong>WindowManagerService (WMS)</strong> ï¼š è´Ÿè´£ç®¡ç†å„ app çª—å£çš„åˆ›å»ºï¼Œæ›´æ–°ï¼Œåˆ é™¤ï¼Œ æ˜¾ç¤ºé¡ºåºã€‚è¿è¡Œåœ¨ system_server è¿›ç¨‹ã€‚</li>
<li><strong>ViewRootImpl</strong> ï¼šæ‹¥æœ‰ DecorView çš„å®ä¾‹ï¼Œé€šè¿‡è¯¥å®ä¾‹æ¥æ§åˆ¶ DecorView ç»˜åˆ¶ã€‚ViewRootImpl çš„ä¸€ä¸ªå†…éƒ¨ç±» Wï¼Œå®ç°äº† IWindow æ¥å£ï¼ŒIWindow æ¥å£æ˜¯ä¾› WMS ä½¿ç”¨çš„ï¼ŒWSM é€šè¿‡è°ƒç”¨ IWindow ä¸€äº›æ–¹æ³•ï¼Œé€šè¿‡ Binder é€šä¿¡çš„æ–¹å¼ï¼Œæœ€åæ‰§è¡Œåˆ°äº† W ä¸­å¯¹åº”çš„æ–¹æ³•ä¸­ã€‚åŒæ ·çš„ï¼ŒViewRootImpl é€šè¿‡ IWindowSession æ¥è°ƒç”¨ WMS çš„ Session ä¸€äº›æ–¹æ³•ã€‚Session ç±»ç»§æ‰¿è‡ª <code>IWindowSession.Stub</code>ï¼Œæ¯ä¸€ä¸ªåº”ç”¨è¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ Session å¯¹è±¡ä¸ WMS é€šä¿¡ã€‚</li>
</ul>
<p><code>Activity</code>çš„å¸ƒå±€å±‚æ¬¡æ•´ä½“ä»ä¸Šåˆ°ä¸‹çœ‹æ¥ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</p>
<img src="/pics/image-20210620184143390.png" alt="image-20210620184143390" style="zoom:50%;" />

<h1 id="ä¸€ã€å¸ƒå±€åˆ›å»ºè¿‡ç¨‹"><a href="#ä¸€ã€å¸ƒå±€åˆ›å»ºè¿‡ç¨‹" class="headerlink" title="ä¸€ã€å¸ƒå±€åˆ›å»ºè¿‡ç¨‹"></a>ä¸€ã€å¸ƒå±€åˆ›å»ºè¿‡ç¨‹</h1><p><code>ActivityLayout</code>çš„ç»˜åˆ¶å’Œæ˜¾ç¤ºæ˜¯ä¼´éšç€<code>Activity</code>çš„ç”Ÿå‘½å‘¨æœŸè€Œè¿›è¡Œçš„ã€‚</p>
<img src="/pics/image-20220717190750406.png" alt="image-20220717190750406" style="zoom:50%;" />

<p><code>Activity</code>çš„å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œ<code>ActivityThread</code>ç±»ä¸­çš„<code>handleLaunchActivity</code>ï¼Œ<code>performLaunchActivity</code>ï¼Œ<code>handleResumeActivity</code>è¿™3ä¸ªä¸»è¦çš„æ–¹æ³•å®Œæˆäº†</p>
<p><code>Activity</code>çš„<strong>åˆ›å»ºåˆ°å¯åŠ¨å·¥ä½œ</strong>ï¼ŒåŒæ—¶è¿™ä¸ªè¿‡ç¨‹ä¹Ÿä¼´éšç€Viewçš„ç»˜åˆ¶ã€‚ä¸‹é¢æˆ‘ä»¬ä»æºç è§’åº¦è§’åº¦åˆ†æä¸‹è¿™ä¸ªæµç¨‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent, String reason)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="comment">// ğŸ‘‰ æ­¤æ–¹æ³•ä¸­å®Œæˆ Activity ç”Ÿå‘½å‘¨æœŸçš„ onCreate å’Œ onStart æ–¹æ³•</span></span><br><span class="line">    Activity a = performLaunchActivity(r, customIntent);  </span><br><span class="line">    <span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="comment">// ğŸ‘‰ æ­¤æ–¹æ³•ä¸­å®Œæˆ Activity ç”Ÿå‘½å‘¨æœŸçš„ onResume æ–¹æ³•</span></span><br><span class="line">        <span class="comment">// &gt;= Android 9 ä¸Š handleResumeActivity ä¸æ˜¯è¿™é‡Œï¼Œä½†ä¸»è¦æµç¨‹é¡ºåºä¸å˜ </span></span><br><span class="line">        handleResumeActivity(r.token, <span class="keyword">false</span>, r.isForward,</span><br><span class="line">                !r.activity.mFinished &amp;&amp; !r.startsNotResumed, r.lastProcessedSeq, reason);   </span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-1ã€ActivityThread-performLaunchActivity"><a href="#1-1ã€ActivityThread-performLaunchActivity" class="headerlink" title="1.1ã€ActivityThread#performLaunchActivity"></a>1.1ã€<code>ActivityThread#performLaunchActivity</code></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ğŸ‘‰ é€šè¿‡åå°„åˆ›å»º Activity å®ä¾‹</span></span><br><span class="line">    java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</span><br><span class="line">    activity = mInstrumentation.newActivity(cl, component.getClassName(), r.intent);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ‘‰ é€šè¿‡åå°„æ„å»º Applicationï¼Œå¦‚æœå·²ç»æ„å»ºåˆ™ä¸ä¼šé‡å¤æ„å»ºï¼Œä¸€ä¸ªè¿›ç¨‹åªèƒ½æœ‰ä¸€ä¸ª Application</span></span><br><span class="line">    Application app = r.packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Context appContext = createBaseContextForActivity(r, activity);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ğŸ‘‰ åœ¨è¿™é‡Œå®ä¾‹åŒ–äº† PhoneWindowï¼Œå¹¶å°†è¯¥ Activity è®¾ç½®ä¸º PhoneWindow çš„ Callback å›è°ƒï¼›</span></span><br><span class="line">        <span class="comment">// åˆå§‹åŒ– WindowManager</span></span><br><span class="line">        activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</span><br><span class="line">                r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">                r.embeddedID, r.lastNonConfigurationInstances, config);</span><br><span class="line">        </span><br><span class="line">				<span class="comment">// ...</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ğŸ‘‰ è°ƒç”¨äº† Activity çš„ performCreate æ–¹æ³•ï¼Œé—´æ¥è°ƒç”¨äº† Activity çš„ onCreate æ–¹æ³•</span></span><br><span class="line">        mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ğŸ‘‰ è°ƒç”¨ Activity çš„ onStart æ–¹æ³•</span></span><br><span class="line">        <span class="keyword">if</span> (!r.activity.mFinished) &#123;</span><br><span class="line">            activity.performStart();</span><br><span class="line">            r.stopped = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-1-1ã€-Activity-attach"><a href="#1-1-1ã€-Activity-attach" class="headerlink" title="1.1.1ã€ Activity#attach"></a>1.1.1ã€ <code>Activity#attach</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Context context, ActivityThread aThread,</span></span></span><br><span class="line"><span class="params"><span class="function">        Instrumentation instr, IBinder token, <span class="keyword">int</span> ident,</span></span></span><br><span class="line"><span class="params"><span class="function">        Application application, Intent intent, ActivityInfo info,</span></span></span><br><span class="line"><span class="params"><span class="function">        CharSequence title, Activity parent, String id,</span></span></span><br><span class="line"><span class="params"><span class="function">        NonConfigurationInstances lastNonConfigurationInstances,</span></span></span><br><span class="line"><span class="params"><span class="function">        Configuration config, String referrer, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="params"><span class="function">        Window window, ActivityConfigCallback activityConfigCallback)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ‘‰ å®ä¾‹åŒ– PhoneWindow</span></span><br><span class="line">    mWindow = <span class="keyword">new</span> PhoneWindow(<span class="keyword">this</span>, window, activityConfigCallback);</span><br><span class="line">    mWindow.setWindowControllerCallback(<span class="keyword">this</span>);</span><br><span class="line">    mWindow.setCallback(<span class="keyword">this</span>);</span><br><span class="line">    mWindow.setOnWindowDismissedCallback(<span class="keyword">this</span>);</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ğŸ‘‰ ä¸º Activity çš„ Window è®¾ç½® WindowManager</span></span><br><span class="line">    mWindow.setWindowManager(</span><br><span class="line">            (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),</span><br><span class="line">            mToken, mComponent.flattenToString(),</span><br><span class="line">            (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    mWindowManager = mWindow.getWindowManager();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-1-2ã€Instrumentation-callActivityOnCreate"><a href="#1-1-2ã€Instrumentation-callActivityOnCreate" class="headerlink" title="1.1.2ã€Instrumentation#callActivityOnCreate"></a>1.1.2ã€<code>Instrumentation#callActivityOnCreate</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnCreate</span><span class="params">(Activity activity, Bundle icicle)</span> </span>&#123;</span><br><span class="line">    prePerformCreate(activity);</span><br><span class="line">    activity.performCreate(icicle);</span><br><span class="line">    postPerformCreate(activity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ğŸ‘‰ ç„¶åè°ƒç”¨ Activity çš„ performCreate æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performCreate</span><span class="params">(Bundle icicle)</span> </span>&#123;</span><br><span class="line">    performCreate(icicle, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ğŸ‘‰ æ‰§è¡Œ onCreate ç”Ÿå‘½å‘¨æœŸ</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performCreate</span><span class="params">(Bundle icicle, PersistableBundle persistentState)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (persistentState != <span class="keyword">null</span>) &#123;</span><br><span class="line">        onCreate(icicle, persistentState);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        onCreate(icicle);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1ã€Activity-setContentView"><a href="#1ã€Activity-setContentView" class="headerlink" title="1ã€Activity#setContentView"></a>1ã€<code>Activity#setContentView</code></h4><img src="/pics/image-20210620220355400.png" alt="image-20210620220355400" style="zoom:40%;" />

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ğŸ‘‰ æœ€å¸¸ç”¨çš„ setContentView æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(<span class="keyword">int</span> layoutResID)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Window#setContentView</span></span><br><span class="line">    getWindow().setContentView(layoutResID);</span><br><span class="line">    initWindowDecorActionBar();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2ã€PhoneWindow-setContentView"><a href="#2ã€PhoneWindow-setContentView" class="headerlink" title="2ã€PhoneWindow#setContentView"></a>2ã€<code>PhoneWindow#setContentView</code></h4><ol>
<li>åˆ›å»ºDecorView </li>
<li>å°†Activity å¸ƒå±€æ·»åŠ åˆ° mContentParent ä¸­</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¸ƒå±€é¡ºåº</span></span><br><span class="line">    setContentView(view, <span class="keyword">new</span> ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(<span class="keyword">int</span> layoutResID)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// step1: åˆ›å»ºdecorView</span></span><br><span class="line">        installDecor();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</span><br><span class="line">        mContentParent.removeAllViews();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</span><br><span class="line">        <span class="keyword">final</span> Scene newScene = Scene.getSceneForLayout(mContentParent, layoutResID,</span><br><span class="line">                getContext());</span><br><span class="line">        transitionTo(newScene);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// step2: åŠ è½½å¸ƒå±€</span></span><br><span class="line">        mLayoutInflater.inflate(layoutResID, mContentParent);</span><br><span class="line">    &#125;</span><br><span class="line">    mContentParent.requestApplyInsets();</span><br><span class="line">    <span class="keyword">final</span> Callback cb = getCallback();</span><br><span class="line">    <span class="keyword">if</span> (cb != <span class="keyword">null</span> &amp;&amp; !isDestroyed()) &#123;</span><br><span class="line">        cb.onContentChanged();</span><br><span class="line">    &#125;</span><br><span class="line">    mContentParentExplicitlySet = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3ã€PhoneWindow-installDecor"><a href="#3ã€PhoneWindow-installDecor" class="headerlink" title="3ã€PhoneWindow#installDecor"></a>3ã€<code>PhoneWindow#installDecor</code></h4><p><code>installDecor</code>æ–¹æ³•ä¸»è¦åšäº†ä»¥ä¸‹å‡ æ­¥å·¥ä½œï¼š</p>
<ul>
<li> åˆå§‹åŒ–<code>mDecor</code>ï¼šè°ƒç”¨<code>generateDecor</code>æ–¹æ³•æ¥åˆ›å»º<code>mDecor</code>å¯¹è±¡ï¼›</li>
<li> åˆå§‹åŒ–<code>mContentParent</code>ï¼šè°ƒç”¨<code>generateLayout</code>æ–¹æ³•åˆ›å»º<code>mContentParent</code>å¯¹è±¡ï¼›</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">installDecor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ğŸ‘‰ åˆå§‹åŒ– mDecor</span></span><br><span class="line">    <span class="keyword">if</span> (mDecor == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœ mDecor ä¸ºç©ºï¼Œåˆ™ç”Ÿæˆä¸€ä¸ª DecorView å¯¹è±¡</span></span><br><span class="line">        mDecor = generateDecor(-<span class="number">1</span>);</span><br><span class="line">        </span><br><span class="line">        ...</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å°† PhoneWindow è®¾ç½®ç»™ mDecor</span></span><br><span class="line">        mDecor.setWindow(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// ğŸ‘‰ åˆå§‹åŒ– mContentParent</span></span><br><span class="line">        mContentParent = generateLayout(mDecor);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ğŸ‘‰ generateDecorï¼šåˆå§‹åŒ– DecorView</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> DecorView <span class="title">generateDecor</span><span class="params">(<span class="keyword">int</span> featureId)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DecorView(context, featureId, <span class="keyword">this</span>, getAttributes());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ğŸ‘‰ generateLayoutï¼šæ ¹æ®çª—å£çš„é£æ ¼ï¼Œä¸º DecorView é€‰æ‹©å¯¹åº”çš„å¸ƒå±€æ–‡ä»¶</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> ViewGroup <span class="title">generateLayout</span><span class="params">(DecorView decor)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–çª—å£å±æ€§</span></span><br><span class="line">    TypedArray a = getWindowStyle();</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> layoutResource;</span><br><span class="line">    <span class="keyword">int</span> features = getLocalFeatures();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ğŸ‘‰ æ ¹æ®è®¾å®šå¥½çš„ features å€¼é€‰æ‹©ä¸åŒçš„çª—å£å¸ƒå±€æ–‡ä»¶ï¼Œå¾—åˆ° layoutResource å€¼ï¼Œå‰æ–‡ä¸­æ›¾ä»¥ screen_simple ä¸¾ä¾‹</span></span><br><span class="line">    <span class="comment">// æ³¨æ„ï¼šæ­¤å¤„è¿˜æœ‰å¾ˆå¤šåˆ†æ”¯åˆ¤æ–­ä»£ç çœç•¥äº†</span></span><br><span class="line">    <span class="keyword">if</span> ((features &amp; (<span class="number">1</span> &lt;&lt; FEATURE_SWIPE_TO_DISMISS)) != <span class="number">0</span>) &#123;</span><br><span class="line">        layoutResource = R.layout.screen_swipe_dismiss;</span><br><span class="line">    &#125; </span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ‘‰ æŠŠé€‰ä¸­çš„çª—å£å¸ƒå±€æ–‡ä»¶è§£ææˆ View æ ‘ï¼Œå¹¶æ·»åŠ åˆ° DecorView ä¸­</span></span><br><span class="line">    <span class="comment">// [ä»LayoutInflateråˆ†æXMLå¸ƒå±€è§£ææˆViewçš„æ ‘å½¢ç»“æ„çš„è¿‡ç¨‹](http://blog.csdn.net/feiduclear_up/article/details/46732879) </span></span><br><span class="line">    mDecor.onResourcesLoaded(mLayoutInflater, layoutResource);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ‘‰ æŒ‡å®š contentParent å€¼ï¼Œå¯¹åº”çš„æ˜¯å¸ƒå±€æ–‡ä»¶ä¸­ id ä¸º content çš„ View</span></span><br><span class="line">    ViewGroup contentParent = (ViewGroup)findViewById(ID_ANDROID_CONTENT);</span><br><span class="line">    <span class="keyword">if</span> (contentParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Window couldn&#x27;t find content container view&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ‘‰ è¿”å› contentParentï¼Œèµ‹å€¼ç»™ mContentParentï¼Œæ‰€ä»¥ mContentParent å¯¹åº”çš„æ˜¯ R.id.content</span></span><br><span class="line">    <span class="keyword">return</span> contentParent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>installDecoræ–¹æ³•å®è´¨å°±æ˜¯äº§ç”ŸmDecorå’ŒmContentParentå¯¹è±¡ã€‚</strong></p>
<h2 id="1-2ã€ActivityThread-handleResumeActivity"><a href="#1-2ã€ActivityThread-handleResumeActivity" class="headerlink" title="1.2ã€ActivityThread#handleResumeActivity"></a><code>1.2ã€ActivityThread#handleResumeActivity</code></h2><p>æ‰§è¡Œå®Œ<code>onCreate</code>ç”Ÿå‘½å‘¨æœŸåï¼Œæ¥åˆ°äº†<code>handleResumeActivity()</code>æ–¹æ³•ä¸­æ‰§è¡Œ<code>onResume</code>ç”Ÿå‘½å‘¨æœŸï¼Œæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬ä¹Ÿä»…æ˜¯ç”Ÿæˆäº†ä¸€ä¸ª<code>Activity</code>ï¼Œä¸€ä¸ª<code>PhoneWindow</code>ï¼Œä¸€ä¸ª<code>DecorView</code>ï¼Œè€Œ<strong>å¹¶æœªçœŸæ­£çš„å°†æˆ‘ä»¬éœ€è¦æ˜¾ç¤ºçš„å†…å®¹å’ŒAndroidç³»ç»Ÿè¿›è¡Œäº¤äº’ï¼Œä»¥è¿›è¡ŒViewç»˜åˆ¶</strong>ã€‚</p>
<ol>
<li><strong>æ‰§onResumeç”Ÿå‘½å‘¨æœŸ</strong>ï¼šè°ƒç”¨ <code>performResumeActivity</code> æ¥é—´æ¥æ‰§è¡Œ Activity çš„ <code>onResume</code> ç”Ÿå‘½å‘¨æœŸï¼›</li>
<li> <strong>è·å–Activityçš„Windowå’ŒDecorView</strong>ï¼šè·å–è¿™ä¸¤ä¸ªå˜é‡èµ‹å€¼ç»™ç›¸å…³å˜é‡ï¼ŒåŒæ—¶æš‚æ—¶ä½¿ <code>DecorView</code> ä¸å¯è§ï¼›</li>
<li><strong>è·å– WindowManager</strong>ï¼šåœ¨<code>Activity.attach()</code>æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ä¸ºActivityè®¾ç½®äº†<code>WindowManager</code>ï¼›</li>
<li> <strong>WindowManageræ·»åŠ DecorView</strong>ï¼šè°ƒç”¨<code>WindowManager.addView</code>æ–¹æ³•ä¸ºWindowæ·»åŠ <code>DecorView</code>ï¼›</li>
<li> <strong>ä½¿å¾— DecorView å¯è§</strong>ï¼šè°ƒç”¨<code>Activity.makeVisible</code>æ–¹æ³•ä½¿å¾—<code>DecorView</code>é‡æ–°å¯è§ã€‚</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">handleResumeActivity</span><span class="params">(IBinder token,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">boolean</span> clearHide, <span class="keyword">boolean</span> isForward, <span class="keyword">boolean</span> reallyResume, <span class="keyword">int</span> seq, String reason)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ğŸ‘‰ åœ¨å…¶å†…éƒ¨é—´æ¥æ‰§è¡Œ Activity çš„ onResume æ–¹æ³•ï¼Œæ­¤æ—¶ç•Œé¢è¿˜ä¸å¯è§</span></span><br><span class="line">    ActivityClientRecord r = performResumeActivity(token, clearHide, reason);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">final</span> Activity a = r.activity;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ğŸ‘‰ è·å– Windowï¼ŒDecorView ç­‰å¯¹è±¡</span></span><br><span class="line">    r.window = r.activity.getWindow();</span><br><span class="line">    View decor = r.window.getDecorView();</span><br><span class="line">    <span class="comment">// ğŸ‘‰ ä½¿ DecorView ä¸å¯è§</span></span><br><span class="line">    decor.setVisibility(View.INVISIBLE);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ğŸ‘‰ è·å– WindowManager</span></span><br><span class="line">    ViewManager wm = a.getWindowManager();</span><br><span class="line">    WindowManager.LayoutParams l = r.window.getAttributes();</span><br><span class="line">    a.mDecor = decor;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (a.mVisibleFromClient &amp;&amp; !a.mWindowAdded) &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="comment">// ğŸ‘‰ WindowManager æ·»åŠ  DecorViewï¼Œæ­¤æ—¶ä¾ç„¶ä¸å¯è§</span></span><br><span class="line">        wm.addView(decor, l);</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (r.activity.mVisibleFromClient) &#123;</span><br><span class="line">        <span class="comment">// ğŸ‘‰ ä½¿å¾— DecorView å¯è§</span></span><br><span class="line">        r.activity.makeVisible();</span><br><span class="line">    &#125;</span><br><span class="line">            </span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ğŸ‘‰ Activity.makeVisibleæ–¹æ³•ï¼šä½¿å¾— DecorView å¯è§</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">makeVisible</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    mDecor.setVisibility(View.VISIBLE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-2-1ã€WindowManager-addView"><a href="#1-2-1ã€WindowManager-addView" class="headerlink" title="1.2.1ã€WindowManager#addView"></a><code>1.2.1ã€WindowManager#addView</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">WindowManager</span> <span class="keyword">extends</span> <span class="title">ViewManager</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ViewManager</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(View view, ViewGroup.LayoutParams params)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateViewLayout</span><span class="params">(View view, ViewGroup.LayoutParams params)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeView</span><span class="params">(View view)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">WindowManagerImpl</span> <span class="keyword">implements</span> <span class="title">WindowManager</span> </span>&#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(<span class="meta">@NonNull</span> View view, <span class="meta">@NonNull</span> ViewGroup.LayoutParams params)</span> </span>&#123;</span><br><span class="line">        applyDefaultToken(params);</span><br><span class="line">        mGlobal.addView(view, params, mContext.getDisplayNoVerify(), mParentWindow,</span><br><span class="line">                mContext.getUserId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">WindowManagerGlobal</span> </span>&#123;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(View view, ViewGroup.LayoutParams params,</span></span></span><br><span class="line"><span class="params"><span class="function">            Display display, Window parentWindow)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// ğŸ‘‰ ViewRootImpl å¯¹è±¡</span></span><br><span class="line">        ViewRootImpl root;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// ğŸ‘‰ åˆå§‹åŒ– ViewRootImpl </span></span><br><span class="line">            root = <span class="keyword">new</span> ViewRootImpl(view.getContext(), display);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">            <span class="comment">// ğŸ‘‰ è°ƒç”¨ ViewRootImpl.setView æ–¹æ³•</span></span><br><span class="line">            root.setView(view, wparams, panelParentView);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-2-2ã€ViewRootImpl-setView"><a href="#1-2-2ã€ViewRootImpl-setView" class="headerlink" title="1.2.2ã€ViewRootImpl#setView"></a><code>1.2.2ã€ViewRootImpl#setView</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ğŸ‘‰ ViewRootImpl.setView æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setView</span><span class="params">(View view, WindowManager.LayoutParams attrs, View panelParentView)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    </span><br><span class="line">        ğŸ‘‡</span><br><span class="line">    requestLayout();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">                            ğŸ‘‡</span><br><span class="line">    res = mWindowSession.addToDisplay(mWindow, mSeq, mWindowAttributes,</span><br><span class="line">                            getHostVisibility(), mDisplay.getDisplayId(), mTmpFrame,</span><br><span class="line">                            mAttachInfo.mContentInsets, mAttachInfo.mStableInsets,</span><br><span class="line">                            mAttachInfo.mOutsets, mAttachInfo.mDisplayCutout, mInputChannel,</span><br><span class="line">                            mTempInsets);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">            ğŸ‘‡ å°† DecorView çš„ parent è®¾ç½®ä¸º ViewRootImpl</span><br><span class="line">    view.assignParent(<span class="keyword">this</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//... </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æ­¤æ–¹æ³•ä¸­åšçš„å·¥ä½œä¸»è¦åŒ…æ‹¬ä»¥ä¸‹ä¸¤ä¸ªæ–¹é¢ï¼š</p>
<ul>
<li>1ï¸âƒ£ <strong>requestLayout()æ–¹æ³•</strong>ï¼š<strong>è°ƒç”¨Viewçš„æµ‹é‡ï¼Œå¸ƒå±€ï¼Œç»˜åˆ¶ä¸‰ä¸ªæµç¨‹</strong>ï¼›</li>
<li>2ï¸âƒ£ <strong>mWindowSession.addToDisplay()æ–¹æ³•</strong>ï¼š<strong>mWindowSession æ˜¯ä¸€ä¸ªaidlï¼ŒViewRootImpl åˆ©ç”¨å®ƒæ¥å’Œ WindowManagerService è¿›è¡Œè·¨è¿›ç¨‹äº¤äº’</strong>ï¼Œè¿™é‡Œå…ˆä¸è¿‡å¤šä»‹ç»æœ‰å…³ <code>WindowManagerService</code> å†…å®¹ï¼Œåªç®€å•ä»‹ç»ä¸‹å…¶ä½œç”¨ï¼Œå¦‚ä¸‹ã€‚</li>
</ul>
<blockquote>
<p>WindowManagerService(WMS)çš„ä½œç”¨æœ‰å¾ˆå¤šï¼š</p>
<ul>
<li><strong>çª—å£çš„ç®¡ç†è€…</strong>ï¼šè´Ÿè´£çª—å£çš„å¯åŠ¨ã€æ·»åŠ å’Œåˆ é™¤ï¼Œå¦å¤–çª—å£çš„å¤§å°å’Œå±‚çº§ä¹Ÿæ˜¯ç”±WMSè¿›è¡Œç®¡ç†ï¼›</li>
<li><strong>äº‹ä»¶çš„ç®¡ç†å’Œæ´¾å‘å·¥ä½œ</strong>ï¼šé€šè¿‡å¯¹çª—å£çš„è§¦æ‘¸ä»è€Œäº§ç”Ÿè§¦æ‘¸äº‹ä»¶ï¼ŒInputManagerServiceï¼ˆIMSï¼‰ä¼šå¯¹è§¦æ‘¸äº‹ä»¶è¿›è¡Œå¤„ç†ï¼Œå®ƒä¼šå¯»æ‰¾ä¸€ä¸ªæœ€åˆé€‚çš„çª—å£æ¥å¤„ç†è§¦æ‘¸åé¦ˆä¿¡æ¯ï¼ŒWMSæ˜¯çª—å£çš„ç®¡ç†è€…ï¼Œå› æ­¤ï¼ŒWMSâ€œç†æ‰€åº”å½“â€çš„æˆä¸ºäº†äº‹ä»¶çš„ä¸­è½¬ç«™ã€‚</li>
<li><strong>Surfaceç®¡ç†</strong>ï¼šçª—å£å¹¶ä¸å…·å¤‡æœ‰ç»˜åˆ¶çš„åŠŸèƒ½ï¼Œå› æ­¤æ¯ä¸ªçª—å£éƒ½éœ€è¦æœ‰ä¸€å—Surfaceæ¥ä¾›è‡ªå·±ç»˜åˆ¶ã€‚ä¸ºæ¯ä¸ªçª—å£åˆ†é…Surfaceæ˜¯ç”±WMSæ¥å®Œæˆçš„ã€‚</li>
</ul>
</blockquote>
<blockquote>
<p>æ‘˜è‡ª<a href="https://link.juejin.cn/?target=https://blog.csdn.net/itachi85/java/article/details/78186741">Androidè§£æWindowManagerServiceï¼ˆä¸€ï¼‰WMSçš„è¯ç”Ÿ</a></p>
</blockquote>
<p>æˆ‘ä»¬é‡ç‚¹çœ‹çœ‹ <code>requestLayout()</code> æ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public void requestLayout() &#123;</span><br><span class="line">    if (!mHandlingLayoutInLayoutRequest) &#123;</span><br><span class="line">        <span class="comment">// ğŸ‘‰ æ£€æŸ¥æ˜¯ä¸æ˜¯ä¸»çº¿ç¨‹</span></span><br><span class="line">        checkThread();</span><br><span class="line">        mLayoutRequested = true;</span><br><span class="line">        <span class="comment">// ğŸ‘‰ viewç»˜åˆ¶ä¸‰å¤§æµç¨‹å…¥å£</span></span><br><span class="line">        scheduleTraversals();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç†Ÿæ‚‰Viewç»˜åˆ¶æµç¨‹çš„åŒå­¦åº”è¯¥çŸ¥é“ï¼Œ<strong>å½“Viewçš„å¤§å°ã€å½¢çŠ¶å‘ç”Ÿäº†å˜åŒ–çš„æ—¶å€™ï¼Œå¯ä»¥è°ƒç”¨æ­¤æ–¹æ³•æ¥è¿›è¡Œé‡æ–°ç»˜åˆ¶ï¼Œæ­¤æ–¹æ³•ä¼šä»Viewæ ‘é‡æ–°è¿›è¡Œä¸€æ¬¡æµ‹é‡ã€å¸ƒå±€ã€ç»˜åˆ¶è¿™ä¸‰ä¸ªæµç¨‹</strong>ã€‚æ­¤æ–¹æ³•ä¸»è¦åšäº†ä¸¤æ­¥å·¥ä½œï¼š</p>
<ul>
<li>1ï¸âƒ£ <strong>æ£€æŸ¥å½“å‰çº¿ç¨‹</strong>ï¼šå¦‚æœè°ƒç”¨æ­¤æ–¹æ³•çš„ç°åœºä¸æ˜¯ä¸»çº¿ç¨‹ï¼Œé‚£ä¹ˆå°±åœ¨<code>checkThread()</code>æ–¹æ³•ä¸­æŠ›å‡ºå¼‚å¸¸ï¼Œè¿™ä¸€ç‚¹ä¸æˆ‘ä»¬â€é€šå¸¸æ„ä¹‰â€ä¸Šæ‰€è¯´çš„ï¼š<strong>åªèƒ½åœ¨ä¸»çº¿ç¨‹æ›´æ–°UIç›¸å»åˆ</strong>ï¼Œå…·ä½“checkThread()æ–¹æ³•ç¨åå†™æ˜ï¼›</li>
<li>2ï¸âƒ£ <strong>è°ƒç”¨ scheduleTraversals æ–¹æ³•</strong>ï¼šæ­¤æ–¹æ³•åç»­<strong>å®Œæˆäº†Viewçš„ä¸‰å¤§æµç¨‹ï¼ˆæµ‹é‡ï¼ˆmeasureï¼‰ï¼Œå¸ƒå±€ï¼ˆlayoutï¼‰ï¼Œç»˜åˆ¶ï¼ˆdrawï¼‰ï¼‰</strong>ï¼Œå…·ä½“åˆ†æè§åç»­ ã€‚</li>
</ul>
<p>å†çœ‹ä¸‹ <code>checkThread()</code> æ–¹æ³•ï¼š</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">checkThread</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">          ğŸ‘‡</span><br><span class="line">    <span class="keyword">if</span> (mThread != Thread.currentThread()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> CalledFromWrongThreadException(</span><br><span class="line">                <span class="string">&quot;Only the original thread that created a view hierarchy can touch its views.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>mThread</code> çš„åˆå§‹åŒ–æ˜¯åœ¨ <code>ViewRootImpl</code> çš„æ„é€ å‡½æ•°ä¸­å®Œæˆçš„ï¼š</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ViewRootImpl æ„é€ å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ViewRootImpl</span><span class="params">(Context context, Display display)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">      ğŸ‘‡</span><br><span class="line">    mThread = Thread.<span class="built_in">currentThread</span>();</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å›å¿†ä¸‹å‰æ–‡ï¼Œ <strong>ViewRootImpl çš„åˆå§‹åŒ–æ˜¯åœ¨ WindowManagerGlobal.addView æ–¹æ³•ä¸­å®Œæˆçš„ï¼Œå› æ­¤mThread è‚¯å®šå¯¹åº”çš„æ˜¯ä¸»çº¿ç¨‹ï¼Œå› ä¸º ActivityThread.handleLaunchActivity æ–¹æ³•å°±æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œè€Œå…¶ä¸­å¹¶æœªåˆ‡æ¢è¿‡çº¿ç¨‹ã€‚å› æ­¤å¦‚æœæˆ‘ä»¬åœ¨å­çº¿ç¨‹ä¸­æ›´æ–°UIï¼Œé‚£ä¹ˆæœ€ç»ˆä¼šèµ°åˆ° requestLayout æ–¹æ³•è¿›è¡Œé‡ç»˜åˆ¶ï¼Œä½†æ­¤æ—¶ä¼šå‘ç° mThreadï¼ˆä¸»çº¿ç¨‹ï¼‰ å’Œ Thread.currentThread()ï¼ˆå­çº¿ç¨‹ï¼‰ä¸æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆä¾¿ä¼šæŠ›å‡ºå¼‚å¸¸</strong>ã€‚</p>
<p>å†æ¥è¯´è¯´ <strong>ViewRootImpl</strong> ï¼Œå…¶ä½œç”¨éå¸¸é‡å¤§ã€‚<strong>æ‰€æœ‰Viewçš„ç»˜åˆ¶ä»¥åŠäº‹ä»¶åˆ†å‘ç­‰äº¤äº’éƒ½æ˜¯é€šè¿‡å®ƒæ¥æ‰§è¡Œæˆ–ä¼ é€’çš„ã€‚Viewçš„ä¸‰å¤§æµç¨‹ï¼ˆæµ‹é‡ï¼ˆmeasureï¼‰ï¼Œå¸ƒå±€ï¼ˆlayoutï¼‰ï¼Œç»˜åˆ¶ï¼ˆdrawï¼‰ï¼‰å‡é€šè¿‡ViewRootImplæ¥å®Œæˆã€‚Androidçš„æ‰€æœ‰è§¦å±äº‹ä»¶ã€æŒ‰é”®äº‹ä»¶ã€ç•Œé¢åˆ·æ–°ç­‰äº‹ä»¶éƒ½æ˜¯é€šè¿‡ViewRootImplè¿›è¡Œåˆ†å‘çš„ã€‚</strong></p>
<blockquote>
<ul>
<li><a href="https://link.juejin.cn/?target=https://www.jianshu.com/p/8766babc40e0">www.jianshu.com/p/8766babc4â€¦</a></li>
</ul>
</blockquote>
<p><strong>ä»æºç å®ç°ä¸Šæ¥çœ‹ï¼ŒViewRooImpl æ—¢éViewçš„å­ç±»ï¼Œä¹ŸéViewçš„çˆ¶ç±»ï¼Œä½†æ˜¯ï¼Œå®ƒå®ç°äº†ViewParentæ¥å£ï¼Œè¿™è®©å®ƒå¯ä»¥ä½œä¸ºViewçš„åä¹‰ä¸Šçš„çˆ¶è§†å›¾ã€‚</strong> åœ¨ <code>ViewRootImpl.setView</code> æ–¹æ³•ä¸­è°ƒç”¨äº† <code>View.assignParent</code> æ–¹æ³•ï¼š</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">void assignParent(ViewParent parent) &#123;</span><br><span class="line">    if (<span class="attr">mParent</span> == null) &#123;</span><br><span class="line">        <span class="attr">mParent</span> = parent<span class="comment">;</span></span><br><span class="line">    &#125; </span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Viewæ˜¯ä»¥Viewæ ‘ç»„ç»‡çš„ï¼Œæ¯ä¸ªViewéƒ½æœ‰å…¶Parentï¼ŒDecorViewä½œä¸ºæœ€é¡¶å±‚çš„Viewï¼Œå…¶Parentè¢«è®¾ç½®ä¸ºViewRootImplå¯¹è±¡</strong>ã€‚<strong>è¿™æ ·å®ƒå¯ä»¥ä½œä¸ºViewçš„åä¹‰ä¸Šçš„çˆ¶è§†å›¾ï¼Œå®è´¨ä¸Šå®Œæˆäº†Viewçš„æ›´æ–°ï¼Œç»˜åˆ¶ç­‰å·¥ä½œ</strong>ã€‚</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/14/17213311a7877e9c~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp" alt="View Tree"></p>
<p>Viewç±»ä¸­ä¹Ÿæœ‰<code>requestLayout</code>æ–¹æ³•ï¼š<strong>ç”¨äº View çš„ä½ç½®ï¼Œå¤§å°ã€å½¢çŠ¶å‘ç”Ÿäº†å˜åŒ–çš„æ—¶å€™è¿›è¡Œè°ƒç”¨</strong>ã€‚å½“ä¸€ä¸ª<strong>å­ View è°ƒç”¨æ­¤æ–¹æ³•æ—¶ï¼Œä¾¿ä¼šä»¤ View æ ‘é‡æ–°è¿›è¡Œä¸€æ¬¡æµ‹é‡ã€å¸ƒå±€ã€ç»˜åˆ¶è¿™ä¸‰ä¸ªæµç¨‹</strong>ï¼Œå…·ä½“æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ğŸ‘‰ View#requestLayoutï¼š</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestLayout</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">if</span> (mParent != <span class="literal">null</span> &amp;&amp; !mParent.isLayoutRequested()) &#123;</span><br><span class="line">        <span class="comment">// ğŸ‘‰ è°ƒç”¨çˆ¶å®¹å™¨çš„ `requestLayout` æ–¹æ³•</span></span><br><span class="line">        mParent.requestLayout();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ... </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­¤æ–¹æ³•ä¸­æœ€é‡è¦çš„æ˜¯è°ƒç”¨<code>mParent.requestLayout</code>æ–¹æ³•ï¼Œæ˜¯<strong>å‘çˆ¶å®¹å™¨è¯·æ±‚å¸ƒå±€</strong>ï¼Œå³è°ƒç”¨çˆ¶å®¹å™¨çš„ <code>requestLayout</code> æ–¹æ³•ï¼Œ<strong>æ­¤æ–¹æ³•æ²¿ç€Viewæ ‘å‘ä¸Šä¼ é€’ï¼Œæœ€ç»ˆæ¥åˆ°äº† DecorView#requestLayoutä¸­ï¼Œè€ŒDecorViewæ˜¯é¡¶å±‚Viewï¼Œå…¶mParentä¾¿æ˜¯ViewRootImplï¼Œæ‰€ä»¥å­Viewçš„requestLayoutæ–¹æ³•ï¼Œç»è¿‡å±‚å±‚ä¼ é€’ï¼Œæœ€ç»ˆä¼šè¢«ViewRootImpl æ¥æ”¶å¹¶å¤„ç†</strong>ã€‚</p>
<p>DecorViewæ˜¯æ€ä¹ˆæ·»åŠ åˆ°çª—å£çš„å‘¢ï¼ŸçœŸæ­£çš„å…¥å£æ˜¯åœ¨handleActivityResume æ—¶ï¼Œå°†DecorViewå’Œ Activityå»ºç«‹è”ç³»</p>
<img src="/pics/image-20210620214953160.png" alt="image-20210620214953160" style="zoom:50%;" />

<p>ç»è¿‡å±‚å±‚è°ƒç”¨ï¼ŒDecorViewçš„ç»˜åˆ¶ä¼šè¿›å…¥åˆ°ViewRootImplç±»ä¸­çš„performTraversals()æˆå‘˜æ–¹æ³•ï¼Œè¿™ä¸ªè¿‡ç¨‹å¯ä»¥å‚è€ƒä¸Šé¢çš„ä»£ç æµç¨‹å›¾ã€‚ç°åœ¨æˆ‘ä»¬ä¸»è¦æ¥åˆ†æä¸‹ ViewRootImplç±»ä¸­çš„performTraversalsæ–¹æ³•ã€‚</p>
<h1 id="äºŒã€view-çš„ç»˜åˆ¶å’Œæ¸²æŸ“è¿‡ç¨‹"><a href="#äºŒã€view-çš„ç»˜åˆ¶å’Œæ¸²æŸ“è¿‡ç¨‹" class="headerlink" title="äºŒã€view çš„ç»˜åˆ¶å’Œæ¸²æŸ“è¿‡ç¨‹"></a>äºŒã€view çš„ç»˜åˆ¶å’Œæ¸²æŸ“è¿‡ç¨‹</h1><p><a target="_blank" rel="noopener" href="http://blog.csdn.net/feiduclear_up/article/details/46772477">ä»ViewRootImplç±»åˆ†æViewç»˜åˆ¶çš„æµç¨‹</a></p>
<img src="/pics/image-20210620221717118.png" alt="image-20210620221717118" style="zoom:40%;" />

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performTraversals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="comment">//æ‰§è¡Œæµ‹é‡æ“ä½œ</span></span><br><span class="line">  performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line"></span><br><span class="line"> 	<span class="comment">//æ‰§è¡Œå¸ƒå±€æ“ä½œ</span></span><br><span class="line">  performLayout(lp, desiredWindowWidth, desiredWindowHeight);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//æ‰§è¡Œç»˜åˆ¶æ“ä½œ</span></span><br><span class="line">	performDraw();</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-1ã€MeasureSpec"><a href="#2-1ã€MeasureSpec" class="headerlink" title="2.1ã€MeasureSpec"></a>2.1ã€MeasureSpec</h2><p>MeasureSpecè¡¨ç¤ºçš„æ˜¯ä¸€ä¸ª32ä½çš„æ•´å½¢å€¼ï¼Œ<code>å®ƒçš„é«˜2ä½è¡¨ç¤ºæµ‹é‡æ¨¡å¼SpecModeï¼Œä½30ä½è¡¨ç¤ºæŸç§æµ‹é‡æ¨¡å¼ä¸‹çš„è§„æ ¼å¤§å°SpecSize</code>ã€‚MeasureSpecæ˜¯Viewç±»çš„ä¸€ä¸ªé™æ€å†…éƒ¨ç±»ï¼Œç”¨æ¥è¯´æ˜åº”è¯¥å¦‚ä½•æµ‹é‡è¿™ä¸ªViewã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MODE_SHIFT = <span class="number">30</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MODE_MASK = <span class="number">0x3</span> &lt;&lt; MODE_SHIFT;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> UNSPECIFIED = <span class="number">0</span> &lt;&lt; MODE_SHIFT;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> EXACTLY = <span class="number">1</span> &lt;&lt; MODE_SHIFT;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> AT_MOST = <span class="number">2</span> &lt;&lt; MODE_SHIFT;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">makeMeasureSpec</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> mode)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sUseBrokenMakeMeasureSpec) &#123;</span><br><span class="line">        <span class="keyword">return</span> size + mode;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (size &amp; ï½MODE_MASK) | (mode &amp; MODE_MASK);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getMode</span><span class="params">(<span class="keyword">int</span> measureSpec)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (measureSpec &amp; MODE_MASK);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getSize</span><span class="params">(<span class="keyword">int</span> measureSpec)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (measureSpec &amp; ï½MODE_MASK);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>MeasureSpec</code>é€šè¿‡å°†<code>SpecMode</code>å’Œ<code>SpecSize</code>æ‰“åŒ…æˆä¸€ä¸ª<code>int</code>å€¼æ¥é¿å…è¿‡å¤šçš„å¯¹è±¡å†…å­˜åˆ†é…ï¼Œä¸ºäº†æ–¹ä¾¿æ“ä½œï¼Œå…¶æä¾›äº†æ‰“åŒ…å’Œè§£åŒ…æ–¹æ³•ã€‚</p>
<p><code>SpecMode</code>æœ‰ä¸‰ç±»ï¼Œæ¯ä¸€ç±»éƒ½è¡¨ç¤ºç‰¹æ®Šçš„å«ä¹‰ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<ul>
<li><p><strong>UNSPECIFIED</strong></p>
<p>çˆ¶å®¹å™¨ä¸å¯¹Viewæœ‰ä»»ä½•é™åˆ¶ï¼Œè¦å¤šå¤§ç»™å¤šå¤§ï¼Œè¿™ç§æƒ…å†µä¸€èˆ¬ç”¨äºç³»ç»Ÿå†…éƒ¨ï¼Œè¡¨ç¤ºä¸€ç§æµ‹é‡çš„çŠ¶æ€ã€‚</p>
</li>
<li><p><strong>EXACTLY</strong></p>
<p>çˆ¶å®¹å™¨å·²ç»æ£€æµ‹å‡ºViewæ‰€éœ€è¦çš„ç²¾ç¡®å¤§å°ï¼Œè¿™ä¸ªæ—¶å€™Viewçš„æœ€ç»ˆå¤§å°å°±æ˜¯SpecSizeæ‰€æŒ‡å®šçš„å€¼ã€‚å®ƒå¯¹åº”äºLayoutParamsä¸­çš„match_parentå’Œå…·ä½“çš„æ•°å€¼è¿™ä¸¤ç§æ¨¡å¼ã€‚</p>
</li>
<li><p><strong>AT_MOST</strong><br>çˆ¶å®¹å™¨æŒ‡å®šäº†ä¸€ä¸ªå¯ç”¨å¤§å°å³SpecSize, Viewçš„å¤§å°ä¸èƒ½å¤§äºè¿™ä¸ªå€¼ï¼Œå…·ä½“æ˜¯ä»€ä¹ˆå€¼è¦çœ‹ä¸åŒViewçš„å…·ä½“å®ç°ã€‚å®ƒå¯¹åº”äºLayoutParamsä¸­çš„wrap_contentã€‚</p>
</li>
</ul>
<h3 id="2-1-1ã€DecorView-çš„MeasureSpec"><a href="#2-1-1ã€DecorView-çš„MeasureSpec" class="headerlink" title="2.1.1ã€DecorView çš„MeasureSpec"></a>2.1.1ã€DecorView çš„MeasureSpec</h3><p>å¯¹äºDecorViewï¼Œå…¶MeasureSpecç”±<code>çª—å£çš„å°ºå¯¸å’Œå…¶è‡ªèº«çš„LayoutParams</code>æ¥å…±åŒç¡®å®šï¼›</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getRootMeasureSpec</span><span class="params">(<span class="keyword">int</span> windowSize, <span class="keyword">int</span> rootDimension)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> measureSpec;</span><br><span class="line">    <span class="keyword">switch</span> (rootDimension) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> ViewGroup.LayoutParams.MATCH_PARENT:</span><br><span class="line">        <span class="comment">// Window can&#x27;t resize. Force root view to be windowSize.</span></span><br><span class="line">        measureSpec = MeasureSpec.makeMeasureSpec(windowSize, MeasureSpec.EXACTLY);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ViewGroup.LayoutParams.WRAP_CONTENT:</span><br><span class="line">        <span class="comment">// Window can resize. Set max size for root view.</span></span><br><span class="line">        measureSpec = MeasureSpec.makeMeasureSpec(windowSize, MeasureSpec.AT_MOST);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="comment">// Window wants to be an exact size. Force root view to be that size.</span></span><br><span class="line">        measureSpec = MeasureSpec.makeMeasureSpec(rootDimension, MeasureSpec.EXACTLY);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> measureSpec;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šå¸¸æ¥è¯´ï¼ŒDecorViewæ ¹å¸ƒå±€å®½å’Œé«˜éƒ½æ˜¯MATCH_PARENTï¼Œå› æ­¤DecorViewæ ¹å¸ƒå±€çš„æµ‹é‡æ¨¡å¼å°±æ˜¯MeasureSpec.EXACTLYï¼Œæµ‹é‡å¤§å°ä¸€èˆ¬éƒ½æ˜¯æ•´ä¸ªå±å¹•å¤§å°ï¼Œæ‰€ä»¥ä¸€èˆ¬æˆ‘ä»¬çš„Activityçª—å£éƒ½æ˜¯å…¨å±çš„ã€‚</p>
<h3 id="2-1-2ã€æ™®é€šviewçš„MeasureSpec"><a href="#2-1-2ã€æ™®é€šviewçš„MeasureSpec" class="headerlink" title="2.1.2ã€æ™®é€šviewçš„MeasureSpec"></a>2.1.2ã€æ™®é€šviewçš„MeasureSpec</h3><p>å¯¹äºæ™®é€šViewï¼Œ<code>å…¶MeasureSpecç”±çˆ¶å®¹å™¨çš„MeasureSpecå’Œè‡ªèº«çš„LayoutParamsæ¥å…±åŒå†³å®š</code>ï¼ŒMeasureSpecä¸€æ—¦ç¡®å®šåï¼Œ<code>onMeasure</code>ä¸­å°±å¯ä»¥ç¡®å®šViewçš„æµ‹é‡å®½/é«˜ã€‚</p>
<p>å¯¹äºæ™®é€š<code>View</code>æ¥è¯´ï¼ŒViewçš„<code>measure</code>è¿‡ç¨‹ç”±<code>ViewGroup</code>ä¼ é€’è€Œæ¥ï¼ˆæ‰€æœ‰çš„<code>view</code>æ ¹å¸ƒå±€éƒ½æ˜¯<code>DecorView</code>ï¼Œè€Œ<code>DecorView</code>æœ¬èº«æ˜¯ä¸ª<code>FrameLayout</code>ï¼‰ï¼Œå…ˆçœ‹ä¸€ä¸‹<code>ViewGroup</code>çš„<code>measureChildWithMargins</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">measureChildWithMargins</span><span class="params">(View child,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">int</span> parentWidthMeasureSpec, <span class="keyword">int</span> widthUsed,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">int</span> parentHeightMeasureSpec, <span class="keyword">int</span> heightUsed)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams();</span><br><span class="line">		<span class="comment">// 1.æ ¹æ®çˆ¶view çš„Measure å’Œ å­view çš„LayoutParams ç¡®å®šå­viewçš„ MeasureSpec</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec,</span><br><span class="line">            mPaddingLeft + mPaddingRight + lp.leftMargin + lp.rightMargin</span><br><span class="line">                    + widthUsed, lp.width);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childHeightMeasureSpec = getChildMeasureSpec(parentHeightMeasureSpec,</span><br><span class="line">            mPaddingTop + mPaddingBottom + lp.topMargin + lp.bottomMargin</span><br><span class="line">                    + heightUsed, lp.height);</span><br><span class="line">		<span class="comment">// 2.æœ€ç»ˆè°ƒç”¨åˆ°å­view çš„ measureæ–¹æ³•</span></span><br><span class="line">    child.measure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>getChildMeasureSpec</strong></p>
<p>æ ¹æ®çˆ¶view çš„Measure å’Œ å­view çš„LayoutParams ç¡®å®šå­viewçš„ MeasureSpecã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getChildMeasureSpec</span><span class="params">(<span class="keyword">int</span> spec, <span class="keyword">int</span> padding, <span class="keyword">int</span> childDimension)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> specMode = MeasureSpec.getMode(spec);</span><br><span class="line">    <span class="keyword">int</span> specSize = MeasureSpec.getSize(spec);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> size = Math.max(<span class="number">0</span>, specSize - padding);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> resultSize = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> resultMode = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (specMode) &#123;</span><br><span class="line">    <span class="comment">// Parent has imposed an exact size on us</span></span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.EXACTLY:</span><br><span class="line">        <span class="keyword">if</span> (childDimension &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            resultSize = childDimension;</span><br><span class="line">            resultMode = MeasureSpec.EXACTLY;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line">            <span class="comment">// Child wants to be our size. So be it.</span></span><br><span class="line">            resultSize = size;</span><br><span class="line">            resultMode = MeasureSpec.EXACTLY;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">            <span class="comment">// Child wants to determine its own size. It can&#x27;t be</span></span><br><span class="line">            <span class="comment">// bigger than us.</span></span><br><span class="line">            resultSize = size;</span><br><span class="line">            resultMode = MeasureSpec.AT_MOST;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Parent has imposed a maximum size on us</span></span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.AT_MOST:</span><br><span class="line">        <span class="keyword">if</span> (childDimension &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Child wants a specific size... so be it</span></span><br><span class="line">            resultSize = childDimension;</span><br><span class="line">            resultMode = MeasureSpec.EXACTLY;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line">            <span class="comment">// Child wants to be our size, but our size is not fixed.</span></span><br><span class="line">            <span class="comment">// Constrain child to not be bigger than us.</span></span><br><span class="line">            resultSize = size;</span><br><span class="line">            resultMode = MeasureSpec.AT_MOST;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">            <span class="comment">// Child wants to determine its own size. It can&#x27;t be</span></span><br><span class="line">            <span class="comment">// bigger than us.</span></span><br><span class="line">            resultSize = size;</span><br><span class="line">            resultMode = MeasureSpec.AT_MOST;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Parent asked to see how big we want to be</span></span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.UNSPECIFIED:</span><br><span class="line">        <span class="keyword">if</span> (childDimension &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Child wants a specific size... let them have it</span></span><br><span class="line">            resultSize = childDimension;</span><br><span class="line">            resultMode = MeasureSpec.EXACTLY;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line">            <span class="comment">// Child wants to be our size... find out how big it should</span></span><br><span class="line">            <span class="comment">// be</span></span><br><span class="line">            resultSize = View.sUseZeroUnspecifiedMeasureSpec ? <span class="number">0</span> : size;</span><br><span class="line">            resultMode = MeasureSpec.UNSPECIFIED;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">            <span class="comment">// Child wants to determine its own size.... find out how</span></span><br><span class="line">            <span class="comment">// big it should be</span></span><br><span class="line">            resultSize = View.sUseZeroUnspecifiedMeasureSpec ? <span class="number">0</span> : size;</span><br><span class="line">            resultMode = MeasureSpec.UNSPECIFIED;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//noinspection ResourceType</span></span><br><span class="line">    <span class="keyword">return</span> MeasureSpec.makeMeasureSpec(resultSize, resultMode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ€»ç»“ä¸‹ï¼š</p>
<p>&lt;img src=â€â€/pics/image-20210626173859241.pngâ€ alt=â€image-20210626173859241â€ style=â€zoom:50%;â€ /&gt;</p>
<h2 id="2-2ã€measureæµç¨‹"><a href="#2-2ã€measureæµç¨‹" class="headerlink" title="2.2ã€measureæµç¨‹"></a>2.2ã€measureæµç¨‹</h2><img src="/pics/image-20210620224045177.png" alt="image-20210620224045177" style="zoom:50%;" />



<h3 id="2-2-1ã€View-çš„ç»˜åˆ¶æµç¨‹"><a href="#2-2-1ã€View-çš„ç»˜åˆ¶æµç¨‹" class="headerlink" title="2.2.1ã€View çš„ç»˜åˆ¶æµç¨‹"></a>2.2.1ã€View çš„ç»˜åˆ¶æµç¨‹</h3><p>Viewçš„measureè¿‡ç¨‹ç”±å…¶measureæ–¹æ³•æ¥å®Œæˆï¼Œmeasureæ–¹æ³•æ˜¯ä¸€ä¸ªfinalç±»å‹çš„æ–¹æ³•ï¼Œè¿™æ„å‘³ç€å­ç±»ä¸èƒ½é‡å†™æ­¤æ–¹æ³•ï¼Œåœ¨Viewçš„measureæ–¹æ³•ä¸­ä¼šå»è°ƒç”¨Viewçš„onMeasureæ–¹æ³•ï¼Œå› æ­¤åªéœ€è¦çœ‹onMeasureçš„å®ç°å³å¯ï¼ŒViewçš„onMeasureæ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">    setMeasuredDimension(getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec),</span><br><span class="line">            getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>getDefaultSize</strong></p>
<p>å¯ä»¥çœ‹å‡ºï¼ŒgetDefaultSizeè¿™ä¸ªæ–¹æ³•çš„é€»è¾‘å¾ˆç®€å•ï¼Œå¯¹äºæˆ‘ä»¬æ¥è¯´ï¼Œæˆ‘ä»¬åªéœ€è¦çœ‹AT_MOSTå’Œï¼EXACTLYè¿™ä¸¤ç§æƒ…å†µã€‚ç®€å•åœ°ç†è§£ï¼Œå…¶å®getDefaultSizeè¿”å›çš„å¤§å°å°±æ˜¯measureSpecä¸­çš„specSizeï¼Œè€Œè¿™ä¸ªspecSizeå°±æ˜¯Viewæµ‹é‡åçš„å¤§å°ï¼Œè¿™é‡Œå¤šæ¬¡æåˆ°æµ‹é‡åçš„å¤§å°ï¼Œæ˜¯å› ä¸ºViewæœ€ç»ˆçš„å¤§å°æ˜¯åœ¨layouté˜¶æ®µç¡®å®šçš„ï¼Œæ‰€ä»¥è¿™é‡Œå¿…é¡»è¦åŠ ä»¥åŒºåˆ†ï¼Œä½†æ˜¯å‡ ä¹æ‰€æœ‰æƒ…å†µä¸‹Viewçš„æµ‹é‡å¤§å°å’Œæœ€ç»ˆå¤§å°æ˜¯ç›¸ç­‰çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getDefaultSize</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> measureSpec)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> result = size;</span><br><span class="line">    <span class="keyword">int</span> specMode = MeasureSpec.getMode(measureSpec);</span><br><span class="line">    <span class="keyword">int</span> specSize = MeasureSpec.getSize(measureSpec);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (specMode) &#123;</span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.UNSPECIFIED:</span><br><span class="line">        result = size;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.AT_MOST:</span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.EXACTLY:</span><br><span class="line">        result = specSize;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>getSuggestedMinimumWidth</strong></p>
<p>getSuggestedMinimumWidthå’ŒgetSuggestedMinimumHeightçš„è¿”å›å€¼å°±æ˜¯Viewåœ¨UNSPECIFIEDæƒ…å†µä¸‹çš„æµ‹é‡å®½/é«˜ã€‚</p>
<ul>
<li>å¦‚æœViewæ²¡æœ‰è®¾ç½®èƒŒæ™¯ï¼Œé‚£ä¹ˆè¿”å›android:minWidthè¿™ä¸ªå±æ€§æ‰€æŒ‡å®šçš„å€¼ï¼Œè¿™ä¸ªå€¼å¯ä»¥ä¸º0ï¼›</li>
<li>å¦‚æœViewè®¾ç½®äº†èƒŒæ™¯ï¼Œåˆ™è¿”å›android:minWidthå’ŒèƒŒæ™¯çš„æœ€å°å®½åº¦è¿™ä¸¤è€…ä¸­çš„æœ€å¤§å€¼ï¼›</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getSuggestedMinimumWidth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (mBackground == <span class="keyword">null</span>) ? mMinWidth : max(mMinWidth, mBackground.getMinimumWidth());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>wrap_contentéœ€è¦å®šä¹‰é»˜è®¤å®½é«˜ï¼Ÿ</strong></p>
<p>ä»getDefaultSizeæ–¹æ³•çš„å®ç°æ¥çœ‹ï¼ŒViewçš„å®½/é«˜ç”±specSizeå†³å®šï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¾—å‡ºå¦‚ä¸‹ç»“è®ºï¼š<code>ç›´æ¥ç»§æ‰¿Viewçš„è‡ªå®šä¹‰æ§ä»¶éœ€è¦é‡å†™onMeasureæ–¹æ³•å¹¶è®¾ç½®wrap_contentæ—¶çš„è‡ªèº«å¤§å°ï¼Œå¦åˆ™åœ¨å¸ƒå±€ä¸­ä½¿ç”¨wrap_contentå°±ç›¸å½“äºä½¿ç”¨match_parentã€‚</code>ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p>å¦‚æœViewåœ¨å¸ƒå±€ä¸­ä½¿ç”¨wrap_contentï¼Œé‚£ä¹ˆå®ƒçš„specModeæ˜¯AT_MOSTæ¨¡å¼ï¼Œåœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œå®ƒçš„å®½/é«˜ç­‰äºspecSizeï¼›æŸ¥è¡¨4-1å¯çŸ¥ï¼Œæ­¤æ—¶specSizeå°±æ˜¯parentSizeï¼Œè€ŒparentSizeæ˜¯çˆ¶å®¹å™¨ä¸­ç›®å‰å¯ä»¥ä½¿ç”¨çš„å¤§å°ï¼Œä¹Ÿå°±æ˜¯çˆ¶å®¹å™¨å½“å‰å‰©ä½™çš„ç©ºé—´å¤§å°ã€‚</p>
<p>å¾ˆæ˜¾ç„¶ï¼ŒViewçš„å®½/é«˜å°±ç­‰äºçˆ¶å®¹å™¨å½“å‰å‰©ä½™çš„ç©ºé—´å¤§å°ï¼Œè¿™ç§æ•ˆæœå’Œåœ¨å¸ƒå±€ä¸­ä½¿ç”¨match_parentå®Œå…¨ä¸€è‡´ã€‚å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿä¹Ÿå¾ˆç®€å•ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">    <span class="keyword">int</span> widthSpecMode = MeasureSpec.getMode(widthMeasureSpec);</span><br><span class="line">    <span class="keyword">int</span> widthSpecSize = MeasureSpec.getSize(widthMeasureSpec);</span><br><span class="line">    <span class="keyword">int</span> heightSpecMode = MeasureSpec.getMode(heightMeasureSpec);</span><br><span class="line">    <span class="keyword">int</span> heightSpecSize = MeasureSpec.getSize(heightMeasureSpec);</span><br><span class="line">    <span class="keyword">if</span> (widthSpecMode == MeasureSpec.AT_MOST &amp;&amp; heightSpecMode ==</span><br><span class="line">    MeasureSpec.AT_MOST) &#123;</span><br><span class="line">        setMeasuredDimension(mWidth, mHeight);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (widthSpecMode == MeasureSpec.AT_MOST) &#123;</span><br><span class="line">        setMeasuredDimension(mWidth, heightSpecSize);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (heightSpecMode == MeasureSpec.AT_MOST) &#123;</span><br><span class="line">        setMeasuredDimension(widthSpecSize, mHeight);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œ<code>æˆ‘ä»¬åªéœ€è¦ç»™ViewæŒ‡å®šä¸€ä¸ªé»˜è®¤çš„å†…éƒ¨å®½/é«˜ï¼ˆmWidthå’ŒmHeightï¼‰</code>ï¼Œå¹¶åœ¨wrap_contentæ—¶è®¾ç½®æ­¤å®½/é«˜å³å¯ã€‚</p>
<p>å¯¹äºéwrap_contentæƒ…å½¢ï¼Œæˆ‘ä»¬æ²¿ç”¨ç³»ç»Ÿçš„æµ‹é‡å€¼å³å¯ï¼Œè‡³äºè¿™ä¸ªé»˜è®¤çš„å†…éƒ¨å®½/é«˜çš„å¤§å°å¦‚ä½•æŒ‡å®šï¼Œè¿™ä¸ªæ²¡æœ‰å›ºå®šçš„ä¾æ®ï¼Œæ ¹æ®éœ€è¦çµæ´»æŒ‡å®šå³å¯ã€‚å¦‚æœæŸ¥çœ‹TextViewã€ImageViewç­‰çš„æºç å°±å¯ä»¥çŸ¥é“ï¼Œé’ˆå¯¹wrap_contentæƒ…å½¢ï¼Œå®ƒä»¬çš„onMeasureæ–¹æ³•å‡åšäº†ç‰¹æ®Šå¤„ç†ï¼Œè¯»è€…å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹å®ƒä»¬çš„æºç ã€‚</p>
<h3 id="2-2-2ã€ViewGroupçš„ç»˜åˆ¶æµç¨‹"><a href="#2-2-2ã€ViewGroupçš„ç»˜åˆ¶æµç¨‹" class="headerlink" title="2.2.2ã€ViewGroupçš„ç»˜åˆ¶æµç¨‹"></a>2.2.2ã€ViewGroupçš„ç»˜åˆ¶æµç¨‹</h3><p>å¯¹äºViewGroupæ¥è¯´ï¼Œé™¤äº†å®Œæˆè‡ªå·±çš„measureè¿‡ç¨‹ä»¥å¤–ï¼Œè¿˜ä¼šéå†å»è°ƒç”¨æ‰€æœ‰å­å…ƒç´ çš„measureæ–¹æ³•ï¼Œå„ä¸ªå­å…ƒç´ å†é€’å½’å»æ‰§è¡Œè¿™ä¸ªè¿‡ç¨‹ã€‚å’ŒViewä¸åŒçš„æ˜¯ï¼ŒViewGroupæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒæ²¡æœ‰é‡å†™Viewçš„onMeasureæ–¹æ³•ï¼Œç”±å„ä¸ªå…·ä½“çš„ViewGroupæ¯”å¦‚ FrameLayoutå»å®ç°ï¼Œä½†æ˜¯å®ƒæä¾›äº†ä¸€ä¸ªå«measureChildrençš„æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">measureChildren</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> size = mChildrenCount;</span><br><span class="line">    <span class="keyword">final</span> View[] children = mChildren;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; ++i) &#123;</span><br><span class="line">        <span class="keyword">final</span> View child = children[i];</span><br><span class="line">        <span class="keyword">if</span> ((child.mViewFlags &amp; VISIBILITY_MASK) != GONE) &#123;</span><br><span class="line">            measureChild(child, widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>measureChild</strong></p>
<p>measureChildçš„æ€æƒ³å°±æ˜¯å–å‡ºå­å…ƒç´ çš„LayoutParamsï¼Œç„¶åå†é€šè¿‡getChildMeasureSpecæ¥åˆ›å»ºå­å…ƒç´ çš„MeasureSpecï¼Œæ¥ç€å°†MeasureSpecç›´æ¥ä¼ é€’ç»™Viewçš„measureæ–¹æ³•æ¥è¿›è¡Œæµ‹é‡ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">measureChild</span><span class="params">(View child, <span class="keyword">int</span> parentWidthMeasureSpec,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">int</span> parentHeightMeasureSpec)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> LayoutParams lp = child.getLayoutParams();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec,</span><br><span class="line">            mPaddingLeft + mPaddingRight, lp.width);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childHeightMeasureSpec = getChildMeasureSpec(parentHeightMeasureSpec,</span><br><span class="line">            mPaddingTop + mPaddingBottom, lp.height);</span><br><span class="line"></span><br><span class="line">    child.measure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ä¸ºä»€ä¹ˆViewGroupä¸åƒViewä¸€æ ·å¯¹å…¶onMeasureæ–¹æ³•åšç»Ÿä¸€çš„å®ç°å‘¢ï¼Ÿ</strong></p>
<p>å› ä¸ºä¸åŒçš„ViewGroupå­ç±»æœ‰ä¸åŒçš„å¸ƒå±€ç‰¹æ€§ï¼Œè¿™å¯¼è‡´å®ƒä»¬çš„æµ‹é‡ç»†èŠ‚å„ä¸ç›¸åŒï¼Œæ¯”å¦‚LinearLayoutå’ŒRelativeLayoutè¿™ä¸¤è€…çš„å¸ƒå±€ç‰¹æ€§æ˜¾ç„¶ä¸åŒï¼Œå› æ­¤ViewGroupæ— æ³•åšç»Ÿä¸€å®ç°</p>
<h3 id="2-2-3ã€view-å®½é«˜è·å–"><a href="#2-2-3ã€view-å®½é«˜è·å–" class="headerlink" title="2.2.3ã€view å®½é«˜è·å–?"></a>2.2.3ã€view å®½é«˜è·å–?</h3><p>Activityç”Ÿå‘½å‘¨æœŸ<code>onCreateå’ŒonStart()ï¼ŒonResume</code>æ–¹æ³•ä¸­è°ƒç”¨<code>View.getWidth()</code>å’Œ<code>View.getMeasuredHeight()</code>è¿”å›å€¼ä¸º0 ?</p>
<p>&lt;img src=â€â€/pics/image-20210626162038865.pngâ€ alt=â€image-20210626162038865â€ style=â€zoom:50%;â€ /&gt;</p>
<p>ä»ä¸Šé¢çš„ä»£ç ç‰‡æ®µæ‰§è¡Œé¡ºåºæ¥çœ‹ï¼ŒActivityçš„onStartå’ŒonResumeè¢«æ‰§è¡Œçš„æ—¶å€™ï¼Œå…¶å®ç•Œé¢è¿˜æ²¡æœ‰å¼€å§‹è¿›è¡Œç»˜åˆ¶ï¼ˆwm.addView(decor, l)è¿˜æ²¡æ‰§è¡Œåˆ°ï¼‰ï¼Œè¿™é‡Œå°±å¯ä»¥è§£é‡Šä¸ºä»€ä¹ˆç”¨Handler.poståœ¨onCreateé‡Œæ‹¿ä¸åˆ°å®½é«˜ã€‚å› ä¸ºHandleræœºåˆ¶ï¼ŒActivityç”Ÿå‘½å‘¨æœŸonCreate å’Œ onResumeçš„éƒ½æ˜¯é€šè¿‡ä¸»çº¿ç¨‹handler çš„å›è°ƒã€‚è€Œview çš„ç»˜åˆ¶æµç¨‹ä¹Ÿæ˜¯é€šè¿‡å‘ä¸»çº¿ç¨‹å‘é€æ¶ˆæ¯çš„æ–¹å¼æ‰§è¡Œçš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TraversalRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        doTraversal();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> ä¹Ÿå°±æ˜¯è¯´å¯åŠ¨æ—¶ï¼Œä¸»çº¿ç¨‹é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯æ‰§è¡Œé¡ºåº ä¸º onCreate -&gt; handleResumeActivityï¼ˆonResumeï¼‰ -&gt; </p>
<p>doTraversal ã€‚è‡ªç„¶è€Œç„¶ï¼Œviewéƒ½æ²¡æœ‰ç»˜åˆ¶å®Œçš„æƒ…å†µä¸‹æ˜¯ä¸å¯èƒ½è·å–åˆ°å®½é«˜çš„ã€‚</p>
<p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p>
<ol>
<li><p>view.post </p>
<p>æœ¬è´¨ä¸Šä¹Ÿæ˜¯åŸºäºhandlerçš„æ¶ˆæ¯æœºåˆ¶ï¼Œæ¯”å¦‚æˆ‘ä»¬åœ¨onCreate ä¸­æ‰§è¡Œ post</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// ä½ç½®1</span></span><br><span class="line">    Log.i(<span class="string">&quot;view_w_&amp;_h&quot;</span>, <span class="string">&quot;onCreate &quot;</span> + mView.getWidth() + <span class="string">&quot; &quot;</span> + mView.getHeight());</span><br><span class="line">    mView.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ä½ç½®2</span></span><br><span class="line">            Log.i(<span class="string">&quot;view_w_&amp;_h&quot;</span>, <span class="string">&quot;onCreate postRun &quot;</span> + mView.getWidth() + <span class="string">&quot; &quot;</span> + mView.getHeight());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>æœ€ç»ˆè¿™ä¸ªrunnable ä»»åŠ¡ä¼šåœ¨ <code>performTraversals</code> å®Œæˆåè¢«è°ƒç”¨ï¼Œ<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/71OV_K7YJas7pLtsPY-jeQ">è¯¦è§</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">private void performTraversals() &#123;</span><br><span class="line">    ...</span><br><span class="line">    // è¿™é‡Œå†æ¬¡æ·»åŠ åˆ°æ¶ˆæ¯ä¸­</span><br><span class="line">    host.dispatchAttachedToWindow(mAttachInfo, 0);</span><br><span class="line">    ...</span><br><span class="line">    performMeasure();</span><br><span class="line">    ...</span><br><span class="line">    performLayout();</span><br><span class="line">    ...</span><br><span class="line">    performDraw();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>ViewTreeObserver</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">view.getViewTreeObserver().addOnGlobalLayoutListener(new ViewTreeObserver.OnGlobalLayoutListener() &#123;  </span><br><span class="line">        @Override  </span><br><span class="line">        public void onGlobalLayout() &#123;  </span><br><span class="line">            mScrollView.post(new Runnable() &#123;  </span><br><span class="line">                public void run() &#123;  </span><br><span class="line">                    view.getHeight(); </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;);  </span><br><span class="line">        &#125;  </span><br><span class="line">&#125;); </span><br></pre></td></tr></table></figure></li>
<li><p>é‡å†™Activityçš„onWindowFocusChanged()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onWindowFocusChanged</span><span class="params">(<span class="keyword">boolean</span> hasFocus)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">super</span>.onWindowFocusChanged(hasFocus);  </span><br><span class="line">		<span class="keyword">if</span> (hasFocus) &#123;</span><br><span class="line">				getHeight();</span><br><span class="line">		&#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="2-3ã€Layoutæµç¨‹"><a href="#2-3ã€Layoutæµç¨‹" class="headerlink" title="2.3ã€Layoutæµç¨‹"></a>2.3ã€Layoutæµç¨‹</h2><img src="/pics/image-20210620224422346.png" alt="image-20210620224422346" style="zoom:50%;" />



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">layout</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">     <span class="comment">//åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°æµ‹é‡</span></span><br><span class="line">     <span class="keyword">if</span> ((mPrivateFlags3 &amp; PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT) != <span class="number">0</span>) &#123;</span><br><span class="line">         onMeasure(mOldWidthMeasureSpec, mOldHeightMeasureSpec);</span><br><span class="line">         mPrivateFlags3 &amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">//ä¿å­˜ä¸Šä¸€æ¬¡Viewçš„å››ä¸ªä½ç½®</span></span><br><span class="line">     <span class="keyword">int</span> oldL = mLeft;</span><br><span class="line">     <span class="keyword">int</span> oldT = mTop;</span><br><span class="line">     <span class="keyword">int</span> oldB = mBottom;</span><br><span class="line">     <span class="keyword">int</span> oldR = mRight;</span><br><span class="line">     <span class="comment">//è®¾ç½®å½“å‰è§†å›¾Viewçš„å·¦ï¼Œé¡¶ï¼Œå³ï¼Œåº•çš„ä½ç½®ï¼Œå¹¶ä¸”åˆ¤æ–­å¸ƒå±€æ˜¯å¦æœ‰æ”¹å˜</span></span><br><span class="line">     <span class="keyword">boolean</span> changed = isLayoutModeOptical(mParent) ?</span><br><span class="line">             setOpticalFrame(l, t, r, b) : setFrame(l, t, r, b);</span><br><span class="line">     <span class="comment">//å¦‚æœå¸ƒå±€æœ‰æ”¹å˜ï¼Œæ¡ä»¶æˆç«‹ï¼Œåˆ™è§†å›¾Viewé‡æ–°å¸ƒå±€</span></span><br><span class="line">         <span class="keyword">if</span> (changed || (mPrivateFlags &amp; PFLAG_LAYOUT_REQUIRED) == PFLAG_LAYOUT_REQUIRED) &#123;</span><br><span class="line">         <span class="comment">//è°ƒç”¨onLayoutï¼Œå°†å…·ä½“å¸ƒå±€é€»è¾‘ç•™ç»™å­ç±»å®ç°</span></span><br><span class="line">         onLayout(changed, l, t, r, b);</span><br><span class="line">         mPrivateFlags &amp;= ~PFLAG_LAYOUT_REQUIRED;</span><br><span class="line"></span><br><span class="line">         ListenerInfo li = mListenerInfo;</span><br><span class="line">         <span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnLayoutChangeListeners != <span class="keyword">null</span>) &#123;</span><br><span class="line">             ArrayList&lt;OnLayoutChangeListener&gt; listenersCopy =</span><br><span class="line">                     (ArrayList&lt;OnLayoutChangeListener&gt;)li.mOnLayoutChangeListeners.clone();</span><br><span class="line">             <span class="keyword">int</span> numListeners = listenersCopy.size();</span><br><span class="line">             <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numListeners; ++i) &#123;</span><br><span class="line">                 listenersCopy.get(i).onLayoutChange(<span class="keyword">this</span>, l, t, r, b, oldL, oldT, oldR, oldB);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     mPrivateFlags &amp;= ~PFLAG_FORCE_LAYOUT;</span><br><span class="line">     mPrivateFlags3 |= PFLAG3_IS_LAID_OUT;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-1ã€setFrame"><a href="#2-3-1ã€setFrame" class="headerlink" title="2.3.1ã€setFrame"></a>2.3.1ã€<strong>setFrame</strong></h3><p>layout ä¸­è°ƒç”¨<code>setFrame</code>ç¡®å®šå½“å‰Viewçš„å¸ƒå±€ä½ç½®ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">setFrame</span><span class="params">(<span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">//å½“ä¸Šï¼Œä¸‹ï¼Œå·¦ï¼Œå³å››ä¸ªä½ç½®æœ‰ä¸€ä¸ªå’Œä¸Šæ¬¡çš„å€¼ä¸ä¸€æ ·éƒ½ä¼šé‡æ–°å¸ƒå±€</span></span><br><span class="line">        <span class="keyword">if</span> (mLeft != left || mRight != right || mTop != top || mBottom != bottom) &#123;</span><br><span class="line">            changed = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">// Remember our drawn bit</span></span><br><span class="line">        <span class="keyword">int</span> drawn = mPrivateFlags &amp; PFLAG_DRAWN;</span><br><span class="line">        <span class="comment">//å¾—åˆ°æœ¬æ¬¡å’Œä¸Šæ¬¡çš„å®½å’Œé«˜</span></span><br><span class="line">        <span class="keyword">int</span> oldWidth = mRight - mLeft;</span><br><span class="line">        <span class="keyword">int</span> oldHeight = mBottom - mTop;</span><br><span class="line">        <span class="keyword">int</span> newWidth = right - left;</span><br><span class="line">        <span class="keyword">int</span> newHeight = bottom - top;</span><br><span class="line">        <span class="comment">//åˆ¤æ–­æœ¬æ¬¡Viewçš„å®½é«˜å’Œä¸Šæ¬¡Viewçš„å®½é«˜æ˜¯å¦ç›¸ç­‰</span></span><br><span class="line">        <span class="keyword">boolean</span> sizeChanged = (newWidth != oldWidth) || (newHeight != oldHeight);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Invalidate our old position</span></span><br><span class="line">        <span class="comment">//æ¸…æ¥šä¸Šæ¬¡å¸ƒå±€çš„ä½ç½®</span></span><br><span class="line">        invalidate(sizeChanged);</span><br><span class="line">        <span class="comment">//ä¿å­˜å½“å‰Viewçš„æœ€æ–°ä½ç½®</span></span><br><span class="line">        mLeft = left;</span><br><span class="line">        mTop = top;</span><br><span class="line">        mRight = right;</span><br><span class="line">        mBottom = bottom;</span><br><span class="line">        mRenderNode.setLeftTopRightBottom(mLeft, mTop, mRight, mBottom);</span><br><span class="line"></span><br><span class="line">        mPrivateFlags |= PFLAG_HAS_BOUNDS;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å¦‚æœå½“å‰Viewçš„å°ºå¯¸æœ‰æ‰€å˜åŒ–</span></span><br><span class="line">        <span class="keyword">if</span> (sizeChanged) &#123;</span><br><span class="line">            sizeChange(newWidth, newHeight, oldWidth, oldHeight);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ...............</span><br><span class="line">    <span class="keyword">return</span> changed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-2ã€onLayout"><a href="#2-3-2ã€onLayout" class="headerlink" title="2.3.2ã€onLayout"></a>2.3.2ã€onLayout</h3><p>å¯¹äº<code>View</code>æ¥è¯´ï¼Œç»è¿‡<code>setFrame</code>ï¼Œ<code>view</code>çš„ä½ç½®å°±å·²ç»ç¡®å®šäº†ï¼Œ<code>onLayout</code>æ˜¯ä¸€ä¸ªç©ºæ–¹æ³•ã€‚</p>
<p>å¯¹äº<code>ViewGroup</code>æ¥è¯´ï¼Œä½ç½®é€šè¿‡<code>setFrame</code>å·²ç»å®ç°ï¼Œ<code>onLayout</code>æ˜¯ä¸ªæŠ½è±¡çš„æ–¹æ³•ï¼Œæ‰€æœ‰ç»§æ‰¿è‡ª<code>ViewGroup</code>çš„å¯¹è±¡éƒ½å¿…é¡»å®ç°ï¼Œç¡®å®šå­<code>view</code>çš„ä½ç½®ã€‚ä»¥<code>FrameLayout</code> ä¸ºä¾‹ï¼ŒçœŸæ­£çš„å®ç°åœ¨ä¸­<code>layoutChildren</code>ã€‚</p>
<p>ä¸åƒ<code>View</code>è§†å›¾çš„<code>measure</code>æµ‹é‡ï¼Œé€šè¿‡å­ç±»å®ç°<code>onMeasure</code>æ–¹æ³•æ¥å®ç°æµ‹é‡é€»è¾‘ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</span><br><span class="line">    layoutChildren(left, top, right, bottom, <span class="keyword">false</span> <span class="comment">/* no force left gravity */</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">layoutChildren</span><span class="params">(<span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom, <span class="keyword">boolean</span> forceLeftGravity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> count = getChildCount();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> parentLeft = getPaddingLeftWithForeground();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> parentRight = right - left - getPaddingRightWithForeground();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> parentTop = getPaddingTopWithForeground();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> parentBottom = bottom - top - getPaddingBottomWithForeground();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> View child = getChildAt(i);</span><br><span class="line">        <span class="keyword">if</span> (child.getVisibility() != GONE) &#123;</span><br><span class="line">            <span class="keyword">final</span> LayoutParams lp = (LayoutParams) child.getLayoutParams();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> width = child.getMeasuredWidth();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> height = child.getMeasuredHeight();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> childLeft;</span><br><span class="line">            <span class="keyword">int</span> childTop;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> gravity = lp.gravity;</span><br><span class="line">            <span class="keyword">if</span> (gravity == -<span class="number">1</span>) &#123;</span><br><span class="line">                gravity = DEFAULT_CHILD_GRAVITY;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> layoutDirection = getLayoutDirection();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> absoluteGravity = Gravity.getAbsoluteGravity(gravity, layoutDirection);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> verticalGravity = gravity &amp; Gravity.VERTICAL_GRAVITY_MASK;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">switch</span> (absoluteGravity &amp; Gravity.HORIZONTAL_GRAVITY_MASK) &#123;</span><br><span class="line">                <span class="keyword">case</span> Gravity.CENTER_HORIZONTAL:</span><br><span class="line">                    childLeft = parentLeft + (parentRight - parentLeft - width) / <span class="number">2</span> +</span><br><span class="line">                    lp.leftMargin - lp.rightMargin;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> Gravity.RIGHT:</span><br><span class="line">                    <span class="keyword">if</span> (!forceLeftGravity) &#123;</span><br><span class="line">                        childLeft = parentRight - width - lp.rightMargin;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                <span class="keyword">case</span> Gravity.LEFT:</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    childLeft = parentLeft + lp.leftMargin;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">switch</span> (verticalGravity) &#123;</span><br><span class="line">                <span class="keyword">case</span> Gravity.TOP:</span><br><span class="line">                    childTop = parentTop + lp.topMargin;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> Gravity.CENTER_VERTICAL:</span><br><span class="line">                    childTop = parentTop + (parentBottom - parentTop - height) / <span class="number">2</span> +</span><br><span class="line">                    lp.topMargin - lp.bottomMargin;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> Gravity.BOTTOM:</span><br><span class="line">                    childTop = parentBottom - height - lp.bottomMargin;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    childTop = parentTop + lp.topMargin;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            child.layout(childLeft, childTop, childLeft + width, childTop + height);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-4ã€drawæµç¨‹"><a href="#2-4ã€drawæµç¨‹" class="headerlink" title="2.4ã€drawæµç¨‹"></a>2.4ã€drawæµç¨‹</h2><p>Viewè§†å›¾ç»˜åˆ¶æµç¨‹ä¸­çš„æœ€åä¸€æ­¥ç»˜åˆ¶drawæ˜¯ç”±ViewRootImplä¸­çš„performDrawæˆå‘˜æ–¹æ³•å¼€å§‹çš„ï¼Œè·Ÿè¸ªä»£ç ï¼Œæœ€åä¼šåœ¨<code>ViewRootImpl.drawSoftware</code>æ–¹æ³•ç»˜åˆ¶Viewï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">drawSoftware</span><span class="params">(Surface surface, AttachInfo attachInfo, <span class="keyword">int</span> xoff, <span class="keyword">int</span> yoff,</span></span></span><br><span class="line"><span class="params"><span class="function">          <span class="keyword">boolean</span> scalingRequired, Rect dirty)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Draw with software renderer.</span></span><br><span class="line">      <span class="keyword">final</span> Canvas canvas;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">//ä»surfaceå¯¹è±¡ä¸­è·å¾—canvaså˜é‡</span></span><br><span class="line">          canvas = mSurface.lockCanvas(dirty);</span><br><span class="line"></span><br><span class="line">          <span class="comment">// If this bitmap&#x27;s format includes an alpha channel, we</span></span><br><span class="line">          <span class="comment">// need to clear it before drawing so that the child will</span></span><br><span class="line">          <span class="comment">// properly re-composite its drawing on a transparent</span></span><br><span class="line">          <span class="comment">// background. This automatically respects the clip/dirty region</span></span><br><span class="line">          <span class="comment">// or</span></span><br><span class="line">          <span class="comment">// If we are applying an offset, we need to clear the area</span></span><br><span class="line">          <span class="comment">// where the offset doesn&#x27;t appear to avoid having garbage</span></span><br><span class="line">          <span class="comment">// left in the blank areas.</span></span><br><span class="line">          <span class="keyword">if</span> (!canvas.isOpaque() || yoff != <span class="number">0</span> || xoff != <span class="number">0</span>) &#123;</span><br><span class="line">              canvas.drawColor(<span class="number">0</span>, PorterDuff.Mode.CLEAR);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">         ......................</span><br><span class="line"></span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="comment">//è°ƒæ•´ç”»å¸ƒçš„ä½ç½®</span></span><br><span class="line">              canvas.translate(-xoff, -yoff);</span><br><span class="line">              <span class="keyword">if</span> (mTranslator != <span class="keyword">null</span>) &#123;</span><br><span class="line">                  mTranslator.translateCanvas(canvas);</span><br><span class="line">              &#125;</span><br><span class="line">              canvas.setScreenDensity(scalingRequired ? mNoncompatDensity : <span class="number">0</span>);</span><br><span class="line">              attachInfo.mSetIgnoreDirtyState = <span class="keyword">false</span>;</span><br><span class="line">              <span class="comment">//è°ƒç”¨Viewç±»ä¸­çš„æˆå‘˜æ–¹æ³•drawå¼€å§‹ç»˜åˆ¶Viewè§†å›¾</span></span><br><span class="line">              mView.draw(canvas);</span><br><span class="line">          &#125; </span><br><span class="line"></span><br><span class="line">      .....................</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>å¯çŸ¥ï¼Œæˆ‘ä»¬çš„è§†å›¾Viewæœ€ç»ˆæ˜¯ç»˜åˆ¶åˆ°Surfaceä¸­å»çš„ï¼Œå…³äºSurfaceç›¸å…³çš„çŸ¥è¯†ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡å¤§ç¥çš„åšå®¢ï¼š</p>
<p><a target="_blank" rel="noopener" href="http://blog.csdn.net/luoshengyang/article/details/8303098">Androidåº”ç”¨ç¨‹åºçª—å£ï¼ˆActivityï¼‰çš„ç»˜å›¾è¡¨é¢ï¼ˆSurfaceï¼‰çš„åˆ›å»ºè¿‡ç¨‹åˆ†æ</a></p>
<p>è·Ÿè¸ªä»£ç ï¼Œè¿›å…¥Viewçš„drawæ–¹æ³•åˆ†ææºç ï¼š</p>
<h3 id="2-4-1ã€Draw"><a href="#2-4-1ã€Draw" class="headerlink" title="2.4.1ã€Draw"></a>2.4.1ã€Draw</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">public void draw(Canvas canvas) &#123;</span><br><span class="line">      final int privateFlags = mPrivateFlags;</span><br><span class="line">      final boolean dirtyOpaque = (privateFlags &amp; PFLAG_DIRTY_MASK) ==</span><br><span class="line">      PFLAG_DIRTY_OPAQUE &amp;&amp;</span><br><span class="line">              (mAttachInfo == null || ! mAttachInfo.mIgnoreDirtyState);</span><br><span class="line">      mPrivateFlags = (privateFlags &amp; ï½PFLAG_DIRTY_MASK) | PFLAG_DRAWN;</span><br><span class="line"></span><br><span class="line">      /ï¼Š</span><br><span class="line">      ï¼Š Draw traversal performs several drawing steps which must be executed</span><br><span class="line">      ï¼Š in the appropriate order:</span><br><span class="line">      ï¼Š in the appropriate order:</span><br><span class="line">    ï¼Š</span><br><span class="line">    ï¼Š       1. Draw the background</span><br><span class="line">    ï¼Š       2. If necessary, save the canvas&#x27; layers to prepare for fading</span><br><span class="line">    ï¼Š       3. Draw view&#x27;s content</span><br><span class="line">    ï¼Š       4. Draw children</span><br><span class="line">    ï¼Š       5. If necessary, draw the fading edges and restore layers</span><br><span class="line">    ï¼Š       6. Draw decorations (scrollbars for instance)</span><br><span class="line">    ï¼Š/</span><br><span class="line"></span><br><span class="line">   // Step 1, draw the background, if needed</span><br><span class="line">   int saveCount;</span><br><span class="line"></span><br><span class="line">   if (! dirtyOpaque) &#123;</span><br><span class="line">        drawBackground(canvas);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   // skip step 2 &amp; 5 if possible (common case)</span><br><span class="line">   final int viewFlags = mViewFlags;</span><br><span class="line">   boolean horizontalEdges = (viewFlags &amp; FADING_EDGE_HORIZONTAL) ! = 0;</span><br><span class="line">   boolean verticalEdges = (viewFlags &amp; FADING_EDGE_VERTICAL) ! = 0;</span><br><span class="line">   if (! verticalEdges &amp;&amp; ! horizontalEdges) &#123;</span><br><span class="line">        // Step 3, draw the content</span><br><span class="line">        if (! dirtyOpaque) onDraw(canvas);</span><br><span class="line"></span><br><span class="line">        // Step 4, draw the children</span><br><span class="line">        dispatchDraw(canvas);</span><br><span class="line"></span><br><span class="line">        // Step 6, draw decorations (scrollbars)</span><br><span class="line">        onDrawScrollBars(canvas);</span><br><span class="line"></span><br><span class="line">        if (mOverlay ! = null &amp;&amp; ! mOverlay.isEmpty()) &#123;</span><br><span class="line">            mOverlay.getOverlayView().dispatchDraw(canvas);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // we&#x27;re done...</span><br><span class="line">        return;</span><br><span class="line">   &#125;</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ€»ç»“ä¸€ä¸‹ï¼š</p>
<ol>
<li>ç»˜åˆ¶å½“å‰è§†å›¾çš„èƒŒæ™¯ã€‚</li>
<li>ä¿å­˜canvasçš„å›¾å±‚ï¼Œä¸ºfadingåšå‡†å¤‡</li>
<li>ç»˜åˆ¶Viewçš„å†…å®¹</li>
<li>ç»˜åˆ¶Viewçš„å­View</li>
<li>ç»˜åˆ¶å½“å‰è§†å›¾åœ¨æ»‘åŠ¨æ—¶çš„è¾¹æ¡†æ¸å˜æ•ˆæœã€‚</li>
<li>ç»˜åˆ¶Viewçš„è£…é¥°(ä¾‹å¦‚æ»šåŠ¨æ¡ç­‰ç­‰)</li>
</ol>
<img src="/pics/image-20210620231436212.png" alt="image-20210620231436212" style="zoom:50%;" />



<h3 id="2-4-2ã€View-çš„æ ‘å½¢ç»“æ„ç»˜åˆ¶æµç¨‹"><a href="#2-4-2ã€View-çš„æ ‘å½¢ç»“æ„ç»˜åˆ¶æµç¨‹" class="headerlink" title="2.4.2ã€View çš„æ ‘å½¢ç»“æ„ç»˜åˆ¶æµç¨‹"></a>2.4.2ã€View çš„æ ‘å½¢ç»“æ„ç»˜åˆ¶æµç¨‹</h3><p>Viewç»˜åˆ¶è¿‡ç¨‹çš„ä¼ é€’æ˜¯é€šè¿‡dispatchDrawæ¥å®ç°çš„ï¼ŒdispatchDrawä¼šéå†è°ƒç”¨æ‰€æœ‰å­å…ƒç´ çš„drawæ–¹æ³•ï¼Œå¦‚æ­¤drawäº‹ä»¶å°±ä¸€å±‚å±‚åœ°ä¼ é€’äº†ä¸‹å»ã€‚Viewæœ‰ä¸€ä¸ªç‰¹æ®Šçš„æ–¹æ³•setWillNotDrawï¼Œå…ˆçœ‹ä¸€ä¸‹å®ƒçš„æºç ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/ï¼Šï¼Š</span><br><span class="line"> ï¼Š If <span class="keyword">this</span> view doesn<span class="string">&#x27;t do any drawing on its own, set this flag to</span></span><br><span class="line"><span class="string"> ï¼Š allow further optimizations. By default, this flag is not set on</span></span><br><span class="line"><span class="string"> ï¼Š View, but could be set on some View subclasses such as ViewGroup.</span></span><br><span class="line"><span class="string"> ï¼Š</span></span><br><span class="line"><span class="string"> ï¼Š Typically, if you override &#123;@link #onDraw(android.graphics.Canvas)&#125;</span></span><br><span class="line"><span class="string"> ï¼Š you should clear this flag.</span></span><br><span class="line"><span class="string"> ï¼Š</span></span><br><span class="line"><span class="string"> ï¼Š @param willNotDraw whether or not this View draw on its own</span></span><br><span class="line"><span class="string"> ï¼Š/</span></span><br><span class="line"><span class="string">public void setWillNotDraw(boolean willNotDraw) &#123;</span></span><br><span class="line"><span class="string">    setFlags(willNotDraw ? WILL_NOT_DRAW : 0, DRAW_MASK);</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<p>ä»setWillNotDrawè¿™ä¸ªæ–¹æ³•çš„æ³¨é‡Šä¸­å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœä¸€ä¸ªViewä¸éœ€è¦ç»˜åˆ¶ä»»ä½•å†…å®¹ï¼Œé‚£ä¹ˆè®¾ç½®è¿™ä¸ªæ ‡è®°ä½ä¸ºtrueä»¥åï¼Œç³»ç»Ÿä¼šè¿›è¡Œç›¸åº”çš„ä¼˜åŒ–ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒViewæ²¡æœ‰å¯ç”¨è¿™ä¸ªä¼˜åŒ–æ ‡è®°ä½ï¼Œä½†æ˜¯ViewGroupä¼šé»˜è®¤å¯ç”¨è¿™ä¸ªä¼˜åŒ–æ ‡è®°ä½ã€‚</p>
<p>è¿™ä¸ªæ ‡è®°ä½å¯¹å®é™…å¼€å‘çš„æ„ä¹‰æ˜¯ï¼š<code>å½“æˆ‘ä»¬çš„è‡ªå®šä¹‰æ§ä»¶ç»§æ‰¿äºViewGroupå¹¶ä¸”æœ¬èº«ä¸å…·å¤‡ç»˜åˆ¶åŠŸèƒ½æ—¶ï¼Œå°±å¯ä»¥å¼€å¯è¿™ä¸ªæ ‡è®°ä½ä»è€Œä¾¿äºç³»ç»Ÿè¿›è¡Œåç»­çš„ä¼˜åŒ–ã€‚</code>å½“ç„¶ï¼Œå½“æ˜ç¡®çŸ¥é“ä¸€ä¸ªViewGroupéœ€è¦é€šè¿‡onDrawæ¥ç»˜åˆ¶å†…å®¹æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ˜¾å¼åœ°å…³é—­WILL_NOT_DRAWè¿™ä¸ªæ ‡è®°ä½ã€‚</p>
<img src="/pics/image-20210620232417701.png" alt="image-20210620232417701" style="zoom:50%;" />

<h1 id="ä¸‰ã€æ€»ç»“"><a href="#ä¸‰ã€æ€»ç»“" class="headerlink" title="ä¸‰ã€æ€»ç»“"></a>ä¸‰ã€æ€»ç»“</h1><ol>
<li><p><code>ActivityThread#performLaunchActivity</code> å¯åŠ¨è¿‡ç¨‹ä¸­</p>
<ol>
<li><code>Activity#attch</code>æµç¨‹ï¼Œåˆ›å»º<code>PhoneWindow</code></li>
<li><code>Activity#onCreate#setContentView</code>ï¼Œå…ˆåˆ›å»º<code>DecorView</code>ï¼Œå°†<code>DecorView</code>å’Œ<code>PhoneWindow</code>è¿›è¡Œå…³è”ï¼›å¹¶ä¸”å°†<code>activity</code>çš„å¸ƒå±€æ–‡ä»¶æ·»åŠ åˆ° <code>DecorView#content</code>ä¸­</li>
</ol>
</li>
<li><p><code>ActivityThread#handleResumeActivity</code>æµç¨‹ä¸­</p>
<ol>
<li>é€šè¿‡<code>WindowManagerImpl#addView</code>åˆ›å»º<code>ViewRootImpl</code></li>
<li>å°†<code>ViewRootImpl</code>ä¸<code>DecorView</code>è¿›è¡Œå…³è”ï¼Œå¹¶é€šè¿‡<code>ViewRootImpl#setView</code>å¯¹<code>view</code>è¿›è¡Œç»˜åˆ¶</li>
</ol>
</li>
<li><p><code>ViewRootImpl#setView</code>æµç¨‹ä¸­ï¼Œè¿›å…¥ <code>view</code>çš„<code>Measure + Layout + Draw</code> æµç¨‹ã€‚</p>
</li>
<li><p>æœ€å é€šè¿‡<code>Activity.makeVisible</code>ä½¿å¾—view å¯è§ã€‚</p>
</li>
</ol>
<h1 id="å››ã€Qustion"><a href="#å››ã€Qustion" class="headerlink" title="å››ã€Qustion"></a>å››ã€Qustion</h1><p> invaliate å’Œ requestlayout æ–¹æ³•çš„åŒºåˆ«ï¼Ÿ</p>
<p>å‰é¢æˆ‘ä»¬è¯´åˆ°ï¼ŒViewRootImpl ä½œä¸ºé¡¶çº§ View è´Ÿè´£ View çš„ç»˜åˆ¶ã€‚æ‰€ä»¥ç®€å•æ¥è¯´ï¼Œrequestlayout å’Œ invaliate æœ€ç»ˆéƒ½ä¼šå‘ä¸Šå›æº¯è°ƒç”¨åˆ° ViewRootImpl çš„ postTranversals æ–¹æ³•æ¥ç»˜åˆ¶ Viewã€‚</p>
<p>ä¸åŒçš„æ˜¯ requestlayout ä¼šç»˜åˆ¶ View çš„ measureï¼Œlayout å’Œ draw è¿‡ç¨‹ã€‚invaliate å› ä¸ºåªæ·»åŠ äº†ç»˜åˆ¶ draw çš„æ ‡å¿—ä½ï¼Œåªä¼šç»˜åˆ¶ draw è¿‡ç¨‹ã€‚ </p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904131136618510">https://juejin.cn/post/6844904131136618510</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/ITRenj/article/details/53819583">invalidate()å’ŒrequestLayout()æ–¹æ³•è°ƒç”¨è¿‡ç¨‹</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/baiqiantao/p/2a3fccd829120089d24547929175ae29.html">invalidateå’ŒrequestLayoutæ–¹æ³•æºç åˆ†æ</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904159230033928#heading-11">https://juejin.cn/post/6844904159230033928#heading-11</a></p>

    </div>

    
    
    
      

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>æœ¬æ–‡ä½œè€…ï¼š </strong>sven
  </li>
  <li class="post-copyright-link">
    <strong>æœ¬æ–‡é“¾æ¥ï¼š</strong>
    <a href="https://zhaoxiaowen-sven.github.io/2021/06/20/Notes/Android/04Framework/FrameWork_05_View%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B/" title="FrameWork_05_Viewç»˜åˆ¶æµç¨‹">https://zhaoxiaowen-sven.github.io/2021/06/20/Notes/Android/04Framework/FrameWork_05_Viewç»˜åˆ¶æµç¨‹/</a>
  </li>
  <li class="post-copyright-license">
    <strong>ç‰ˆæƒå£°æ˜ï¼š </strong>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
  </li>
</ul>
</div>


      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/06/06/Notes/Android/04Framework/FrameWork_04_Activity%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" rel="prev" title="FrameWork_04_AMS">
      <i class="fa fa-chevron-left"></i> FrameWork_04_AMS
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/06/26/Notes/Android/04Framework/FrameWork_06_View%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91/" rel="next" title="FrameWork_06_Viewäº‹ä»¶åˆ†å‘">
      FrameWork_06_Viewäº‹ä»¶åˆ†å‘ <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#FrameWork-05-View%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B"><span class="nav-text">FrameWork_05_Viewç»˜åˆ¶æµç¨‹</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E5%B8%83%E5%B1%80%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B"><span class="nav-text">ä¸€ã€å¸ƒå±€åˆ›å»ºè¿‡ç¨‹</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1%E3%80%81ActivityThread-performLaunchActivity"><span class="nav-text">1.1ã€ActivityThread#performLaunchActivity</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-1%E3%80%81-Activity-attach"><span class="nav-text">1.1.1ã€ Activity#attach</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-2%E3%80%81Instrumentation-callActivityOnCreate"><span class="nav-text">1.1.2ã€Instrumentation#callActivityOnCreate</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81Activity-setContentView"><span class="nav-text">1ã€Activity#setContentView</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81PhoneWindow-setContentView"><span class="nav-text">2ã€PhoneWindow#setContentView</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81PhoneWindow-installDecor"><span class="nav-text">3ã€PhoneWindow#installDecor</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2%E3%80%81ActivityThread-handleResumeActivity"><span class="nav-text">1.2ã€ActivityThread#handleResumeActivity</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-1%E3%80%81WindowManager-addView"><span class="nav-text">1.2.1ã€WindowManager#addView</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-2%E3%80%81ViewRootImpl-setView"><span class="nav-text">1.2.2ã€ViewRootImpl#setView</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81view-%E7%9A%84%E7%BB%98%E5%88%B6%E5%92%8C%E6%B8%B2%E6%9F%93%E8%BF%87%E7%A8%8B"><span class="nav-text">äºŒã€view çš„ç»˜åˆ¶å’Œæ¸²æŸ“è¿‡ç¨‹</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1%E3%80%81MeasureSpec"><span class="nav-text">2.1ã€MeasureSpec</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-1%E3%80%81DecorView-%E7%9A%84MeasureSpec"><span class="nav-text">2.1.1ã€DecorView çš„MeasureSpec</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-2%E3%80%81%E6%99%AE%E9%80%9Aview%E7%9A%84MeasureSpec"><span class="nav-text">2.1.2ã€æ™®é€šviewçš„MeasureSpec</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2%E3%80%81measure%E6%B5%81%E7%A8%8B"><span class="nav-text">2.2ã€measureæµç¨‹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-1%E3%80%81View-%E7%9A%84%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B"><span class="nav-text">2.2.1ã€View çš„ç»˜åˆ¶æµç¨‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-2%E3%80%81ViewGroup%E7%9A%84%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B"><span class="nav-text">2.2.2ã€ViewGroupçš„ç»˜åˆ¶æµç¨‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-3%E3%80%81view-%E5%AE%BD%E9%AB%98%E8%8E%B7%E5%8F%96"><span class="nav-text">2.2.3ã€view å®½é«˜è·å–?</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3%E3%80%81Layout%E6%B5%81%E7%A8%8B"><span class="nav-text">2.3ã€Layoutæµç¨‹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-1%E3%80%81setFrame"><span class="nav-text">2.3.1ã€setFrame</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-2%E3%80%81onLayout"><span class="nav-text">2.3.2ã€onLayout</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4%E3%80%81draw%E6%B5%81%E7%A8%8B"><span class="nav-text">2.4ã€drawæµç¨‹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-1%E3%80%81Draw"><span class="nav-text">2.4.1ã€Draw</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-2%E3%80%81View-%E7%9A%84%E6%A0%91%E5%BD%A2%E7%BB%93%E6%9E%84%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B"><span class="nav-text">2.4.2ã€View çš„æ ‘å½¢ç»“æ„ç»˜åˆ¶æµç¨‹</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E6%80%BB%E7%BB%93"><span class="nav-text">ä¸‰ã€æ€»ç»“</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E3%80%81Qustion"><span class="nav-text">å››ã€Qustion</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="sven"
      src="/images/sven.jpeg">
  <p class="site-author-name" itemprop="name">sven</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">81</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/zhaoxiaowen-sven" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;zhaoxiaowen-sven" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zhaoxiaowen-sven@gmail.com" title="E-Mail â†’ mailto:zhaoxiaowen-sven@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">sven</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="æ€»è®¿å®¢é‡">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="æ€»è®¿é—®é‡">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
