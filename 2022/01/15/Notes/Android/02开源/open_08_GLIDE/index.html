<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zhaoxiaowen-sven.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="open_08_GLIDE">
<meta property="og:type" content="article">
<meta property="og:title" content="open_08_GLIDE">
<meta property="og:url" content="https://zhaoxiaowen-sven.github.io/2022/01/15/Notes/Android/02%E5%BC%80%E6%BA%90/open_08_GLIDE/index.html">
<meta property="og:site_name" content="Sven&#39;s blog">
<meta property="og:description" content="open_08_GLIDE">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://zhaoxiaowen-sven.github.io/pics/image-20220206123520298.png">
<meta property="og:image" content="https://zhaoxiaowen-sven.github.io/pics/image-20220205205518836.png">
<meta property="og:image" content="https://zhaoxiaowen-sven.github.io/pics/image-20220206110607731.png">
<meta property="og:image" content="https://zhaoxiaowen-sven.github.io/pics/image-20220208225151406.png">
<meta property="og:image" content="https://zhaoxiaowen-sven.github.io/pics/image-20220213215722486.png">
<meta property="og:image" content="https://zhaoxiaowen-sven.github.io/pics/image-20220213223212792.png">
<meta property="article:published_time" content="2022-01-15T08:16:18.766Z">
<meta property="article:modified_time" content="2022-12-25T01:56:17.466Z">
<meta property="article:author" content="sven">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zhaoxiaowen-sven.github.io/pics/image-20220206123520298.png">

<link rel="canonical" href="https://zhaoxiaowen-sven.github.io/2022/01/15/Notes/Android/02%E5%BC%80%E6%BA%90/open_08_GLIDE/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>open_08_GLIDE | Sven's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>
      <a target="_blank" rel="noopener" href="https://github.com/zhaoxiaowen-sven" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Sven's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhaoxiaowen-sven.github.io/2022/01/15/Notes/Android/02%E5%BC%80%E6%BA%90/open_08_GLIDE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/sven.jpeg">
      <meta itemprop="name" content="sven">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sven's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          open_08_GLIDE
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-15 16:16:18" itemprop="dateCreated datePublished" datetime="2022-01-15T16:16:18+08:00">2022-01-15</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/%E5%BC%80%E6%BA%90/" itemprop="url" rel="index"><span itemprop="name">开源</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="open-08-GLIDE"><a href="#open-08-GLIDE" class="headerlink" title="open_08_GLIDE"></a>open_08_GLIDE</h1><span id="more"></span>

<p>本文源码分析，基于<a target="_blank" rel="noopener" href="https://github.com/bumptech/glide">Glide:4.12.0</a></p>
<h1 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h1><p>整体架构：</p>
<img src="/pics/image-20220206123520298.png" alt="image-20220206123520298" style="zoom:50%;" />

<p>涉及到几个概念：</p>
<ul>
<li>Model：数据源，Url 等等，对应Glide组件ModelLoader</li>
<li>Data：原始数据，InputStream等等，对应 Glide 组件 DataFetcher</li>
<li>cache：三级缓存，内存，磁盘和网络；内存缓存包括 弱引用 + LRUCache</li>
<li>Resource：解码后的原始数据 </li>
<li>TransformedResource：转换后的资源</li>
<li>Transcoded Resource：转码后的资源</li>
<li>Target：显示资源组件，比如 ImageViewTarget</li>
</ul>
<p>加载过程如下：</p>
<img src="/pics/image-20220205205518836.png" alt="image-20220205205518836" style="zoom:50%;" />

<h1 id="二、使用方法"><a href="#二、使用方法" class="headerlink" title="二、使用方法"></a>二、使用方法</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Glide.with(<span class="keyword">this</span>) <span class="comment">// 生命周期</span></span><br><span class="line">        .load(url) <span class="comment">// 网络图片，本地资源，二进制流等等</span></span><br><span class="line">        .placeholder(R.drawable.ic_ultraviolet) <span class="comment">// 占位符，不能用网络资源做占位符</span></span><br><span class="line">        .error(R.drawable.bg_clear_day) <span class="comment">//</span></span><br><span class="line">        .override(<span class="number">300</span>, <span class="number">300</span>) <span class="comment">// 限制图片尺寸，根据imageView</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 填充策略</span></span><br><span class="line">        .fitCenter() <span class="comment">// 完全显示，但是不一定能填充整个imageView</span></span><br><span class="line">        .centerCrop() <span class="comment">// 填充整个imageView 但是不能完全显示</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 缓存策略</span></span><br><span class="line">        .skipMemoryCache(<span class="keyword">true</span>) <span class="comment">// 跳过内存缓存</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 磁盘缓存的 4 种策略</span></span><br><span class="line">        <span class="comment">// 磁盘不缓存</span></span><br><span class="line">        .diskCacheStrategy(DiskCacheStrategy.NONE)</span><br><span class="line">        <span class="comment">// 原始图片</span></span><br><span class="line">        .diskCacheStrategy(DiskCacheStrategy.SOURCE)</span><br><span class="line">        <span class="comment">// 降低分辨率后的图片</span></span><br><span class="line">        .diskCacheStrategy(DiskCacheStrategy.RESULT)</span><br><span class="line">        <span class="comment">// 缓存所有版本的图片</span></span><br><span class="line">        .diskCacheStrategy(DiskCacheStrategy.ALL)</span><br><span class="line">        <span class="comment">// 图片加载优先级，但是不一定能够完全安装这个优先级加载</span></span><br><span class="line">        .priority(Priority.HIGH)</span><br><span class="line"></span><br><span class="line">        .into(mImageView);</span><br></pre></td></tr></table></figure>

<h1 id="三、源码分析"><a href="#三、源码分析" class="headerlink" title="三、源码分析"></a>三、源码分析</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Glide.with(<span class="keyword">this</span>)</span><br><span class="line">  .load(url)</span><br><span class="line">  .diskCacheStrategy(DiskCacheStrategy.NONE) <span class="comment">// 开启缓存后，数据加载过程比较复杂，我们后面回说明</span></span><br><span class="line">  .into();</span><br></pre></td></tr></table></figure>

<h2 id="3-1、with"><a href="#3-1、with" class="headerlink" title="3.1、with"></a>3.1、with</h2><p>with 的主要作用有2个：</p>
<ul>
<li>初始化Glide配置和各种组件（ModelLoader）</li>
<li>根据不同的<code>context</code>绑定相应的生命周期组件（Application/Fragment）</li>
</ul>
<img src="/pics/image-20220206110607731.png" alt="image-20220206110607731" style="zoom:33%;" />

<p>with 共有6个重载函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestManager <span class="title">with</span><span class="params">(<span class="meta">@NonNull</span> Context context)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> getRetriever(context).get(context);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestManager <span class="title">with</span><span class="params">(<span class="meta">@NonNull</span> Activity activity)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> getRetriever(activity).get(activity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestManager <span class="title">with</span><span class="params">(<span class="meta">@NonNull</span> FragmentActivity activity)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> getRetriever(activity).get(activity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestManager <span class="title">with</span><span class="params">(<span class="meta">@NonNull</span> Fragment fragment)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> getRetriever(fragment.getContext()).get(fragment);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestManager <span class="title">with</span><span class="params">(<span class="meta">@NonNull</span> android.app.Fragment fragment)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> getRetriever(fragment.getActivity()).get(fragment);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestManager <span class="title">with</span><span class="params">(<span class="meta">@NonNull</span> View view)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> getRetriever(view.getContext()).get(view);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们<code>with(@NonNull FragmentActivity context)</code>为例分析。</p>
<p>主要流程分为2步：</p>
<ol>
<li>初始化Glide 并构造出 <code>RequestManagerRetriever</code> </li>
<li>通过<code>RequestManagerRetriever</code>构造出RequestManager 并绑定LifeCycle。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestManager <span class="title">with</span><span class="params">(<span class="meta">@NonNull</span> FragmentActivity activity)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> getRetriever(activity)<span class="comment">//1、初始化glide </span></span><br><span class="line">  </span><br><span class="line">  .get(activity); <span class="comment">//2、绑定LifeCycle。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-1-1、Glide-初始化"><a href="#3-1-1、Glide-初始化" class="headerlink" title="3.1.1、Glide 初始化"></a>3.1.1、Glide 初始化</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> RequestManagerRetriever <span class="title">getRetriever</span><span class="params">(<span class="meta">@Nullable</span> Context context)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> Glide.get(context).getRequestManagerRetriever();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1、Glide-get"><a href="#1、Glide-get" class="headerlink" title="1、Glide#get"></a>1、Glide#get</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 单例方式创建Glide</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Glide <span class="title">get</span><span class="params">(<span class="meta">@NonNull</span> Context context)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (glide == <span class="keyword">null</span>) &#123;</span><br><span class="line">    GeneratedAppGlideModule annotationGeneratedModule =</span><br><span class="line">        getAnnotationGeneratedGlideModules(context.getApplicationContext());</span><br><span class="line">    <span class="keyword">synchronized</span> (Glide.class) &#123;</span><br><span class="line">      <span class="keyword">if</span> (glide == <span class="keyword">null</span>) &#123;</span><br><span class="line">        checkAndInitializeGlide(context, annotationGeneratedModule);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> glide;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GuardedBy(&quot;Glide.class&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkAndInitializeGlide</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="meta">@NonNull</span> Context context, <span class="meta">@Nullable</span> GeneratedAppGlideModule generatedAppGlideModule)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...省略</span></span><br><span class="line">  isInitializing = <span class="keyword">true</span>;</span><br><span class="line">  initializeGlide(context, generatedAppGlideModule);</span><br><span class="line">  isInitializing = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2、Glide-initializeGlide"><a href="#2、Glide-initializeGlide" class="headerlink" title="2、Glide#initializeGlide"></a>2、Glide#initializeGlide</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initializeGlide</span><span class="params">(<span class="meta">@NonNull</span> Context context, <span class="meta">@NonNull</span> GlideBuilder builder)</span> </span>&#123;</span><br><span class="line">      Context applicationContext = context.getApplicationContext();</span><br><span class="line">      <span class="comment">//通过反射找到GeneratedAppGlideModuleImpl 类，如果能找到，就说明自定义了GlideModule</span></span><br><span class="line">      <span class="comment">//那么就需要在合适的地方调用applyOptions、registerComponents 来实现自定义的功能</span></span><br><span class="line">      GeneratedAppGlideModule annotationGeneratedModule = getAnnotationGeneratedGlideModules();</span><br><span class="line">      List&lt;com.bumptech.glide.<span class="keyword">module</span>.GlideModule&gt; manifestModules = Collections.emptyList();</span><br><span class="line">      <span class="keyword">if</span> (annotationGeneratedModule == <span class="keyword">null</span> || annotationGeneratedModule.isManifestParsingEnabled()) &#123;</span><br><span class="line">          <span class="comment">// 从AndroidManifest.xml 获取自定义的GlideModule（这是另外一种自定义GlideModule的方式）</span></span><br><span class="line">          manifestModules = <span class="keyword">new</span> ManifestParser(applicationContext).parse();</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">//如果在注解中指明了要排除的GlideModule，则把GlideModule删除，在GlideModule中 从AndroidManifest.xml 中获取的 </span></span><br><span class="line">      <span class="keyword">if</span> (annotationGeneratedModule != <span class="keyword">null</span></span><br><span class="line">              &amp;&amp; !annotationGeneratedModule.getExcludedModuleClasses().isEmpty()) &#123;</span><br><span class="line">          Set&lt;Class&lt;?&gt;&gt; excludedModuleClasses =</span><br><span class="line">                  annotationGeneratedModule.getExcludedModuleClasses();</span><br><span class="line">          Iterator&lt;com.bumptech.glide.<span class="keyword">module</span>.GlideModule&gt; iterator = manifestModules.iterator();</span><br><span class="line">          <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">              com.bumptech.glide.<span class="keyword">module</span>.GlideModule current = iterator.next();</span><br><span class="line">              <span class="keyword">if</span> (!excludedModuleClasses.contains(current.getClass())) &#123;</span><br><span class="line">                  <span class="keyword">continue</span>;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</span><br><span class="line">                  Log.d(TAG, <span class="string">&quot;AppGlideModule excludes manifest GlideModule: &quot;</span> + current);</span><br><span class="line">              &#125;</span><br><span class="line">              iterator.remove();</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">// 获取工厂，用于创建RequestManager（该工厂用于，如果with（）参数传递的是application）</span></span><br><span class="line">      RequestManagerRetriever.RequestManagerFactory factory =</span><br><span class="line">              annotationGeneratedModule != <span class="keyword">null</span></span><br><span class="line">                      ? annotationGeneratedModule.getRequestManagerFactory() : <span class="keyword">null</span>;</span><br><span class="line">      builder.setRequestManagerFactory(factory);</span><br><span class="line">      <span class="comment">//执行用户在 manifest 中配置的 GlideModule 接口中的方法</span></span><br><span class="line">      <span class="keyword">for</span> (com.bumptech.glide.<span class="keyword">module</span>.GlideModule <span class="keyword">module</span> : manifestModules) &#123;</span><br><span class="line">          <span class="keyword">module</span>.applyOptions(applicationContext, builder);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//执行使用注解配置的GlideModule 接口中的方法</span></span><br><span class="line">      <span class="keyword">if</span> (annotationGeneratedModule != <span class="keyword">null</span>) &#123;</span><br><span class="line">          annotationGeneratedModule.applyOptions(applicationContext, builder);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//创建Glide，代码4分析</span></span><br><span class="line">      Glide glide = builder.build(applicationContext);</span><br><span class="line">      <span class="comment">//下面registerComponents 方法的执行，需要传递Registry对象，而该对象是在创建Glide 的时候，被赋值，并设置一系列的参数</span></span><br><span class="line">      <span class="comment">//执行用户在 manifest 中配置的 GlideModule 接口中的registerComponents 方法</span></span><br><span class="line">      <span class="keyword">for</span> (com.bumptech.glide.<span class="keyword">module</span>.GlideModule <span class="keyword">module</span> : manifestModules) &#123;</span><br><span class="line">          <span class="keyword">module</span>.registerComponents(applicationContext, glide, glide.registry);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//执行 使用注解配置的GlideModule 接口中的registerComponents 方法</span></span><br><span class="line">      <span class="keyword">if</span> (annotationGeneratedModule != <span class="keyword">null</span>) &#123;</span><br><span class="line">          annotationGeneratedModule.registerComponents(applicationContext, glide, glide.registry);</span><br><span class="line">      &#125;</span><br><span class="line">      applicationContext.registerComponentCallbacks(glide);</span><br><span class="line">      <span class="comment">//向单例赋值</span></span><br><span class="line">      Glide.glide = glide;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h4 id="3、GlideBuilder-build"><a href="#3、GlideBuilder-build" class="headerlink" title="3、GlideBuilder#build"></a>3、GlideBuilder#build</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Glide <span class="title">build</span><span class="params">(<span class="meta">@NonNull</span> Context context)</span> </span>&#123;</span><br><span class="line">      <span class="comment">//创建执行器，用于从数据源获取数据，例如网络请求</span></span><br><span class="line">       <span class="keyword">if</span> (sourceExecutor == <span class="keyword">null</span>) &#123;</span><br><span class="line">           sourceExecutor = GlideExecutor.newSourceExecutor();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//创建执行器，用于从本地缓存获取数据</span></span><br><span class="line">       <span class="keyword">if</span> (diskCacheExecutor == <span class="keyword">null</span>) &#123;</span><br><span class="line">           diskCacheExecutor = GlideExecutor.newDiskCacheExecutor();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (animationExecutor == <span class="keyword">null</span>) &#123;</span><br><span class="line">           animationExecutor = GlideExecutor.newAnimationExecutor();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//根据当前机器参数计算需要设置的缓存大小</span></span><br><span class="line">       <span class="keyword">if</span> (memorySizeCalculator == <span class="keyword">null</span>) &#123;</span><br><span class="line">           memorySizeCalculator = <span class="keyword">new</span> MemorySizeCalculator.Builder(context).build();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (connectivityMonitorFactory == <span class="keyword">null</span>) &#123;</span><br><span class="line">           connectivityMonitorFactory = <span class="keyword">new</span> DefaultConnectivityMonitorFactory();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//创建 Bitmap 池，用于回收LruCache缓存的图片，把图片回收到bitmapPool中，这样下次再创建图片时，可服用该内存，避免连续创建回收内存，造成的内存抖动</span></span><br><span class="line">       <span class="keyword">if</span> (bitmapPool == <span class="keyword">null</span>) &#123;</span><br><span class="line">           </span><br><span class="line">           <span class="keyword">int</span> size = memorySizeCalculator.getBitmapPoolSize();</span><br><span class="line">           <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">               bitmapPool = <span class="keyword">new</span> LruBitmapPool(size);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               bitmapPool = <span class="keyword">new</span> BitmapPoolAdapter();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//创建数组池</span></span><br><span class="line">       <span class="keyword">if</span> (arrayPool == <span class="keyword">null</span>) &#123;</span><br><span class="line">           arrayPool = <span class="keyword">new</span> LruArrayPool(memorySizeCalculator.getArrayPoolSizeInBytes());</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//创建内存缓存</span></span><br><span class="line">       <span class="keyword">if</span> (memoryCache == <span class="keyword">null</span>) &#123;</span><br><span class="line">           memoryCache = <span class="keyword">new</span> LruResourceCache(memorySizeCalculator.getMemoryCacheSize());</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//创建磁盘缓存</span></span><br><span class="line">       <span class="keyword">if</span> (diskCacheFactory == <span class="keyword">null</span>) &#123;</span><br><span class="line">           diskCacheFactory = <span class="keyword">new</span> InternalCacheDiskCacheFactory(context);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//创建Engine，真正处理request的类，例如发起网络请求图片，从磁盘读取图片等</span></span><br><span class="line">       <span class="keyword">if</span> (engine == <span class="keyword">null</span>) &#123;</span><br><span class="line">           engine =</span><br><span class="line">                   <span class="keyword">new</span> Engine(</span><br><span class="line">                           memoryCache,</span><br><span class="line">                           diskCacheFactory,</span><br><span class="line">                           diskCacheExecutor,</span><br><span class="line">                           sourceExecutor,</span><br><span class="line">                           GlideExecutor.newUnlimitedSourceExecutor(),</span><br><span class="line">                           animationExecutor,</span><br><span class="line">                           isActiveResourceRetentionAllowed);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (defaultRequestListeners == <span class="keyword">null</span>) &#123;</span><br><span class="line">           defaultRequestListeners = Collections.emptyList();</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           defaultRequestListeners = Collections.unmodifiableList(defaultRequestListeners);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//代码2 getRetriever() 返回的就是该对象</span></span><br><span class="line">       RequestManagerRetriever requestManagerRetriever =</span><br><span class="line">               <span class="keyword">new</span> RequestManagerRetriever(requestManagerFactory);</span><br><span class="line">	<span class="comment">//创建Glide</span></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Glide(</span><br><span class="line">               context,</span><br><span class="line">               engine,</span><br><span class="line">               memoryCache,</span><br><span class="line">               bitmapPool,</span><br><span class="line">               arrayPool,</span><br><span class="line">               requestManagerRetriever,</span><br><span class="line">               connectivityMonitorFactory,</span><br><span class="line">               logLevel,</span><br><span class="line">               defaultRequestOptions.lock(),</span><br><span class="line">               defaultTransitionOptions,</span><br><span class="line">               defaultRequestListeners,</span><br><span class="line">               isLoggingRequestOriginsEnabled);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="4、Glide-Glide"><a href="#4、Glide-Glide" class="headerlink" title="4、Glide#Glide"></a>4、Glide#Glide</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">代码五 类Glide.<span class="function">java </span></span><br><span class="line"><span class="function">   <span class="title">Glide</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@NonNull</span> Context context,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@NonNull</span> Engine engine,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@NonNull</span> MemoryCache memoryCache,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@NonNull</span> BitmapPool bitmapPool,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@NonNull</span> ArrayPool arrayPool,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@NonNull</span> RequestManagerRetriever requestManagerRetriever,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@NonNull</span> ConnectivityMonitorFactory connectivityMonitorFactory,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">int</span> logLevel,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@NonNull</span> RequestOptions defaultRequestOptions,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@NonNull</span> Map&lt;Class&lt;?&gt;, TransitionOptions&lt;?, ?&gt;&gt; defaultTransitionOptions,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@NonNull</span> List&lt;RequestListener&lt;Object&gt;&gt; defaultRequestListeners,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">boolean</span> isLoggingRequestOriginsEnabled)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.engine = engine;</span><br><span class="line">        <span class="keyword">this</span>.bitmapPool = bitmapPool;</span><br><span class="line">        <span class="keyword">this</span>.arrayPool = arrayPool;</span><br><span class="line">        <span class="keyword">this</span>.memoryCache = memoryCache;</span><br><span class="line">        <span class="keyword">this</span>.requestManagerRetriever = requestManagerRetriever;</span><br><span class="line">        <span class="keyword">this</span>.connectivityMonitorFactory = connectivityMonitorFactory;</span><br><span class="line"></span><br><span class="line">        DecodeFormat decodeFormat = defaultRequestOptions.getOptions().get(Downsampler.DECODE_FORMAT);</span><br><span class="line">        bitmapPreFiller = <span class="keyword">new</span> BitmapPreFiller(memoryCache, bitmapPool, decodeFormat);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Resources resources = context.getResources();</span><br><span class="line"></span><br><span class="line">        registry = <span class="keyword">new</span> Registry();</span><br><span class="line">        registry.register(<span class="keyword">new</span> DefaultImageHeaderParser());</span><br><span class="line"></span><br><span class="line">          ...省略若干代码，创建需要加入到registry 的类...</span><br><span class="line"></span><br><span class="line">        ContentResolver contentResolver = context.getContentResolver();</span><br><span class="line">		<span class="comment">//添加各种Encoder（把数据存为File）、ResourceDecoder（把数据从类型A转为类型B）、</span></span><br><span class="line">		<span class="comment">//ModelLoaderFactory（用于创建ModelLoader，它用于将任意复杂的数据模型转换为可由 DataFetcher 获取模型所代表的资源数据的具体数据类型。用来加载资源的。 ）</span></span><br><span class="line">        registry</span><br><span class="line">                .append(ByteBuffer.class, <span class="keyword">new</span> ByteBufferEncoder())</span><br><span class="line">                ...省略若干代码...</span><br><span class="line">                .append(Drawable.class, Drawable.class, <span class="keyword">new</span> UnitDrawableDecoder())</span><br><span class="line">                <span class="comment">/* Transcoders */</span></span><br><span class="line">                .register(</span><br><span class="line">                        Bitmap.class,</span><br><span class="line">                        BitmapDrawable.class,</span><br><span class="line">                        <span class="keyword">new</span> BitmapDrawableTranscoder(resources))</span><br><span class="line">                .register(Bitmap.class, <span class="keyword">byte</span>[].class, bitmapBytesTranscoder)</span><br><span class="line">                .register(</span><br><span class="line">                        Drawable.class,</span><br><span class="line">                        <span class="keyword">byte</span>[].class,</span><br><span class="line">                        <span class="keyword">new</span> DrawableBytesTranscoder(</span><br><span class="line">                                bitmapPool, bitmapBytesTranscoder, gifDrawableBytesTranscoder))</span><br><span class="line">                .register(GifDrawable.class, <span class="keyword">byte</span>[].class, gifDrawableBytesTranscoder);</span><br><span class="line">        <span class="comment">//该工厂用于生产ImageViewTarget，最终通过ImageViewTarget对象把图片addView到界面上 </span></span><br><span class="line">        ImageViewTargetFactory imageViewTargetFactory = <span class="keyword">new</span> ImageViewTargetFactory();</span><br><span class="line">        glideContext =</span><br><span class="line">                <span class="keyword">new</span> GlideContext(</span><br><span class="line">                        context,</span><br><span class="line">                        arrayPool,</span><br><span class="line">                        registry,</span><br><span class="line">                        imageViewTargetFactory,</span><br><span class="line">                        defaultRequestOptions,</span><br><span class="line">                        defaultTransitionOptions,</span><br><span class="line">                        defaultRequestListeners,</span><br><span class="line">                        engine,</span><br><span class="line">                        isLoggingRequestOriginsEnabled,</span><br><span class="line">                        logLevel);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到，代码主要逻辑是通过Registry 对象添加图片的加载、解析组件。以下是registry中的对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Registry</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.modelLoaderRegistry = <span class="keyword">new</span> ModelLoaderRegistry(throwableListPool);</span><br><span class="line">  <span class="keyword">this</span>.encoderRegistry = <span class="keyword">new</span> EncoderRegistry();</span><br><span class="line">  <span class="keyword">this</span>.decoderRegistry = <span class="keyword">new</span> ResourceDecoderRegistry();</span><br><span class="line">  <span class="keyword">this</span>.resourceEncoderRegistry = <span class="keyword">new</span> ResourceEncoderRegistry();</span><br><span class="line">  <span class="keyword">this</span>.dataRewinderRegistry = <span class="keyword">new</span> DataRewinderRegistry();</span><br><span class="line">  <span class="keyword">this</span>.transcoderRegistry = <span class="keyword">new</span> TranscoderRegistry();</span><br><span class="line">  <span class="keyword">this</span>.imageHeaderParserRegistry = <span class="keyword">new</span> ImageHeaderParserRegistry();</span><br><span class="line">  setResourceDecoderBucketPriorityList(</span><br><span class="line">      Arrays.asList(BUCKET_GIF, BUCKET_BITMAP, BUCKET_BITMAP_DRAWABLE));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-1-2、绑定LifeCycle组件"><a href="#3-1-2、绑定LifeCycle组件" class="headerlink" title="3.1.2、绑定LifeCycle组件"></a>3.1.2、绑定LifeCycle组件</h3><h4 id="1、RequestManagerRetriever-get"><a href="#1、RequestManagerRetriever-get" class="headerlink" title="1、RequestManagerRetriever#get"></a>1、RequestManagerRetriever#get</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestManager <span class="title">with</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    RequestManagerRetriever retriever = RequestManagerRetriever.get();</span><br><span class="line">    <span class="keyword">return</span> retriever.get(context);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> RequestManager <span class="title">get</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (context == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;You cannot start a load on a null Context&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Util.isOnMainThread() &amp;&amp; !(context <span class="keyword">instanceof</span> Application)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (context <span class="keyword">instanceof</span> FragmentActivity) &#123;</span><br><span class="line">            <span class="keyword">return</span> get((FragmentActivity) context);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (context <span class="keyword">instanceof</span> Activity) &#123;</span><br><span class="line">            <span class="keyword">return</span> get((Activity) context);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (context <span class="keyword">instanceof</span> ContextWrapper) &#123;</span><br><span class="line">            <span class="keyword">return</span> get(((ContextWrapper) context).getBaseContext());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> getApplicationManager(context);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> RequestManager <span class="title">getApplicationManager</span><span class="params">(<span class="meta">@NonNull</span> Context context)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Either an application context or we&#x27;re on a background thread.</span></span><br><span class="line">  <span class="keyword">if</span> (applicationManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (applicationManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Glide glide = Glide.get(context.getApplicationContext());</span><br><span class="line">        applicationManager =</span><br><span class="line">            factory.build(</span><br><span class="line">                glide,</span><br><span class="line">                <span class="keyword">new</span> ApplicationLifecycle(),</span><br><span class="line">                <span class="keyword">new</span> EmptyRequestManagerTreeNode(),</span><br><span class="line">                context.getApplicationContext());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RequestManager <span class="title">get</span><span class="params">(<span class="meta">@NonNull</span> FragmentActivity activity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Util.isOnBackgroundThread()) &#123;</span><br><span class="line">      <span class="keyword">return</span> get(activity.getApplicationContext());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      assertNotDestroyed(activity);</span><br><span class="line">      frameWaiter.registerSelf(activity);</span><br><span class="line">      FragmentManager fm = activity.getSupportFragmentManager();</span><br><span class="line">      <span class="comment">// fragment</span></span><br><span class="line">      <span class="keyword">return</span> supportFragmentGet(activity, fm, <span class="comment">/*parentHint=*/</span> <span class="keyword">null</span>, isActivityVisible(activity));</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line">  </span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> RequestManager <span class="title">supportFragmentGet</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="meta">@NonNull</span> Context context,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="meta">@NonNull</span> FragmentManager fm,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="meta">@Nullable</span> Fragment parentHint,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">boolean</span> isParentVisible)</span> </span>&#123;</span><br><span class="line">    SupportRequestManagerFragment current = getSupportRequestManagerFragment(fm, parentHint);</span><br><span class="line">    RequestManager requestManager = current.getRequestManager();</span><br><span class="line">    <span class="keyword">if</span> (requestManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// TODO(b/27524013): Factor out this Glide.get() call.</span></span><br><span class="line">      Glide glide = Glide.get(context);</span><br><span class="line">      requestManager =</span><br><span class="line">          factory.build(</span><br><span class="line">              glide, current.getGlideLifecycle(), current.getRequestManagerTreeNode(), context);</span><br><span class="line">      <span class="comment">// This is a bit of hack, we&#x27;re going to start the RequestManager, but not the</span></span><br><span class="line">      <span class="comment">// corresponding Lifecycle. It&#x27;s safe to start the RequestManager, but starting the</span></span><br><span class="line">      <span class="comment">// Lifecycle might trigger memory leaks. See b/154405040</span></span><br><span class="line">      <span class="keyword">if</span> (isParentVisible) &#123;</span><br><span class="line">        requestManager.onStart();</span><br><span class="line">      &#125;</span><br><span class="line">      current.setRequestManager(requestManager);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> requestManager;</span><br><span class="line">  &#125; </span><br></pre></td></tr></table></figure>

<p>RequestManagerRetriever类中看似有很多个get()方法的重载，什么Context参数，Activity参数，Fragment参数等等，实际上只有两种情况而已，即传入Application类型的参数，和传入非Application类型的参数。</p>
<ol>
<li><p>传入非Application参数的情况</p>
<p>不管你在Glide.with()方法中传入的是Activity、FragmentActivity、v4包下的Fragment、还是app包下的Fragment，最终的流程都是一样的，那就是会向当前的Activity当中添加一个隐藏的Fragment。<code>RequestManager</code> 关联的是 <code>ActivityFragmentLifecycle</code></p>
</li>
<li><p>传入Application参数的情况，<code>RequestManager</code>关联<code>ApplicationLifecycle</code></p>
</li>
</ol>
<p>至此with 函数就算分析完了，得到了RequestManager 对象。从命名就能看出来，它是请求管理者</p>
<h2 id="3-2、load"><a href="#3-2、load" class="headerlink" title="3.2、load"></a>3.2、load</h2><h3 id="3-2-1、RequestManager-load"><a href="#3-2-1、RequestManager-load" class="headerlink" title="3.2.1、RequestManager#load"></a>3.2.1、RequestManager#load</h3><p>这里的load 设置图片来源，有多种方式，从本地资源Drawable，String，Uri，File等，我们这里仅分析从网络请求图片的过程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> RequestBuilder&lt;Drawable&gt; <span class="title">load</span><span class="params">(<span class="meta">@Nullable</span> String string)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> asDrawable().load(string);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-2、RequestManager-asDrawable"><a href="#3-2-2、RequestManager-asDrawable" class="headerlink" title="3.2.2、RequestManager#asDrawable"></a>3.2.2、RequestManager#asDrawable</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//如果是其它的类型，就使用其它的asXXXX函数（例如asGif）</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RequestBuilder&lt;Drawable&gt; <span class="title">asDrawable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="comment">//这里传入Drawable.class,</span></span><br><span class="line">    <span class="keyword">return</span> as(Drawable.class);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;ResourceType&gt; <span class="function">RequestBuilder&lt;ResourceType&gt; <span class="title">as</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@NonNull</span> Class&lt;ResourceType&gt; resourceClass)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//创建RequestBuilder</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RequestBuilder&lt;&gt;(glide, <span class="keyword">this</span>, resourceClass, context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-3、RequestBuilder-load"><a href="#3-2-3、RequestBuilder-load" class="headerlink" title="3.2.3、RequestBuilder#load"></a>3.2.3、RequestBuilder#load</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">load</span><span class="params">(<span class="meta">@Nullable</span> Object model)</span> </span>&#123;</span><br><span class="line">   <span class="comment">// 这里的model 是一个url</span></span><br><span class="line">    <span class="keyword">return</span> loadGeneric(model);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">loadGeneric</span><span class="params">(<span class="meta">@Nullable</span> Object model)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 这里的model 是一个url</span></span><br><span class="line">    <span class="keyword">this</span>.model = model;</span><br><span class="line">    <span class="comment">// 记录url已设置</span></span><br><span class="line">    isModelSet = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-3、into"><a href="#3-3、into" class="headerlink" title="3.3、into"></a>3.3、into</h2><p>into 的入口是在RequestBuilder中。<code>RequestBuilder#into</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ViewTarget&lt;ImageView, TranscodeType&gt; <span class="title">into</span><span class="params">(<span class="meta">@NonNull</span> ImageView view)</span> </span>&#123;</span><br><span class="line">    BaseRequestOptions&lt;?&gt; requestOptions = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">if</span> (!requestOptions.isTransformationSet()</span><br><span class="line">            &amp;&amp; requestOptions.isTransformationAllowed()</span><br><span class="line">            &amp;&amp; view.getScaleType() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Clone in this method so that if we use this RequestBuilder to load into a View and then</span></span><br><span class="line">        <span class="comment">// into a different target, we don&#x27;t retain the transformation applied based on the previous</span></span><br><span class="line">        <span class="comment">// View&#x27;s scale type.</span></span><br><span class="line">        <span class="comment">//根据ImageView 的ScaleType 类型，进行参数设置，注意这里是clone 一个新的对象，在新对象上操作的</span></span><br><span class="line">        <span class="keyword">switch</span> (view.getScaleType()) &#123;</span><br><span class="line">            <span class="keyword">case</span> CENTER_CROP:</span><br><span class="line">                requestOptions = requestOptions.clone().optionalCenterCrop();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> CENTER_INSIDE:</span><br><span class="line">                requestOptions = requestOptions.clone().optionalCenterInside();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FIT_CENTER:</span><br><span class="line">            <span class="keyword">case</span> FIT_START:</span><br><span class="line">            <span class="keyword">case</span> FIT_END:</span><br><span class="line">                requestOptions = requestOptions.clone().optionalFitCenter();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FIT_XY:</span><br><span class="line">                requestOptions = requestOptions.clone().optionalCenterInside();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> CENTER:</span><br><span class="line">            <span class="keyword">case</span> MATRIX:</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="comment">// Do nothing.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> into(</span><br><span class="line">            <span class="comment">//这个transcodeClass是指的drawable或bitmap,就是前面as函数传入的类型</span></span><br><span class="line">            glideContext.buildImageViewTarget(view, transcodeClass),</span><br><span class="line">            <span class="comment">/*targetListener=*/</span> <span class="keyword">null</span>,</span><br><span class="line">            requestOptions,</span><br><span class="line">            <span class="comment">//在主线程，也就是通过 主线程的Handler 执行</span></span><br><span class="line">            Executors.mainThreadExecutor());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-1、构造ImageviewTarget"><a href="#3-3-1、构造ImageviewTarget" class="headerlink" title="3.3.1、构造ImageviewTarget"></a>3.3.1、构造ImageviewTarget</h3><p>into 中做的第一件事情就是构造出一个 <code>ImageviewTarget </code>对象，具体过程如下。</p>
<h4 id="1、GlideContext-buildImageViewTarget"><a href="#1、GlideContext-buildImageViewTarget" class="headerlink" title="1、GlideContext # buildImageViewTarget"></a>1、GlideContext # buildImageViewTarget</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;X&gt; <span class="function">ViewTarget&lt;ImageView, X&gt; <span class="title">buildImageViewTarget</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@NonNull</span> ImageView imageView, <span class="meta">@NonNull</span> Class&lt;X&gt; transcodeClass)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> imageViewTargetFactory.buildTarget(imageView, transcodeClass);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2、ImageViewTargetFactory-buildTarget"><a href="#2、ImageViewTargetFactory-buildTarget" class="headerlink" title="2、ImageViewTargetFactory # buildTarget"></a>2、ImageViewTargetFactory # buildTarget</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;Z&gt; <span class="function">ViewTarget&lt;ImageView, Z&gt; <span class="title">buildTarget</span><span class="params">(<span class="meta">@NonNull</span> ImageView view,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="meta">@NonNull</span> Class&lt;Z&gt; clazz)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (Bitmap.class.equals(clazz)) &#123;</span><br><span class="line">    <span class="keyword">return</span> (ViewTarget&lt;ImageView, Z&gt;) <span class="keyword">new</span> BitmapImageViewTarget(view);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Drawable.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">    <span class="comment">//因为前面调用asDrawable ，所以会创建这个ViewTarget</span></span><br><span class="line">    <span class="keyword">return</span> (ViewTarget&lt;ImageView, Z&gt;) <span class="keyword">new</span> DrawableImageViewTarget(view);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">        <span class="string">&quot;Unhandled class: &quot;</span> + clazz + <span class="string">&quot;, try .as*(Class).transcode(ResourceTranscoder)&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Glide内部只维护了两种target，一种是BitmapImageViewTarget，另一种则是DrawableImageViewTarget。这个class参数其实基本上只有两种情况，如果你在使用Glide加载图片的时候调用了<code>asBitmap()</code>方法，那么这里就会构建出<code>BitmapImageViewTarget</code>对象，否则的话构建的都是<code>DrawableImageViewTarget</code>对象。</p>
<p>接着我们继续看第二个重载的 into 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;Y extends Target&lt;TranscodeType&gt;&gt; <span class="function">Y <span class="title">into</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@NonNull</span> Y target,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@Nullable</span> RequestListener&lt;TranscodeType&gt; targetListener,</span></span></span><br><span class="line"><span class="params"><span class="function">        BaseRequestOptions&lt;?&gt; options,</span></span></span><br><span class="line"><span class="params"><span class="function">        Executor callbackExecutor)</span> </span>&#123;</span><br><span class="line">    Preconditions.checkNotNull(target);</span><br><span class="line">    <span class="keyword">if</span> (!isModelSet) &#123;</span><br><span class="line">        <span class="comment">//调用过load 函数，这个变量是true</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;You must call #load() before calling #into()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	 <span class="comment">//1.创建请求，用于显示图片。图片有可能是从缓存中，也有可能是从网络获取</span></span><br><span class="line">    Request request = buildRequest(target, targetListener, options, callbackExecutor);</span><br><span class="line">    </span><br><span class="line">	<span class="comment">//获取该目标 对应的request，和当前的request进行比较</span></span><br><span class="line">    Request previous = target.getRequest();</span><br><span class="line">  <span class="comment">// 如果连续两次请求是相同的话，就会被复用，不管有没有开启缓存</span></span><br><span class="line">    <span class="keyword">if</span> (request.isEquivalentTo(previous)</span><br><span class="line">            &amp;&amp; !isSkipMemoryCacheWithCompletePreviousRequest(options, previous)) &#123;</span><br><span class="line">        request.recycle();</span><br><span class="line">        <span class="comment">// If the request is completed, beginning again will ensure the result is re-delivered,</span></span><br><span class="line">        <span class="comment">// triggering RequestListeners and Targets. If the request is failed, beginning again will</span></span><br><span class="line">        <span class="comment">// restart the request, giving it another chance to complete. If the request is already</span></span><br><span class="line">        <span class="comment">// running, we can let it continue running without interruption.</span></span><br><span class="line">        <span class="keyword">if</span> (!Preconditions.checkNotNull(previous).isRunning()) &#123;</span><br><span class="line">            <span class="comment">// Use the previous request rather than the new one to allow for optimizations like skipping</span></span><br><span class="line">            <span class="comment">// setting placeholders, tracking and un-tracking Targets, and obtaining View dimensions</span></span><br><span class="line">            <span class="comment">// that are done in the individual Request.</span></span><br><span class="line">            previous.begin();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    requestManager.clear(target);</span><br><span class="line">    <span class="comment">//把当前的request，设置到target（ViewTarget）</span></span><br><span class="line">    target.setRequest(request);</span><br><span class="line">    <span class="comment">//2.进行图片请求操作</span></span><br><span class="line">    requestManager.track(target, request);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-2、构造Request请求"><a href="#3-3-2、构造Request请求" class="headerlink" title="3.3.2、构造Request请求"></a>3.3.2、构造Request请求</h3><p><code>RequestBuilder#buildRequest</code>构造Request请求，调用过程如下，最终调用到的是<code>SingleRequest构造函数</code>创建SingleRequest。</p>
<img src="/pics/image-20220208225151406.png" alt="image-20220208225151406" style="zoom:50%;" />

<p><code>buildRequestRecursive</code>设置成功及失败时的request。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Request <span class="title">buildRequestRecursive</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    Object requestLock,</span></span></span><br><span class="line"><span class="params"><span class="function">    Target&lt;TranscodeType&gt; target,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="meta">@Nullable</span> RequestListener&lt;TranscodeType&gt; targetListener,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="meta">@Nullable</span> RequestCoordinator parentCoordinator,</span></span></span><br><span class="line"><span class="params"><span class="function">    TransitionOptions&lt;?, ? <span class="keyword">super</span> TranscodeType&gt; transitionOptions,</span></span></span><br><span class="line"><span class="params"><span class="function">    Priority priority,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">int</span> overrideWidth,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">int</span> overrideHeight,</span></span></span><br><span class="line"><span class="params"><span class="function">    BaseRequestOptions&lt;?&gt; requestOptions,</span></span></span><br><span class="line"><span class="params"><span class="function">    Executor callbackExecutor)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Build the ErrorRequestCoordinator first if necessary so we can update parentCoordinator.</span></span><br><span class="line">  <span class="comment">//判断是否设置了，发生错误时，显示的图片</span></span><br><span class="line">  ErrorRequestCoordinator errorRequestCoordinator = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (errorBuilder != <span class="keyword">null</span>) &#123;</span><br><span class="line">    errorRequestCoordinator = <span class="keyword">new</span> ErrorRequestCoordinator(requestLock, parentCoordinator);</span><br><span class="line">    parentCoordinator = errorRequestCoordinator;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//创建缩略图和原图的Request</span></span><br><span class="line">  Request mainRequest =</span><br><span class="line">      buildThumbnailRequestRecursive(</span><br><span class="line">          requestLock,</span><br><span class="line">          target,</span><br><span class="line">          targetListener,</span><br><span class="line">          parentCoordinator,</span><br><span class="line">          transitionOptions,</span><br><span class="line">          priority,</span><br><span class="line">          overrideWidth,</span><br><span class="line">          overrideHeight,</span><br><span class="line">          requestOptions,</span><br><span class="line">          callbackExecutor);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (errorRequestCoordinator == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> mainRequest;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> errorOverrideWidth = errorBuilder.getOverrideWidth();</span><br><span class="line">  <span class="keyword">int</span> errorOverrideHeight = errorBuilder.getOverrideHeight();</span><br><span class="line">  <span class="keyword">if</span> (Util.isValidDimensions(overrideWidth, overrideHeight) &amp;&amp; !errorBuilder.isValidOverride()) &#123;</span><br><span class="line">    errorOverrideWidth = requestOptions.getOverrideWidth();</span><br><span class="line">    errorOverrideHeight = requestOptions.getOverrideHeight();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//创建错误时图片的内容</span></span><br><span class="line">  Request errorRequest =</span><br><span class="line">      errorBuilder.buildRequestRecursive(</span><br><span class="line">          requestLock,</span><br><span class="line">          target,</span><br><span class="line">          targetListener,</span><br><span class="line">          errorRequestCoordinator,</span><br><span class="line">          errorBuilder.transitionOptions,</span><br><span class="line">          errorBuilder.getPriority(),</span><br><span class="line">          errorOverrideWidth,</span><br><span class="line">          errorOverrideHeight,</span><br><span class="line">          errorBuilder,</span><br><span class="line">          callbackExecutor);</span><br><span class="line">  errorRequestCoordinator.setRequests(mainRequest, errorRequest);</span><br><span class="line">  <span class="keyword">return</span> errorRequestCoordinator;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-3、执行Request请求"><a href="#3-3-3、执行Request请求" class="headerlink" title="3.3.3、执行Request请求"></a>3.3.3、执行Request请求</h3><p> <code>RequestManager#track</code>负责执行Request请求。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">track</span><span class="params">(<span class="meta">@NonNull</span> Target&lt;?&gt; target, <span class="meta">@NonNull</span> Request request)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//把填充目标（这里是ImageView）加入跟踪器里，如果activity生命周期发生变化，就会执行填充目标相应的生命周期</span></span><br><span class="line">    targetTracker.track(target);</span><br><span class="line">    <span class="comment">//执行Request</span></span><br><span class="line">    requestTracker.runRequest(request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1、RequestTracker-runRequest"><a href="#1、RequestTracker-runRequest" class="headerlink" title="1、RequestTracker#runRequest"></a>1、RequestTracker#runRequest</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runRequest</span><span class="params">(<span class="meta">@NonNull</span> Request request)</span> </span>&#123;</span><br><span class="line">  requests.add(request);</span><br><span class="line">  <span class="keyword">if</span> (!isPaused) &#123;</span><br><span class="line">    <span class="comment">// 执行请求</span></span><br><span class="line">    request.begin();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    request.clear();</span><br><span class="line">    <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">      Log.v(TAG, <span class="string">&quot;Paused, delaying request&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    pendingRequests.add(request);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2、SingleRequest-begin"><a href="#2、SingleRequest-begin" class="headerlink" title="2、SingleRequest#begin"></a>2、SingleRequest#begin</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">synchronized</span> (requestLock) &#123;</span><br><span class="line">    assertNotCallingCallbacks();</span><br><span class="line">    stateVerifier.throwIfRecycled();</span><br><span class="line">    startTime = LogTime.getLogTime();</span><br><span class="line">    <span class="comment">// model（url）为空，回调加载失败</span></span><br><span class="line">    <span class="keyword">if</span> (model == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (Util.isValidDimensions(overrideWidth, overrideHeight)) &#123;</span><br><span class="line">        width = overrideWidth;</span><br><span class="line">        height = overrideHeight;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Only log at more verbose log levels if the user has set a fallback drawable, because</span></span><br><span class="line">      <span class="comment">// fallback Drawables indicate the user expects null models occasionally.</span></span><br><span class="line">      <span class="keyword">int</span> logLevel = getFallbackDrawable() == <span class="keyword">null</span> ? Log.WARN : Log.DEBUG;</span><br><span class="line">      onLoadFailed(<span class="keyword">new</span> GlideException(<span class="string">&quot;Received null model&quot;</span>), logLevel);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (status == Status.RUNNING) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Cannot restart a running request&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 缓存图加载成功</span></span><br><span class="line">    <span class="keyword">if</span> (status == Status.COMPLETE) &#123;</span><br><span class="line">      onResourceReady(</span><br><span class="line">          resource, DataSource.MEMORY_CACHE, <span class="comment">/* isLoadedFromAlternateCacheKey= */</span> <span class="keyword">false</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    status = Status.WAITING_FOR_SIZE;</span><br><span class="line">  <span class="comment">//glide 会根据显示图片的宽高进行缓存，所以这里需要获得View的宽高，overrideWidth，overrideHeight默认为-1，所以第一次会到else分支，获取View的宽高</span></span><br><span class="line">    <span class="keyword">if</span> (Util.isValidDimensions(overrideWidth, overrideHeight)) &#123;</span><br><span class="line">      <span class="comment">// 当使用override() API为图片指定了一个固定的宽高时直接执行onSizeReady，</span></span><br><span class="line">      <span class="comment">// 最终的核心处理位于onSizeReady</span></span><br><span class="line">      onSizeReady(overrideWidth, overrideHeight);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 根据imageView的宽高算出图片的宽高，最终也会走到onSizeReady</span></span><br><span class="line">      target.getSize(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((status == Status.RUNNING || status == Status.WAITING_FOR_SIZE)</span><br><span class="line">        &amp;&amp; canNotifyStatusChanged()) &#123;</span><br><span class="line">      <span class="comment">// 预先加载设置的占位图</span></span><br><span class="line">      target.onLoadStarted(getPlaceholderDrawable());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (IS_VERBOSE_LOGGABLE) &#123;</span><br><span class="line">      logV(<span class="string">&quot;finished run method in &quot;</span> + LogTime.getElapsedMillis(startTime));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>真正的请求 是在 onSizeReady 开始的</p>
<h4 id="3、SingleRequest-onSizeReady"><a href="#3、SingleRequest-onSizeReady" class="headerlink" title="3、SingleRequest #onSizeReady"></a>3、SingleRequest #onSizeReady</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">onSizeReady</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (status != Status.WAITING_FOR_SIZE) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//设置状态为正在请求</span></span><br><span class="line">    status = Status.RUNNING;</span><br><span class="line">	<span class="comment">//设置宽高</span></span><br><span class="line">    <span class="keyword">float</span> sizeMultiplier = requestOptions.getSizeMultiplier();</span><br><span class="line">    <span class="keyword">this</span>.width = maybeApplySizeMultiplier(width, sizeMultiplier);</span><br><span class="line">    <span class="keyword">this</span>.height = maybeApplySizeMultiplier(height, sizeMultiplier);</span><br><span class="line">	</span><br><span class="line">	 <span class="comment">//这里的engine 是在创建Glide的时候，build() 创建的，engine封装了各种Executor，内存缓存等</span></span><br><span class="line">    loadStatus =</span><br><span class="line">            engine.load(</span><br><span class="line">                    glideContext,</span><br><span class="line">                    model,</span><br><span class="line">                    requestOptions.getSignature(),</span><br><span class="line">                    <span class="keyword">this</span>.width,</span><br><span class="line">                    <span class="keyword">this</span>.height,</span><br><span class="line">                    requestOptions.getResourceClass(),</span><br><span class="line">                    transcodeClass,</span><br><span class="line">                    priority,</span><br><span class="line">                    requestOptions.getDiskCacheStrategy(),</span><br><span class="line">                    requestOptions.getTransformations(),</span><br><span class="line">                    requestOptions.isTransformationRequired(),</span><br><span class="line">                    requestOptions.isScaleOnlyOrNoTransform(),</span><br><span class="line">                    requestOptions.getOptions(),</span><br><span class="line">                    requestOptions.isMemoryCacheable(),</span><br><span class="line">                    requestOptions.getUseUnlimitedSourceGeneratorsPool(),</span><br><span class="line">                    requestOptions.getUseAnimationPool(),</span><br><span class="line">                    requestOptions.getOnlyRetrieveFromCache(),</span><br><span class="line">                    <span class="keyword">this</span>,</span><br><span class="line">                    callbackExecutor);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This is a hack that&#x27;s only useful for testing right now where loads complete synchronously</span></span><br><span class="line">    <span class="comment">// even though under any executor running on any thread but the main thread, the load would</span></span><br><span class="line">    <span class="comment">// have completed asynchronously.</span></span><br><span class="line">    <span class="keyword">if</span> (status != Status.RUNNING) &#123;</span><br><span class="line">        loadStatus = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-4、Engine-load"><a href="#3-3-4、Engine-load" class="headerlink" title="3.3.4、Engine # load"></a>3.3.4、Engine # load</h3><p>开始图片请求，包含图片的三级缓存机制。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;R&gt; Engine.<span class="function">LoadStatus <span class="title">load</span><span class="params">(GlideContext glideContext, Object model, Key signature, <span class="keyword">int</span> width, <span class="keyword">int</span> height, Class&lt;?&gt; resourceClass, Class&lt;R&gt; transcodeClass, Priority priority, DiskCacheStrategy diskCacheStrategy, Map&lt;Class&lt;?&gt;, Transformation&lt;?&gt;&gt; transformations, <span class="keyword">boolean</span> isTransformationRequired, <span class="keyword">boolean</span> isScaleOnlyOrNoTransform, Options options, <span class="keyword">boolean</span> isMemoryCacheable, <span class="keyword">boolean</span> useUnlimitedSourceExecutorPool, <span class="keyword">boolean</span> useAnimationPool, <span class="keyword">boolean</span> onlyRetrieveFromCache, ResourceCallback cb, Executor callbackExecutor)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> startTime = VERBOSE_IS_LOGGABLE ? LogTime.getLogTime() : <span class="number">0L</span>;</span><br><span class="line">    <span class="comment">// 1、构造缓存的key </span></span><br><span class="line">    EngineKey key = <span class="keyword">this</span>.keyFactory.buildKey(model, signature, width, height, transformations, resourceClass, transcodeClass, options);</span><br><span class="line">    EngineResource memoryResource;</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">         <span class="comment">// 2、查找内存缓存</span></span><br><span class="line">        memoryResource = <span class="keyword">this</span>.loadFromMemory(key, isMemoryCacheable, startTime);</span><br><span class="line">        <span class="keyword">if</span> (memoryResource == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//3、查找磁盘缓存，如果没有通过网络加载</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.waitForExistingOrStartNewJob(glideContext, model, signature, width, height, resourceClass, transcodeClass, priority, diskCacheStrategy, transformations, isTransformationRequired, isScaleOnlyOrNoTransform, options, isMemoryCacheable, useUnlimitedSourceExecutorPool, useAnimationPool, onlyRetrieveFromCache, cb, callbackExecutor, key, startTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cb.onResourceReady(memoryResource, DataSource.MEMORY_CACHE, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-5、内存缓存加载"><a href="#3-3-5、内存缓存加载" class="headerlink" title="3.3.5、内存缓存加载"></a>3.3.5、内存缓存加载</h3><p><code>Engine # loadFromMemory</code>内存缓存分为：</p>
<ol>
<li>弱引用缓存<code>ActiveResources</code>，缓存正在使用中的图片。</li>
<li>内存缓存<code>LruCache</code>， 缓存不在使用中的图片（防止因Lru的策略，图片正在使用，但是被LRU策略回收掉的问题）</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">private</span> EngineResource&lt;?&gt; loadFromMemory(EngineKey key, <span class="keyword">boolean</span> isMemoryCacheable, <span class="keyword">long</span> startTime) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isMemoryCacheable) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="comment">// 1、加载正在使用的缓存（弱引用）</span></span><br><span class="line">        EngineResource&lt;?&gt; active = <span class="keyword">this</span>.loadFromActiveResources(key);</span><br><span class="line">        <span class="keyword">if</span> (active != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (VERBOSE_IS_LOGGABLE) &#123;</span><br><span class="line">                logWithTimeAndKey(<span class="string">&quot;Loaded resource from active resources&quot;</span>, startTime, key);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> active;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="comment">// 2、加载正在使用的缓存（弱引用）</span></span><br><span class="line">            EngineResource&lt;?&gt; cached = <span class="keyword">this</span>.loadFromCache(key);</span><br><span class="line">            <span class="keyword">if</span> (cached != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (VERBOSE_IS_LOGGABLE) &#123;</span><br><span class="line">                    logWithTimeAndKey(<span class="string">&quot;Loaded resource from cache&quot;</span>, startTime, key);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> cached;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="1、加载弱引用缓存"><a href="#1、加载弱引用缓存" class="headerlink" title="1、加载弱引用缓存"></a>1、加载弱引用缓存</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> EngineResource&lt;?&gt; loadFromActiveResources(Key key) &#123;</span><br><span class="line">    EngineResource&lt;?&gt; active = <span class="keyword">this</span>.activeResources.get(key);</span><br><span class="line">    <span class="keyword">if</span> (active != <span class="keyword">null</span>) &#123;</span><br><span class="line">        active.acquire();<span class="comment">// 图片引用计数，&gt;0 说明正在被使用中</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> active;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2、加载Lru-缓存"><a href="#2、加载Lru-缓存" class="headerlink" title="2、加载Lru 缓存"></a>2、加载Lru 缓存</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> EngineResource&lt;?&gt; loadFromCache(Key key) &#123;</span><br><span class="line">    EngineResource&lt;?&gt; cached = <span class="keyword">this</span>.getEngineResourceFromCache(key);</span><br><span class="line">    <span class="keyword">if</span> (cached != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 移动到弱引用缓存，计数 +1</span></span><br><span class="line">        cached.acquire();</span><br><span class="line">        <span class="keyword">this</span>.activeResources.activate(key, cached);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> cached;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> EngineResource&lt;?&gt; getEngineResourceFromCache(Key key) &#123;</span><br><span class="line">    <span class="comment">// 正在使用的从 LRU 移除</span></span><br><span class="line">    Resource&lt;?&gt; cached = <span class="keyword">this</span>.cache.remove(key);</span><br><span class="line">    EngineResource result;</span><br><span class="line">    <span class="keyword">if</span> (cached == <span class="keyword">null</span>) &#123;</span><br><span class="line">        result = <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cached <span class="keyword">instanceof</span> EngineResource) &#123;</span><br><span class="line">        result = (EngineResource)cached;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        result = <span class="keyword">new</span> EngineResource(cached, <span class="keyword">true</span>, <span class="keyword">true</span>, key, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-6、从磁盘或网络加载"><a href="#3-3-6、从磁盘或网络加载" class="headerlink" title="3.3.6、从磁盘或网络加载"></a>3.3.6、从磁盘或网络加载</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;R&gt; Engine.<span class="function">LoadStatus <span class="title">waitForExistingOrStartNewJob</span><span class="params">(GlideContext glideContext, Object model, Key signature, <span class="keyword">int</span> width, <span class="keyword">int</span> height, Class&lt;?&gt; resourceClass, Class&lt;R&gt; transcodeClass, Priority priority, DiskCacheStrategy diskCacheStrategy, Map&lt;Class&lt;?&gt;, Transformation&lt;?&gt;&gt; transformations, <span class="keyword">boolean</span> isTransformationRequired, <span class="keyword">boolean</span> isScaleOnlyOrNoTransform, Options options, <span class="keyword">boolean</span> isMemoryCacheable, <span class="keyword">boolean</span> useUnlimitedSourceExecutorPool, <span class="keyword">boolean</span> useAnimationPool, <span class="keyword">boolean</span> onlyRetrieveFromCache, ResourceCallback cb, Executor callbackExecutor, EngineKey key, <span class="keyword">long</span> startTime)</span> </span>&#123;</span><br><span class="line">    EngineJob&lt;?&gt; current = <span class="keyword">this</span>.jobs.get(key, onlyRetrieveFromCache);</span><br><span class="line">    <span class="keyword">if</span> (current != <span class="keyword">null</span>) &#123;</span><br><span class="line">        current.addCallback(cb, callbackExecutor);</span><br><span class="line">        <span class="keyword">if</span> (VERBOSE_IS_LOGGABLE) &#123;</span><br><span class="line">            logWithTimeAndKey(<span class="string">&quot;Added to existing load&quot;</span>, startTime, key);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Engine.LoadStatus(cb, current);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 创建 engineJob</span></span><br><span class="line">        EngineJob&lt;R&gt; engineJob = <span class="keyword">this</span>.engineJobFactory.build(key, isMemoryCacheable, useUnlimitedSourceExecutorPool, useAnimationPool, onlyRetrieveFromCache);</span><br><span class="line">        <span class="comment">// 解码的Job</span></span><br><span class="line">        DecodeJob&lt;R&gt; decodeJob = <span class="keyword">this</span>.decodeJobFactory.build(glideContext, model, key, signature, width, height, resourceClass, transcodeClass, priority, diskCacheStrategy, transformations, isTransformationRequired, isScaleOnlyOrNoTransform, onlyRetrieveFromCache, options, engineJob);</span><br><span class="line">        <span class="comment">// 放在Jobs内部维护的HashMap中</span></span><br><span class="line">        <span class="keyword">this</span>.jobs.put(key, engineJob);</span><br><span class="line">       <span class="comment">// 注册ResourceCallback接口，就是在成功获取图片后，需要显示到ImageView 上的回调，这个接口回调到SingleRequest 中</span></span><br><span class="line">        engineJob.addCallback(cb, callbackExecutor);</span><br><span class="line">        <span class="comment">// 开始执行</span></span><br><span class="line">        engineJob.start(decodeJob);</span><br><span class="line">        <span class="keyword">if</span> (VERBOSE_IS_LOGGABLE) &#123;</span><br><span class="line">            logWithTimeAndKey(<span class="string">&quot;Started new load&quot;</span>, startTime, key);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Engine.LoadStatus(cb, engineJob);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1、EngineJob-start"><a href="#1、EngineJob-start" class="headerlink" title="1、EngineJob#start"></a>1、EngineJob#start</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(DecodeJob&lt;R&gt; decodeJob)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.decodeJob = decodeJob;</span><br><span class="line">    <span class="comment">//若能从磁盘缓存获取数据，就使用diskCacheExecutor</span></span><br><span class="line">    <span class="comment">//否则在根据其他的条件判断使用哪个Executor</span></span><br><span class="line">    GlideExecutor executor = decodeJob.willDecodeFromCache()</span><br><span class="line">            ? diskCacheExecutor</span><br><span class="line">            : getActiveSourceExecutor();</span><br><span class="line">    <span class="comment">// 执行 decodeJob</span></span><br><span class="line">    executor.execute(decodeJob);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2、EngineJob-willDecodeFromCache"><a href="#2、EngineJob-willDecodeFromCache" class="headerlink" title="2、EngineJob#willDecodeFromCache"></a>2、EngineJob#willDecodeFromCache</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">willDecodeFromCache</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//先看下面的getNextStage 分析</span></span><br><span class="line">    Stage firstStage = getNextStage(Stage.INITIALIZE);</span><br><span class="line">    <span class="comment">//那这里就很明了了，如果可以从磁盘缓存读取，就返回true</span></span><br><span class="line">    <span class="keyword">return</span> firstStage == Stage.RESOURCE_CACHE || firstStage == Stage.DATA_CACHE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3、EngineJob-getNextStage"><a href="#3、EngineJob-getNextStage" class="headerlink" title="3、EngineJob#getNextStage"></a>3、EngineJob#getNextStage</h4><p>获取下一个阶段，应该从哪里获取数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Stage <span class="title">getNextStage</span><span class="params">(Stage current)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (current) &#123;</span><br><span class="line">        <span class="keyword">case</span> INITIALIZE:</span><br><span class="line">        <span class="comment">//当前是初始阶段，则看磁盘缓存策略，是否可以在磁盘中获取资源缓存（也就是解析后的缓存）</span></span><br><span class="line">            <span class="keyword">return</span> diskCacheStrategy.decodeCachedResource()</span><br><span class="line">                    ? Stage.RESOURCE_CACHE : getNextStage(Stage.RESOURCE_CACHE);</span><br><span class="line">        <span class="keyword">case</span> RESOURCE_CACHE:</span><br><span class="line">        <span class="comment">//当前是资源缓存，看下一步能不能从磁盘缓存中获取源数据缓存</span></span><br><span class="line">            <span class="keyword">return</span> diskCacheStrategy.decodeCachedData()</span><br><span class="line">                    ? Stage.DATA_CACHE : getNextStage(Stage.DATA_CACHE);</span><br><span class="line">        <span class="keyword">case</span> DATA_CACHE:</span><br><span class="line">            <span class="comment">// Skip loading from source if the user opted to only retrieve the resource from cache.</span></span><br><span class="line">            <span class="comment">//当前是数据缓存，下一步能不能从源数据处获取数据，例如从服务器获取</span></span><br><span class="line">            <span class="keyword">return</span> onlyRetrieveFromCache ? Stage.FINISHED : Stage.SOURCE;</span><br><span class="line">        <span class="keyword">case</span> SOURCE:</span><br><span class="line">        <span class="keyword">case</span> FINISHED:</span><br><span class="line">            <span class="keyword">return</span> Stage.FINISHED;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Unrecognized stage: &quot;</span> + current);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4、DecodeJob-runWrapped"><a href="#4、DecodeJob-runWrapped" class="headerlink" title="4、DecodeJob#runWrapped"></a>4、DecodeJob#runWrapped</h4><p>DecodeJob 实现了Runnable接口，真正执行的是runWrapped。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.isCancelled) &#123;</span><br><span class="line">            <span class="keyword">this</span>.runWrapped();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化之后第一次运行时 runReason 为 INITIALIZE</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">runWrapped</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    runWrappedCount++;</span><br><span class="line">    <span class="keyword">switch</span> (runReason) &#123;</span><br><span class="line">        <span class="keyword">case</span> INITIALIZE:</span><br><span class="line">            <span class="comment">//初始化之后第一次运行时, stage 返回的是source</span></span><br><span class="line">            stage = getNextStage(Stage.INITIALIZE);</span><br><span class="line">            <span class="comment">//根据下一阶段状态，判断具体由哪个类执行，source 对应是 SourceGenerator</span></span><br><span class="line">            currentGenerator = getNextGenerator();</span><br><span class="line">            runGenerators();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SWITCH_TO_SOURCE_SERVICE:</span><br><span class="line">            runGenerators();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DECODE_DATA:</span><br><span class="line">            decodeFromRetrievedData();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Unrecognized run reason: &quot;</span> + runReason);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> DataFetcherGenerator <span class="title">getNextGenerator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (stage) &#123;</span><br><span class="line">        <span class="comment">//从磁盘缓存获取资源数据</span></span><br><span class="line">        <span class="keyword">case</span> RESOURCE_CACHE:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ResourceCacheGenerator(decodeHelper, <span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">//从磁盘缓存获取源数据</span></span><br><span class="line">        <span class="keyword">case</span> DATA_CACHE:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> DataCacheGenerator(decodeHelper, <span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">//从数据源获取数据，例如 从服务器获取数据</span></span><br><span class="line">        <span class="keyword">case</span> SOURCE:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SourceGenerator(decodeHelper, <span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">case</span> FINISHED:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Unrecognized stage: &quot;</span> + stage);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 采用用网络加载时这里的 Generator 是<code>SourceGenerator</code> ；采用缓存加载时是另外2个。</p>
<h4 id="5、DecodeJob-runGenerators"><a href="#5、DecodeJob-runGenerators" class="headerlink" title="5、DecodeJob#runGenerators"></a>5、DecodeJob#runGenerators</h4><p><code>currentGenerator.startNext()</code>加载数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">runGenerators</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.currentThread = Thread.currentThread();</span><br><span class="line">    <span class="keyword">this</span>.startFetchTime = LogTime.getLogTime();</span><br><span class="line">    <span class="keyword">boolean</span> isStarted = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(!<span class="keyword">this</span>.isCancelled &amp;&amp; <span class="keyword">this</span>.currentGenerator != <span class="keyword">null</span> &amp;&amp; !(isStarted =                                                                   <span class="keyword">this</span>.currentGenerator.startNext())) &#123; <span class="comment">// 加载数据</span></span><br><span class="line">        <span class="keyword">this</span>.stage = <span class="keyword">this</span>.getNextStage(<span class="keyword">this</span>.stage);</span><br><span class="line">        <span class="keyword">this</span>.currentGenerator = <span class="keyword">this</span>.getNextGenerator();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.stage == DecodeJob.Stage.SOURCE) &#123;</span><br><span class="line">            <span class="keyword">this</span>.reschedule();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">this</span>.stage == DecodeJob.Stage.FINISHED || <span class="keyword">this</span>.isCancelled) &amp;&amp; !isStarted) &#123;</span><br><span class="line">        <span class="keyword">this</span>.notifyFailed();</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h3 id="3-3-7、数据加载和回调"><a href="#3-3-7、数据加载和回调" class="headerlink" title="3.3.7、数据加载和回调"></a>3.3.7、数据加载和回调</h3><h4 id="1、SourceGenerator-startNext"><a href="#1、SourceGenerator-startNext" class="headerlink" title="1、SourceGenerator#startNext"></a>1、SourceGenerator#startNext</h4><p><code>startNext</code> 主要分为2步：</p>
<ol>
<li>获取合适的<code>LoadData</code>（里面封装了 DataFetche 包含我们在 GlideModule 中注册的ModelLoader</li>
<li>使用 DataFetcher 加载数据，这里的DataFetcher 就是 <code>HttpUrlFetcher</code></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">startNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (dataToCache != <span class="keyword">null</span>) &#123;</span><br><span class="line">    Object data = dataToCache;</span><br><span class="line">    dataToCache = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 缓存原始数据</span></span><br><span class="line">    cacheData(data);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (sourceCacheGenerator != <span class="keyword">null</span> &amp;&amp; sourceCacheGenerator.startNext()) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  sourceCacheGenerator = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  loadData = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">boolean</span> started = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">while</span> (!started &amp;&amp; hasNextModelLoader()) &#123;</span><br><span class="line">    <span class="comment">//helper.getLoadData() 获取所有符合条件的ModelLoader，这些ModelLoader 包括默认的和自定义的</span></span><br><span class="line">           <span class="comment">// 这里的符合条件，也就是ModelLoader 中的handles函数是否返回true，再说直白点，就是判断在load()传入的对象类型，是否可以被ModelLoader所处理</span></span><br><span class="line">    loadData = helper.getLoadData().get(loadDataListIndex++);</span><br><span class="line">    <span class="keyword">if</span> (loadData != <span class="keyword">null</span></span><br><span class="line">        &amp;&amp; (helper.getDiskCacheStrategy().isDataCacheable(loadData.fetcher.getDataSource())</span><br><span class="line">            || helper.hasLoadPath(loadData.fetcher.getDataClass()))) &#123;</span><br><span class="line">      started = <span class="keyword">true</span>;</span><br><span class="line">      <span class="comment">//通过LoadData对象内部的 fetcher ，来进行实际的请求操作（例如发起网络请求）</span></span><br><span class="line">      startNextLoad(loadData);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> started;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2、SourceGenerator-startNextLoad"><a href="#2、SourceGenerator-startNextLoad" class="headerlink" title="2、SourceGenerator#startNextLoad"></a>2、SourceGenerator#startNextLoad</h4><p><code>SourceGenerator#startNextLoad</code>包含了数据加载和回调过程。这里的fetcher 是<code>HttpUrlFetcher</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startNextLoad</span><span class="params">(<span class="keyword">final</span> LoadData&lt;?&gt; toStart)</span> </span>&#123;</span><br><span class="line">  loadData.fetcher.loadData(</span><br><span class="line">      helper.getPriority(),</span><br><span class="line">      <span class="keyword">new</span> DataCallback&lt;Object&gt;() &#123;<span class="comment">//传入回调的callback</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDataReady</span><span class="params">(<span class="meta">@Nullable</span> Object data)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (isCurrentRequest(toStart)) &#123;</span><br><span class="line">            onDataReadyInternal(toStart, data);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLoadFailed</span><span class="params">(<span class="meta">@NonNull</span> Exception e)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (isCurrentRequest(toStart)) &#123;</span><br><span class="line">            onLoadFailedInternal(toStart, e);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3、HttpUrlFetcher-loadData"><a href="#3、HttpUrlFetcher-loadData" class="headerlink" title="3、HttpUrlFetcher#loadData"></a>3、HttpUrlFetcher#loadData</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadData</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="meta">@NonNull</span> Priority priority, <span class="meta">@NonNull</span> DataCallback&lt;? <span class="keyword">super</span> InputStream&gt; callback)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">long</span> startTime = LogTime.getLogTime();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 1、请求网络数据</span></span><br><span class="line">    InputStream result = loadDataWithRedirects(glideUrl.toURL(), <span class="number">0</span>, <span class="keyword">null</span>, glideUrl.getHeaders());</span><br><span class="line">    <span class="comment">// 2、进行回调</span></span><br><span class="line">    callback.onDataReady(result);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</span><br><span class="line">      Log.d(TAG, <span class="string">&quot;Failed to load data for url&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    callback.onLoadFailed(e);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">      Log.v(TAG, <span class="string">&quot;Finished http url fetcher fetch in &quot;</span> + LogTime.getElapsedMillis(startTime));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> InputStream <span class="title">loadDataWithRedirects</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    URL url, <span class="keyword">int</span> redirects, URL lastUrl, Map&lt;String, String&gt; headers)</span> <span class="keyword">throws</span> HttpException </span>&#123;</span><br><span class="line">  <span class="comment">// 重定向次数限制</span></span><br><span class="line">  <span class="keyword">if</span> (redirects &gt;= MAXIMUM_REDIRECTS) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(</span><br><span class="line">        <span class="string">&quot;Too many (&gt; &quot;</span> + MAXIMUM_REDIRECTS + <span class="string">&quot;) redirects!&quot;</span>, INVALID_STATUS_CODE);</span><br><span class="line">  &#125; </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  urlConnection = buildAndConfigureConnection(url, headers);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// Connect explicitly to avoid errors in decoders if connection fails.</span></span><br><span class="line">    urlConnection.connect();</span><br><span class="line">    <span class="comment">// Set the stream so that it&#x27;s closed in cleanup to avoid resource leaks. See #2352.</span></span><br><span class="line">    stream = urlConnection.getInputStream();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(</span><br><span class="line">        <span class="string">&quot;Failed to connect or obtain data&quot;</span>, getHttpStatusCodeOrInvalid(urlConnection), e);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isCancelled) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> statusCode = getHttpStatusCodeOrInvalid(urlConnection);</span><br><span class="line">  <span class="keyword">if</span> (isHttpOk(statusCode)) &#123;</span><br><span class="line">    <span class="keyword">return</span> getStreamForSuccessfulRequest(urlConnection);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isHttpRedirect(statusCode)) &#123;</span><br><span class="line">    String redirectUrlString = urlConnection.getHeaderField(REDIRECT_HEADER_FIELD);</span><br><span class="line">    <span class="keyword">if</span> (TextUtils.isEmpty(redirectUrlString)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(<span class="string">&quot;Received empty or null redirect url&quot;</span>, statusCode);</span><br><span class="line">    &#125;</span><br><span class="line">    URL redirectUrl;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      redirectUrl = <span class="keyword">new</span> URL(url, redirectUrlString);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (MalformedURLException e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(<span class="string">&quot;Bad redirect url: &quot;</span> + redirectUrlString, statusCode, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Closing the stream specifically is required to avoid leaking ResponseBodys in addition</span></span><br><span class="line">    <span class="comment">// to disconnecting the url connection below. See #2352.</span></span><br><span class="line">    cleanup();</span><br><span class="line">    <span class="comment">// 递归,多次重定向</span></span><br><span class="line">    <span class="keyword">return</span> loadDataWithRedirects(redirectUrl, redirects + <span class="number">1</span>, url, headers);</span><br><span class="line">  &#125; </span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-8、数据回调过程"><a href="#3-3-8、数据回调过程" class="headerlink" title="3.3.8、数据回调过程"></a>3.3.8、数据回调过程</h3><h4 id="1、SourceGenerator-onDataReady"><a href="#1、SourceGenerator-onDataReady" class="headerlink" title="1、SourceGenerator#onDataReady"></a>1、SourceGenerator#onDataReady</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startNextLoad</span><span class="params">(<span class="keyword">final</span> LoadData&lt;?&gt; toStart)</span> </span>&#123;</span><br><span class="line">  loadData.fetcher.loadData(</span><br><span class="line">      helper.getPriority(),</span><br><span class="line">      <span class="keyword">new</span> DataCallback&lt;Object&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDataReady</span><span class="params">(<span class="meta">@Nullable</span> Object data)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (isCurrentRDEequest(toStart)) &#123;</span><br><span class="line">            onDataReadyInternal(toStart, data);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLoadFailed</span><span class="params">(<span class="meta">@NonNull</span> Exception e)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (isCurrentRequest(toStart)) &#123;</span><br><span class="line">            onLoadFailedInternal(toStart, e);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">onDataReadyInternal</span><span class="params">(LoadData&lt;?&gt; loadData, Object data)</span> </span>&#123;</span><br><span class="line">  DiskCacheStrategy diskCacheStrategy = helper.getDiskCacheStrategy();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (data != <span class="keyword">null</span> &amp;&amp; diskCacheStrategy.isDataCacheable(loadData.fetcher.getDataSource())) &#123;</span><br><span class="line">    <span class="comment">//如果该数据类型，有启用磁盘缓存，就把值付给dataToCache </span></span><br><span class="line">    dataToCache = data;</span><br><span class="line">   <span class="comment">//调用DecodeJob的reschedule，用线程池执行任务，实际上就是再次调用SourceGenerator的startNext</span></span><br><span class="line">    cb.reschedule();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 没有启用调用到DecodeJob中，我们先看没有开启磁盘缓存的过程</span></span><br><span class="line">    cb.onDataFetcherReady(</span><br><span class="line">        loadData.sourceKey,</span><br><span class="line">        data,</span><br><span class="line">        loadData.fetcher,</span><br><span class="line">        loadData.fetcher.getDataSource(),</span><br><span class="line">        originalKey);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2、DecodeJob-onDataFetcherReady"><a href="#2、DecodeJob-onDataFetcherReady" class="headerlink" title="2、DecodeJob#onDataFetcherReady"></a>2、DecodeJob#onDataFetcherReady</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDataFetcherReady</span><span class="params">(Key sourceKey, Object data, DataFetcher&lt;?&gt; fetcher, DataSource dataSource, Key attemptedKey)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.currentSourceKey = sourceKey;</span><br><span class="line">    <span class="keyword">this</span>.currentData = data;</span><br><span class="line">    <span class="keyword">this</span>.currentFetcher = fetcher;</span><br><span class="line">    <span class="keyword">this</span>.currentDataSource = dataSource;</span><br><span class="line">    <span class="keyword">this</span>.currentAttemptingKey = attemptedKey;</span><br><span class="line">    <span class="keyword">this</span>.isLoadingFromAlternateCacheKey = sourceKey != <span class="keyword">this</span>.decodeHelper.getCacheKeys().get(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (Thread.currentThread() != <span class="keyword">this</span>.currentThread) &#123;</span><br><span class="line">        <span class="keyword">this</span>.runReason = DecodeJob.RunReason.DECODE_DATA;</span><br><span class="line">        <span class="keyword">this</span>.callback.reschedule(<span class="keyword">this</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        GlideTrace.beginSection(<span class="string">&quot;DecodeJob.decodeFromRetrievedData&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 解码过程</span></span><br><span class="line">            <span class="keyword">this</span>.decodeFromRetrievedData();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            GlideTrace.endSection();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3、DecodeJob-decodeFromRetrievedData"><a href="#3、DecodeJob-decodeFromRetrievedData" class="headerlink" title="3、DecodeJob#decodeFromRetrievedData"></a>3、DecodeJob#decodeFromRetrievedData</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">decodeFromRetrievedData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Log.isLoggable(<span class="string">&quot;DecodeJob&quot;</span>, <span class="number">2</span>)) &#123;</span><br><span class="line">        <span class="keyword">this</span>.logWithTimeAndKey(<span class="string">&quot;Retrieved data&quot;</span>, <span class="keyword">this</span>.startFetchTime, <span class="string">&quot;data: &quot;</span> + <span class="keyword">this</span>.currentData + <span class="string">&quot;, cache key: &quot;</span> + <span class="keyword">this</span>.currentSourceKey + <span class="string">&quot;, fetcher: &quot;</span> + <span class="keyword">this</span>.currentFetcher);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Resource resource = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    		<span class="comment">// 1.从数据中解码得到资源，这个3.3.10讲</span></span><br><span class="line">        resource = <span class="keyword">this</span>.decodeFromData(<span class="keyword">this</span>.currentFetcher, <span class="keyword">this</span>.currentData, <span class="keyword">this</span>.currentDataSource);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (GlideException var3) &#123;</span><br><span class="line">        var3.setLoggingDetails(<span class="keyword">this</span>.currentAttemptingKey, <span class="keyword">this</span>.currentDataSource);</span><br><span class="line">        <span class="keyword">this</span>.throwables.add(var3);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (resource != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 2.通知编码和发布，最终得到的Resource&lt;Bitmap&gt;对象，第24步</span></span><br><span class="line">        <span class="keyword">this</span>.notifyEncodeAndRelease(resource, <span class="keyword">this</span>.currentDataSource, <span class="keyword">this</span>.isLoadingFromAlternateCacheKey);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.runGenerators();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4、DecodeJob-notifyEncodeAndRelease"><a href="#4、DecodeJob-notifyEncodeAndRelease" class="headerlink" title="4、DecodeJob#notifyEncodeAndRelease"></a>4、DecodeJob#notifyEncodeAndRelease</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyEncodeAndRelease</span><span class="params">(Resource&lt;R&gt; resource, DataSource dataSource)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (resource <span class="keyword">instanceof</span> Initializable) &#123;</span><br><span class="line">            ((Initializable) resource).initialize();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Resource&lt;R&gt; result = resource;</span><br><span class="line">        LockedResource&lt;R&gt; lockedResource = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (deferredEncodeManager.hasResourceToEncode()) &#123;</span><br><span class="line">            lockedResource = LockedResource.obtain(resource);</span><br><span class="line">            result = lockedResource;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 1、通知主线程回调，加载图片</span></span><br><span class="line">        notifyComplete(result, dataSource);</span><br><span class="line">        <span class="comment">// 更新状态为编码</span></span><br><span class="line">        stage = Stage.ENCODE;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//2、缓存转换后的图片</span></span><br><span class="line">            <span class="keyword">if</span> (deferredEncodeManager.hasResourceToEncode()) &#123;</span><br><span class="line">                <span class="comment">//磁盘缓存入口</span></span><br><span class="line">                deferredEncodeManager.encode(diskCacheProvider, options);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (lockedResource != <span class="keyword">null</span>) &#123;</span><br><span class="line">                lockedResource.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Call onEncodeComplete outside the finally block so that it&#x27;s not called if the encode process</span></span><br><span class="line">        <span class="comment">// throws.</span></span><br><span class="line">        <span class="comment">// 资源释放</span></span><br><span class="line">        onEncodeComplete();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="5、EngineJob-notifyComplete"><a href="#5、EngineJob-notifyComplete" class="headerlink" title="5、EngineJob#notifyComplete"></a>5、EngineJob#notifyComplete</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyComplete</span><span class="params">(Resource&lt;R&gt; resource, DataSource dataSource, <span class="keyword">boolean</span> isLoadedFromAlternateCacheKey)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.setNotifiedOrThrow();</span><br><span class="line">    <span class="comment">// 这个callback 是 EngineJob对象</span></span><br><span class="line">    <span class="keyword">this</span>.callback.onResourceReady(resource, dataSource, isLoadedFromAlternateCacheKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="6、EngineJob-onResourceReady"><a href="#6、EngineJob-onResourceReady" class="headerlink" title="6、EngineJob#onResourceReady"></a>6、EngineJob#onResourceReady</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResourceReady</span><span class="params">(Resource&lt;R&gt; resource, DataSource dataSource)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.resource = resource;</span><br><span class="line">        <span class="keyword">this</span>.dataSource = dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">    notifyCallbacksOfResult();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="7、EngineJob-notifyCallbacksOfResult"><a href="#7、EngineJob-notifyCallbacksOfResult" class="headerlink" title="7、EngineJob#notifyCallbacksOfResult"></a>7、EngineJob#notifyCallbacksOfResult</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">notifyCallbacksOfResult</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ResourceCallbacksAndExecutors copy;</span><br><span class="line">  Key localKey;</span><br><span class="line">  EngineResource&lt;?&gt; localResource;</span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">		</span><br><span class="line">    engineResource = engineResourceFactory.build(resource, isCacheable, key, resourceListener);</span><br><span class="line">    <span class="comment">// ... </span></span><br><span class="line">    hasResource = <span class="keyword">true</span>;</span><br><span class="line">    copy = cbs.copy();</span><br><span class="line">    incrementPendingCallbacks(copy.size() + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    localKey = key;</span><br><span class="line">    localResource = engineResource;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//这里就是把解析后的图片，也就是即将要显示出来的图片，缓存到弱引用缓存中</span></span><br><span class="line">  engineJobListener.onEngineJobComplete(<span class="keyword">this</span>, localKey, localResource);</span><br><span class="line"></span><br><span class="line">   <span class="comment">//遍历每一个回调接口，entry.cb 就是SingleRequest 对象，执行接口ResourceCallback</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">final</span> ResourceCallbackAndExecutor entry : copy) &#123;</span><br><span class="line">    entry.executor.execute(<span class="keyword">new</span> CallResourceReady(entry.cb));</span><br><span class="line">  &#125;</span><br><span class="line">  decrementPendingCallbacks();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="8、内部类CallResourceReady-run"><a href="#8、内部类CallResourceReady-run" class="headerlink" title="8、内部类CallResourceReady # run"></a>8、内部类CallResourceReady # run</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (EngineJob.<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cbs.contains(cb)) &#123;</span><br><span class="line">		...</span><br><span class="line">		<span class="comment">//执行回调</span></span><br><span class="line">            callCallbackOnResourceReady(cb);</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">       ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">callCallbackOnResourceReady</span><span class="params">(ResourceCallback cb)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">//cb 就是SingleRequest 对象，所以下面去它里面看onResourceReady</span></span><br><span class="line">	</span><br><span class="line">        cb.onResourceReady(engineResource, dataSource);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> CallbackException(t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="9、SingleRequest-onResourceReady"><a href="#9、SingleRequest-onResourceReady" class="headerlink" title="9、SingleRequest#onResourceReady"></a>9、SingleRequest#onResourceReady</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResourceReady</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    Resource&lt;?&gt; resource, DataSource dataSource, <span class="keyword">boolean</span> isLoadedFromAlternateCacheKey)</span> </span>&#123;</span><br><span class="line">  stateVerifier.throwIfRecycled();</span><br><span class="line">  Resource&lt;?&gt; toRelease = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (requestLock) &#123;</span><br><span class="line"> 				</span><br><span class="line">			<span class="comment">//...</span></span><br><span class="line">      onResourceReady(</span><br><span class="line">          (Resource&lt;R&gt;) resource, (R) received, dataSource, isLoadedFromAlternateCacheKey);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (toRelease != <span class="keyword">null</span>) &#123;</span><br><span class="line">      engine.release(toRelease);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onResourceReady</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    Resource&lt;R&gt; resource, R result, DataSource dataSource, <span class="keyword">boolean</span> isAlternateCacheKey)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// We must call isFirstReadyResource before setting status.</span></span><br><span class="line">  <span class="keyword">boolean</span> isFirstResource = isFirstReadyResource();</span><br><span class="line">  status = Status.COMPLETE;</span><br><span class="line">  <span class="keyword">this</span>.resource = resource;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  isCallingCallbacks = <span class="keyword">true</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">      <span class="comment">// 这个target 是DrawableImageViewTarget</span></span><br><span class="line">      target.onResourceReady(result, animation);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    isCallingCallbacks = <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  notifyLoadSuccess();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-9、-设置图像到View"><a href="#3-3-9、-设置图像到View" class="headerlink" title="3.3.9、 设置图像到View"></a>3.3.9、 设置图像到View</h3><p><code>DrawableImageViewTarget</code>继承自<code>ImageViewTarget</code>，调用到的是<code>ImageViewTarget</code>的方法</p>
<h4 id="1、ImageViewTarget-onResourceReady"><a href="#1、ImageViewTarget-onResourceReady" class="headerlink" title="1、ImageViewTarget#onResourceReady"></a>1、ImageViewTarget#onResourceReady</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResourceReady</span><span class="params">(<span class="meta">@NonNull</span> Z resource, <span class="meta">@Nullable</span> Transition&lt;? <span class="keyword">super</span> Z&gt; transition)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (transition == <span class="keyword">null</span> || !transition.transition(resource, <span class="keyword">this</span>)) &#123;</span><br><span class="line">    <span class="comment">// 调用到set方法</span></span><br><span class="line">    setResourceInternal(resource);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    maybeUpdateAnimatable(resource);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setResourceInternal</span><span class="params">(<span class="meta">@Nullable</span> Z resource)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 设置图像到view</span></span><br><span class="line">  setResource(resource);</span><br><span class="line">  maybeUpdateAnimatable(resource);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">setResource</span><span class="params">(<span class="meta">@Nullable</span> Z resource)</span></span>;</span><br></pre></td></tr></table></figure>

<h4 id="2、DrawableImageViewTarget-setResource"><a href="#2、DrawableImageViewTarget-setResource" class="headerlink" title="2、DrawableImageViewTarget#setResource"></a>2、DrawableImageViewTarget#setResource</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setResource</span><span class="params">(<span class="meta">@Nullable</span> Drawable resource)</span> </span>&#123;</span><br><span class="line">  view.setImageDrawable(resource);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此Glide仅使用网络数据加载流程就分析结束了。下面补充下解码和缓存和图片转换的过程。</p>
<h3 id="3-3-10、数据解码为图片过程"><a href="#3-3-10、数据解码为图片过程" class="headerlink" title="3.3.10、数据解码为图片过程"></a>3.3.10、数据解码为图片过程</h3><p>上面流程中，我们跳过了图片转换过程，这里补充下。代码入口是在：</p>
<h4 id="1、DecodeJob-decodeFromData"><a href="#1、DecodeJob-decodeFromData" class="headerlink" title="1、DecodeJob#decodeFromData"></a>1、DecodeJob#decodeFromData</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;Data&gt; <span class="function">Resource&lt;R&gt; <span class="title">decodeFromData</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    DataFetcher&lt;?&gt; fetcher, Data data, DataSource dataSource)</span> <span class="keyword">throws</span> GlideException </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (data == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">long</span> startTime = LogTime.getLogTime();</span><br><span class="line">    Resource&lt;R&gt; result = decodeFromFetcher(data, dataSource);</span><br><span class="line">    <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">      logWithTimeAndKey(<span class="string">&quot;Decoded result &quot;</span> + result, startTime);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    fetcher.cleanup();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> &lt;Data&gt; <span class="function">Resource&lt;R&gt; <span class="title">decodeFromFetcher</span><span class="params">(Data data, DataSource dataSource)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> GlideException </span>&#123;</span><br><span class="line">  LoadPath&lt;Data, ?, R&gt; path = decodeHelper.getLoadPath((Class&lt;Data&gt;) data.getClass());</span><br><span class="line">  <span class="keyword">return</span> runLoadPath(data, dataSource, path);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2、DecodeJob-runLoadPath"><a href="#2、DecodeJob-runLoadPath" class="headerlink" title="2、DecodeJob#runLoadPath"></a>2、DecodeJob#runLoadPath</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;Data, ResourceType&gt; <span class="function">Resource&lt;R&gt; <span class="title">runLoadPath</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    Data data, DataSource dataSource, LoadPath&lt;Data, ResourceType, R&gt; path)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> GlideException </span>&#123;</span><br><span class="line">  Options options = getOptionsWithHardwareConfig(dataSource);</span><br><span class="line">  DataRewinder&lt;Data&gt; rewinder = glideContext.getRegistry().getRewinder(data);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// ResourceType in DecodeCallback below is required for compilation to work with gradle.</span></span><br><span class="line">    <span class="keyword">return</span> path.load(</span><br><span class="line">        rewinder, options, width, height, <span class="keyword">new</span> DecodeCallback&lt;ResourceType&gt;(dataSource));</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    rewinder.cleanup();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Resource&lt;Transcode&gt; <span class="title">load</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    DataRewinder&lt;Data&gt; rewinder,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="meta">@NonNull</span> Options options,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">int</span> width,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">int</span> height,</span></span></span><br><span class="line"><span class="params"><span class="function">    DecodePath.DecodeCallback&lt;ResourceType&gt; decodeCallback)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> GlideException </span>&#123;</span><br><span class="line">  List&lt;Throwable&gt; throwables = Preconditions.checkNotNull(listPool.acquire());</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> loadWithExceptionList(rewinder, options, width, height, decodeCallback, throwables);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    listPool.release(throwables);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Resource&lt;Transcode&gt; <span class="title">loadWithExceptionList</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    DataRewinder&lt;Data&gt; rewinder,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="meta">@NonNull</span> Options options,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">int</span> width,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">int</span> height,</span></span></span><br><span class="line"><span class="params"><span class="function">    DecodePath.DecodeCallback&lt;ResourceType&gt; decodeCallback,</span></span></span><br><span class="line"><span class="params"><span class="function">    List&lt;Throwable&gt; exceptions)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> GlideException </span>&#123;</span><br><span class="line">  Resource&lt;Transcode&gt; result = <span class="keyword">null</span>;</span><br><span class="line">  <span class="comment">//noinspection ForLoopReplaceableByForEach to improve perf</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, size = decodePaths.size(); i &lt; size; i++) &#123;</span><br><span class="line">    DecodePath&lt;Data, ResourceType, Transcode&gt; path = decodePaths.get(i);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      result = path.decode(rewinder, width, height, options, decodeCallback);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (GlideException e) &#123;</span><br><span class="line">      exceptions.add(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> GlideException(failureMessage, <span class="keyword">new</span> ArrayList&lt;&gt;(exceptions));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3、DecodePath-decode"><a href="#3、DecodePath-decode" class="headerlink" title="3、DecodePath#decode"></a>3、DecodePath#decode</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Resource&lt;Transcode&gt; <span class="title">decode</span><span class="params">(DataRewinder&lt;DataType&gt; rewinder, <span class="keyword">int</span> width, <span class="keyword">int</span> height,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="meta">@NonNull</span> Options options, DecodeCallback&lt;ResourceType&gt; callback)</span> <span class="keyword">throws</span> GlideException </span>&#123;</span><br><span class="line">    <span class="comment">//解码                              </span></span><br><span class="line">    Resource&lt;ResourceType&gt; decoded = decodeResource(rewinder, width, height, options);</span><br><span class="line">    <span class="comment">// 这个方法是回调到Decodejob.onResourceDecoded ,作用是调用RequestOptions中的Transform处理图片，然后将ResourceCache的Key和Encode准备好（放在变量 deferEncoderManager中），稍后进行写入缓存。</span></span><br><span class="line">    Resource&lt;ResourceType&gt; transformed = callback.onResourceDecoded(decoded);</span><br><span class="line">    <span class="comment">//图片的转码过程，进行数据类型的转换</span></span><br><span class="line">    <span class="keyword">return</span> transcoder.transcode(transformed, options);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Resource&lt;ResourceType&gt; <span class="title">decodeResourceWithList</span><span class="params">(DataRewinder&lt;DataType&gt; rewinder, <span class="keyword">int</span> width,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                      <span class="keyword">int</span> height, <span class="meta">@NonNull</span> Options options, List&lt;Throwable&gt; exceptions)</span> <span class="keyword">throws</span> GlideException </span>&#123;</span><br><span class="line">    Resource&lt;ResourceType&gt; result = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//noinspection ForLoopReplaceableByForEach to improve perf</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, size = decoders.size(); i &lt; size; i++) &#123;</span><br><span class="line">        ResourceDecoder&lt;DataType, ResourceType&gt; decoder = decoders.get(i);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            DataType data = rewinder.rewindAndGet();</span><br><span class="line">            <span class="keyword">if</span> (decoder.handles(data, options)) &#123;</span><br><span class="line">                data = rewinder.rewindAndGet();</span><br><span class="line">                <span class="comment">//根据DataType和ResourceType的类型分发给不同的解码器Decoder     </span></span><br><span class="line">                result = decoder.decode(data, width, height, options);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>decode是一个ResourceDecoder接口（资源解码器），根据不同的DataType和ResourceType它会有不同的实现类，这里的实现类是ByteBufferBitmapDecoder，下面看看它的decode 流程</p>
<h4 id="4、ByteBufferBitmapDecoder-decode"><a href="#4、ByteBufferBitmapDecoder-decode" class="headerlink" title="4、ByteBufferBitmapDecoder # decode"></a>4、ByteBufferBitmapDecoder # decode</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Resource&lt;Bitmap&gt; <span class="title">decode</span><span class="params">(<span class="meta">@NonNull</span> ByteBuffer source, <span class="keyword">int</span> width, <span class="keyword">int</span> height,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="meta">@NonNull</span> Options options)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  InputStream is = ByteBufferUtil.toStream(source);</span><br><span class="line">  <span class="keyword">return</span> downsampler.decode(is, width, height, options);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="5、DownSampler-decode"><a href="#5、DownSampler-decode" class="headerlink" title="5、DownSampler#decode"></a>5、DownSampler#decode</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Resource&lt;Bitmap&gt; <span class="title">decode</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    ImageReader imageReader,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">int</span> requestedWidth,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">int</span> requestedHeight,</span></span></span><br><span class="line"><span class="params"><span class="function">    Options options,</span></span></span><br><span class="line"><span class="params"><span class="function">    DecodeCallbacks callbacks)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">byte</span>[] bytesForOptions = byteArrayPool.get(ArrayPool.STANDARD_BUFFER_SIZE_BYTES, <span class="keyword">byte</span>[].class);</span><br><span class="line">  BitmapFactory.Options bitmapFactoryOptions = getDefaultOptions();</span><br><span class="line">  bitmapFactoryOptions.inTempStorage = bytesForOptions;</span><br><span class="line"></span><br><span class="line">  DecodeFormat decodeFormat = options.get(DECODE_FORMAT);</span><br><span class="line">  PreferredColorSpace preferredColorSpace = options.get(PREFERRED_COLOR_SPACE);</span><br><span class="line">  DownsampleStrategy downsampleStrategy = options.get(DownsampleStrategy.OPTION);</span><br><span class="line">  <span class="keyword">boolean</span> fixBitmapToRequestedDimensions = options.get(FIX_BITMAP_SIZE_TO_REQUESTED_DIMENSIONS);</span><br><span class="line">  <span class="keyword">boolean</span> isHardwareConfigAllowed =</span><br><span class="line">      options.get(ALLOW_HARDWARE_CONFIG) != <span class="keyword">null</span> &amp;&amp; options.get(ALLOW_HARDWARE_CONFIG);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    Bitmap result =</span><br><span class="line">        decodeFromWrappedStreams(</span><br><span class="line">            imageReader,</span><br><span class="line">            bitmapFactoryOptions,</span><br><span class="line">            downsampleStrategy,</span><br><span class="line">            decodeFormat,</span><br><span class="line">            preferredColorSpace,</span><br><span class="line">            isHardwareConfigAllowed,</span><br><span class="line">            requestedWidth,</span><br><span class="line">            requestedHeight,</span><br><span class="line">            fixBitmapToRequestedDimensions,</span><br><span class="line">            callbacks);</span><br><span class="line">     <span class="comment">//把bitmap 封装进Resource ，返回Resource 对象</span></span><br><span class="line">    <span class="keyword">return</span> BitmapResource.obtain(result, bitmapPool);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    releaseOptions(bitmapFactoryOptions);</span><br><span class="line">    <span class="comment">// BitmapOptions 缓存池</span></span><br><span class="line">    byteArrayPool.put(bytesForOptions);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="6、DownSampler-decodeFromWrappedStreams"><a href="#6、DownSampler-decodeFromWrappedStreams" class="headerlink" title="6、DownSampler#decodeFromWrappedStreams"></a>6、DownSampler#decodeFromWrappedStreams</h4><p>这里涉及到bitmap在bitmapPool中的复用，目的是 如果bitmapPool 有可用的bitmap，就复用该bitmap。避免为Bitmap 分配内存，导致内存抖动</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">private</span> Bitmap <span class="title">decodeFromWrappedStreams</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">     ImageReader imageReader,</span></span></span><br><span class="line"><span class="params"><span class="function">     BitmapFactory.Options options,</span></span></span><br><span class="line"><span class="params"><span class="function">     DownsampleStrategy downsampleStrategy,</span></span></span><br><span class="line"><span class="params"><span class="function">     DecodeFormat decodeFormat,</span></span></span><br><span class="line"><span class="params"><span class="function">     PreferredColorSpace preferredColorSpace,</span></span></span><br><span class="line"><span class="params"><span class="function">     <span class="keyword">boolean</span> isHardwareConfigAllowed,</span></span></span><br><span class="line"><span class="params"><span class="function">     <span class="keyword">int</span> requestedWidth,</span></span></span><br><span class="line"><span class="params"><span class="function">     <span class="keyword">int</span> requestedHeight,</span></span></span><br><span class="line"><span class="params"><span class="function">     <span class="keyword">boolean</span> fixBitmapToRequestedDimensions,</span></span></span><br><span class="line"><span class="params"><span class="function">     DecodeCallbacks callbacks)</span></span></span><br><span class="line"><span class="function">     <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">   <span class="keyword">long</span> startTime = LogTime.getLogTime();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">int</span>[] sourceDimensions = getDimensions(imageReader, options, callbacks, bitmapPool);</span><br><span class="line">   <span class="keyword">int</span> sourceWidth = sourceDimensions[<span class="number">0</span>];</span><br><span class="line">   <span class="keyword">int</span> sourceHeight = sourceDimensions[<span class="number">1</span>];</span><br><span class="line">   String sourceMimeType = options.outMimeType;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// If we failed to obtain the image dimensions, we may end up with an incorrectly sized Bitmap,</span></span><br><span class="line">   <span class="comment">// so we want to use a mutable Bitmap type. One way this can happen is if the image header is so</span></span><br><span class="line">   <span class="comment">// large (10mb+) that our attempt to use inJustDecodeBounds fails and we&#x27;re forced to decode the</span></span><br><span class="line">   <span class="comment">// full size image.</span></span><br><span class="line">   <span class="keyword">if</span> (sourceWidth == -<span class="number">1</span> || sourceHeight == -<span class="number">1</span>) &#123;</span><br><span class="line">     isHardwareConfigAllowed = <span class="keyword">false</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">int</span> orientation = imageReader.getImageOrientation();</span><br><span class="line">   <span class="keyword">int</span> degreesToRotate = TransformationUtils.getExifOrientationDegrees(orientation);</span><br><span class="line">   <span class="keyword">boolean</span> isExifOrientationRequired = TransformationUtils.isExifOrientationRequired(orientation);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">int</span> targetWidth =</span><br><span class="line">       requestedWidth == Target.SIZE_ORIGINAL</span><br><span class="line">           ? (isRotationRequired(degreesToRotate) ? sourceHeight : sourceWidth)</span><br><span class="line">           : requestedWidth;</span><br><span class="line">   <span class="keyword">int</span> targetHeight =</span><br><span class="line">       requestedHeight == Target.SIZE_ORIGINAL</span><br><span class="line">           ? (isRotationRequired(degreesToRotate) ? sourceWidth : sourceHeight)</span><br><span class="line">           : requestedHeight;</span><br><span class="line"></span><br><span class="line">   ImageType imageType = imageReader.getImageType();</span><br><span class="line"></span><br><span class="line">   <span class="comment">//计算缩放比例，结果会体现在options参数中</span></span><br><span class="line">   calculateScaling(</span><br><span class="line">       imageType,</span><br><span class="line">       imageReader,</span><br><span class="line">       callbacks,</span><br><span class="line">       bitmapPool,</span><br><span class="line">       downsampleStrategy,</span><br><span class="line">       degreesToRotate,</span><br><span class="line">       sourceWidth,</span><br><span class="line">       sourceHeight,</span><br><span class="line">       targetWidth,</span><br><span class="line">       targetHeight,</span><br><span class="line">       options);</span><br><span class="line">       </span><br><span class="line">   calculateConfig(</span><br><span class="line">       imageReader,</span><br><span class="line">       decodeFormat,</span><br><span class="line">       isHardwareConfigAllowed,</span><br><span class="line">       isExifOrientationRequired,</span><br><span class="line">       options,</span><br><span class="line">       targetWidth,</span><br><span class="line">       targetHeight);</span><br><span class="line"><span class="comment">//计算sdk版本是否大于KITKAT，在该系统及之前 图片复用仅支持大小相同的位图 </span></span><br><span class="line">   <span class="keyword">boolean</span> isKitKatOrGreater = Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT;</span><br><span class="line">   <span class="comment">//下面的判断，来计算是否在BitmapPool中 是否有bitmap可以被复用，如果有就把bitmap 设置到options.inBitmap</span></span><br><span class="line">   <span class="comment">//这样在根据options 去解析生成bitmap的时候，就不需要再次分配内存了，避免了内存抖动</span></span><br><span class="line">   <span class="comment">// Prior to KitKat, the inBitmap size must exactly match the size of the bitmap we&#x27;re decoding.</span></span><br><span class="line">   <span class="keyword">if</span> ((options.inSampleSize == <span class="number">1</span> || isKitKatOrGreater) &amp;&amp; shouldUsePool(imageType)) &#123;</span><br><span class="line">     <span class="keyword">int</span> expectedWidth;</span><br><span class="line">     <span class="keyword">int</span> expectedHeight;</span><br><span class="line">     <span class="keyword">if</span> (sourceWidth &gt;= <span class="number">0</span></span><br><span class="line">         &amp;&amp; sourceHeight &gt;= <span class="number">0</span></span><br><span class="line">         &amp;&amp; fixBitmapToRequestedDimensions</span><br><span class="line">         &amp;&amp; isKitKatOrGreater) &#123;</span><br><span class="line">       expectedWidth = targetWidth;</span><br><span class="line">       expectedHeight = targetHeight;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="keyword">float</span> densityMultiplier =</span><br><span class="line">           isScaling(options) ? (<span class="keyword">float</span>) options.inTargetDensity / options.inDensity : <span class="number">1f</span>;</span><br><span class="line">       <span class="keyword">int</span> sampleSize = options.inSampleSize;</span><br><span class="line">       <span class="keyword">int</span> downsampledWidth = (<span class="keyword">int</span>) Math.ceil(sourceWidth / (<span class="keyword">float</span>) sampleSize);</span><br><span class="line">       <span class="keyword">int</span> downsampledHeight = (<span class="keyword">int</span>) Math.ceil(sourceHeight / (<span class="keyword">float</span>) sampleSize);</span><br><span class="line">       expectedWidth = Math.round(downsampledWidth * densityMultiplier);</span><br><span class="line">       expectedHeight = Math.round(downsampledHeight * densityMultiplier);</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// If this isn&#x27;t an image, or BitmapFactory was unable to parse the size, width and height</span></span><br><span class="line">     <span class="comment">// will be -1 here.</span></span><br><span class="line">     <span class="keyword">if</span> (expectedWidth &gt; <span class="number">0</span> &amp;&amp; expectedHeight &gt; <span class="number">0</span>) &#123;</span><br><span class="line">       <span class="comment">//该函数会在bitmapPool中查找符合大小的bitmap ，如果找到了就设置给inBitmap</span></span><br><span class="line">       setInBitmap(options, bitmapPool, expectedWidth, expectedHeight);</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.P) &#123;</span><br><span class="line">     <span class="keyword">boolean</span> isP3Eligible =</span><br><span class="line">         preferredColorSpace == PreferredColorSpace.DISPLAY_P3</span><br><span class="line">             &amp;&amp; options.outColorSpace != <span class="keyword">null</span></span><br><span class="line">             &amp;&amp; options.outColorSpace.isWideGamut();</span><br><span class="line">     options.inPreferredColorSpace =</span><br><span class="line">         ColorSpace.get(isP3Eligible ? ColorSpace.Named.DISPLAY_P3 : ColorSpace.Named.SRGB);</span><br><span class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) &#123;</span><br><span class="line">     options.inPreferredColorSpace = ColorSpace.get(ColorSpace.Named.SRGB);</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//根据options 把流解析为Bitmap</span></span><br><span class="line">   Bitmap downsampled = decodeStream(imageReader, options, callbacks, bitmapPool);</span><br><span class="line">   callbacks.onDecodeComplete(bitmapPool, downsampled);</span><br><span class="line"></span><br><span class="line">   Bitmap rotated = <span class="keyword">null</span>;</span><br><span class="line">   <span class="keyword">if</span> (downsampled != <span class="keyword">null</span>) &#123;</span><br><span class="line">     <span class="comment">// If we scaled, the Bitmap density will be our inTargetDensity. Here we correct it back to</span></span><br><span class="line">     <span class="comment">// the expected density dpi.</span></span><br><span class="line">     downsampled.setDensity(displayMetrics.densityDpi);</span><br><span class="line"></span><br><span class="line">     rotated = TransformationUtils.rotateImageExif(bitmapPool, downsampled, orientation);</span><br><span class="line">     <span class="keyword">if</span> (!downsampled.equals(rotated)) &#123;</span><br><span class="line">       bitmapPool.put(downsampled);</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> rotated;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>至此已经得到了解析后的资源了，接下来就是要显示到指定的ImageView控件上，回到<code>notifyEncodeAndRelease</code>流程中。</p>
<h3 id="3-3-12、开启缓存"><a href="#3-3-12、开启缓存" class="headerlink" title="3.3.12、开启缓存"></a>3.3.12、开启缓存</h3><p>当我们开启去不缓存后，加载过程就变为如下。</p>
<img src="/pics/image-20220213215722486.png" alt="image-20220213215722486" style="zoom:50%;" />

<h4 id="1、DecodeJob-runWrapped"><a href="#1、DecodeJob-runWrapped" class="headerlink" title="1、DecodeJob#runWrapped"></a>1、DecodeJob#runWrapped</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">runWrapped</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    runWrappedCount++;</span><br><span class="line">    <span class="keyword">switch</span> (runReason) &#123;</span><br><span class="line">        <span class="keyword">case</span> INITIALIZE:</span><br><span class="line">            <span class="comment">//初始化之后第一次运行时, stage 返回的是source</span></span><br><span class="line">            stage = getNextStage(Stage.INITIALIZE);</span><br><span class="line">            <span class="comment">//根据下一阶段状态，判断具体由哪个类执行，source 对应是 SourceGenerator</span></span><br><span class="line">            currentGenerator = getNextGenerator();</span><br><span class="line">            runGenerators();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SWITCH_TO_SOURCE_SERVICE:</span><br><span class="line">            runGenerators();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DECODE_DATA:</span><br><span class="line">            decodeFromRetrievedData();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Unrecognized run reason: &quot;</span> + runReason);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Stage <span class="title">getNextStage</span><span class="params">(Stage current)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (current) &#123;</span><br><span class="line">        <span class="keyword">case</span> INITIALIZE:</span><br><span class="line">        <span class="comment">//当前是初始阶段，则看磁盘缓存策略，是否可以在磁盘中获取资源缓存（也就是解析后的缓存）</span></span><br><span class="line">            <span class="keyword">return</span> diskCacheStrategy.decodeCachedResource()</span><br><span class="line">                    ? Stage.RESOURCE_CACHE : getNextStage(Stage.RESOURCE_CACHE);</span><br><span class="line">        <span class="keyword">case</span> RESOURCE_CACHE:</span><br><span class="line">        <span class="comment">//当前是资源缓存，看下一步能不能从磁盘缓存中获取源数据缓存</span></span><br><span class="line">            <span class="keyword">return</span> diskCacheStrategy.decodeCachedData()</span><br><span class="line">                    ? Stage.DATA_CACHE : getNextStage(Stage.DATA_CACHE);</span><br><span class="line">        <span class="keyword">case</span> DATA_CACHE:</span><br><span class="line">            <span class="comment">// Skip loading from source if the user opted to only retrieve the resource from cache.</span></span><br><span class="line">            <span class="comment">//当前是数据缓存，下一步能不能从源数据处获取数据，例如从服务器获取</span></span><br><span class="line">            <span class="keyword">return</span> onlyRetrieveFromCache ? Stage.FINISHED : Stage.SOURCE;</span><br><span class="line">        <span class="keyword">case</span> SOURCE:</span><br><span class="line">        <span class="keyword">case</span> FINISHED:</span><br><span class="line">            <span class="keyword">return</span> Stage.FINISHED;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Unrecognized stage: &quot;</span> + current);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">runGenerators</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.currentThread = Thread.currentThread();</span><br><span class="line">    <span class="keyword">this</span>.startFetchTime = LogTime.getLogTime();</span><br><span class="line">    <span class="keyword">boolean</span> isStarted = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(!<span class="keyword">this</span>.isCancelled &amp;&amp; <span class="keyword">this</span>.currentGenerator != <span class="keyword">null</span> &amp;&amp; !(isStarted =                                                                   <span class="keyword">this</span>.currentGenerator.startNext())) &#123; <span class="comment">// 加载数据</span></span><br><span class="line">        <span class="keyword">this</span>.stage = <span class="keyword">this</span>.getNextStage(<span class="keyword">this</span>.stage);</span><br><span class="line">        <span class="keyword">this</span>.currentGenerator = <span class="keyword">this</span>.getNextGenerator();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.stage == DecodeJob.Stage.SOURCE) &#123;</span><br><span class="line">            <span class="keyword">this</span>.reschedule();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">this</span>.stage == DecodeJob.Stage.FINISHED || <span class="keyword">this</span>.isCancelled) &amp;&amp; !isStarted) &#123;</span><br><span class="line">        <span class="keyword">this</span>.notifyFailed();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2、SourceGenerator-onDataReadyInternal"><a href="#2、SourceGenerator-onDataReadyInternal" class="headerlink" title="2、SourceGenerator#onDataReadyInternal"></a>2、SourceGenerator#onDataReadyInternal</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">onDataReadyInternal</span><span class="params">(LoadData&lt;?&gt; loadData, Object data)</span> </span>&#123;</span><br><span class="line">  DiskCacheStrategy diskCacheStrategy = helper.getDiskCacheStrategy();</span><br><span class="line">  <span class="keyword">if</span> (data != <span class="keyword">null</span> &amp;&amp; diskCacheStrategy.isDataCacheable(loadData.fetcher.getDataSource())) &#123;</span><br><span class="line">    dataToCache = data;</span><br><span class="line">		<span class="comment">// 缓存选项开启</span></span><br><span class="line">    cb.reschedule();</span><br><span class="line">  &#125; </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//DecodeJob#reschedule</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reschedule</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  runReason = RunReason.SWITCH_TO_SOURCE_SERVICE;</span><br><span class="line">  <span class="comment">//执行到DecodeJob#runWrapped，再调用到SourceGenerator</span></span><br><span class="line">  callback.reschedule(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cacheData</span><span class="params">(Object dataToCache)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">long</span> startTime = LogTime.getLogTime();</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">     Encoder&lt;Object&gt; encoder = helper.getSourceEncoder(dataToCache);</span><br><span class="line">     DataCacheWriter&lt;Object&gt; writer =</span><br><span class="line">         <span class="keyword">new</span> DataCacheWriter&lt;&gt;(encoder, dataToCache, helper.getOptions());</span><br><span class="line">     originalKey = <span class="keyword">new</span> DataCacheKey(loadData.sourceKey, helper.getSignature());</span><br><span class="line">     helper.getDiskCache().put(originalKey, writer);</span><br><span class="line">   	<span class="comment">//...</span></span><br><span class="line">   &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">     loadData.fetcher.cleanup();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   sourceCacheGenerator =</span><br><span class="line">       <span class="keyword">new</span> DataCacheGenerator(Collections.singletonList(loadData.sourceKey), helper, <span class="keyword">this</span>);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//SourceGenerator#startNext</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">startNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (dataToCache != <span class="keyword">null</span>) &#123;</span><br><span class="line">    Object data = dataToCache;</span><br><span class="line">    dataToCache = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//缓存原始数据</span></span><br><span class="line">    cacheData(data);</span><br><span class="line">  &#125;</span><br><span class="line">	<span class="comment">// 此处的sourceCacheGenerator是DataCacheGenerator，继续调用它的方法进行数据加载</span></span><br><span class="line">  <span class="keyword">if</span> (sourceCacheGenerator != <span class="keyword">null</span> &amp;&amp; sourceCacheGenerator.startNext()) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3、DataCacheGenerator-startNext"><a href="#3、DataCacheGenerator-startNext" class="headerlink" title="3、DataCacheGenerator#startNext"></a>3、DataCacheGenerator#startNext</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">startNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (modelLoaders == <span class="keyword">null</span> || !hasNextModelLoader()) &#123;</span><br><span class="line">    sourceIdIndex++;</span><br><span class="line">    <span class="keyword">if</span> (sourceIdIndex &gt;= cacheKeys.size()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Key sourceId = cacheKeys.get(sourceIdIndex);</span><br><span class="line">    <span class="comment">// PMD.AvoidInstantiatingObjectsInLoops The loop iterates a limited number of times</span></span><br><span class="line">    <span class="comment">// and the actions it performs are much more expensive than a single allocation.</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;PMD.AvoidInstantiatingObjectsInLoops&quot;)</span></span><br><span class="line">    Key originalKey = <span class="keyword">new</span> DataCacheKey(sourceId, helper.getSignature());</span><br><span class="line">    cacheFile = helper.getDiskCache().get(originalKey);</span><br><span class="line">    <span class="keyword">if</span> (cacheFile != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.sourceKey = sourceId;</span><br><span class="line">      modelLoaders = helper.getModelLoaders(cacheFile);</span><br><span class="line">      modelLoaderIndex = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  loadData = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">boolean</span> started = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">while</span> (!started &amp;&amp; hasNextModelLoader()) &#123;</span><br><span class="line">    ModelLoader&lt;File, ?&gt; modelLoader = modelLoaders.get(modelLoaderIndex++);</span><br><span class="line">    loadData =</span><br><span class="line">        modelLoader.buildLoadData(</span><br><span class="line">            cacheFile, helper.getWidth(), helper.getHeight(), helper.getOptions());</span><br><span class="line">    <span class="keyword">if</span> (loadData != <span class="keyword">null</span> &amp;&amp; helper.hasLoadPath(loadData.fetcher.getDataClass())) &#123;</span><br><span class="line">      started = <span class="keyword">true</span>;</span><br><span class="line">      <span class="comment">// ByteBufferFetcher</span></span><br><span class="line">      loadData.fetcher.loadData(helper.getPriority(), <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> started;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4、ByteBufferFetcher-loadData"><a href="#4、ByteBufferFetcher-loadData" class="headerlink" title="4、ByteBufferFetcher#loadData"></a>4、ByteBufferFetcher#loadData</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadData</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="meta">@NonNull</span> Priority priority, <span class="meta">@NonNull</span> DataCallback&lt;? <span class="keyword">super</span> ByteBuffer&gt; callback)</span> </span>&#123;</span><br><span class="line">  ByteBuffer result;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    result = ByteBufferUtil.fromFile(file);</span><br><span class="line">    callback.onDataReady(result);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</span><br><span class="line">      Log.d(TAG, <span class="string">&quot;Failed to obtain ByteBuffer for file&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    callback.onLoadFailed(e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;(</span><br><span class="line">    <span class="meta">@NonNull</span> Priority priority, <span class="meta">@NonNull</span> DataCallback&lt;? <span class="keyword">super</span> ByteBuffer&gt; callback) &#123;</span><br><span class="line">  ByteBuffer result;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    result = ByteBufferUtil.fromFile(file);</span><br><span class="line">     <span class="comment">// 这个callback是DataCacheGenerator</span></span><br><span class="line">    callback.onDataReady(result);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</span><br><span class="line">      Log.d(TAG, <span class="string">&quot;Failed to obtain ByteBuffer for file&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    callback.onLoadFailed(e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="5、DataCacheGenerator-onDataReady"><a href="#5、DataCacheGenerator-onDataReady" class="headerlink" title="5、DataCacheGenerator#onDataReady"></a>5、DataCacheGenerator#onDataReady</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDataReady</span><span class="params">(Object data)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// cb 是decodeJob</span></span><br><span class="line">  cb.onDataFetcherReady(sourceKey, data, loadData.fetcher, DataSource.DATA_DISK_CACHE, sourceKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终又回到了DeocodeJob中。也就是说采用缓存时，会先将网络数据保存起来再读取缓存进行加载。</p>
<h3 id="3-3-13、图片转换和转码"><a href="#3-3-13、图片转换和转码" class="headerlink" title="3.3.13、图片转换和转码"></a>3.3.13、图片转换和转码</h3><p>入口都在<code>DecodePath#decode</code>中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Resource&lt;Transcode&gt; <span class="title">decode</span><span class="params">(DataRewinder&lt;DataType&gt; rewinder, <span class="keyword">int</span> width, <span class="keyword">int</span> height,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="meta">@NonNull</span> Options options, DecodeCallback&lt;ResourceType&gt; callback)</span> <span class="keyword">throws</span> GlideException </span>&#123;</span><br><span class="line">    <span class="comment">//解码                              </span></span><br><span class="line">    Resource&lt;ResourceType&gt; decoded = decodeResource(rewinder, width, height, options);</span><br><span class="line">    <span class="comment">// 这个方法是回调到Decodejob.onResourceDecoded ,作用是调用RequestOptions中的Transform处理图片，然后将ResourceCache的Key和Encode准备好（放在变量 deferEncoderManager中），稍后进行写入缓存。</span></span><br><span class="line">    Resource&lt;ResourceType&gt; transformed = callback.onResourceDecoded(decoded);</span><br><span class="line">    <span class="comment">//图片的转码过程，进行数据类型的转换</span></span><br><span class="line">    <span class="keyword">return</span> transcoder.transcode(transformed, options);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1、图片转换"><a href="#1、图片转换" class="headerlink" title="1、图片转换"></a>1、图片转换</h4><h5 id="DecodeJob-onResourceDecoded"><a href="#DecodeJob-onResourceDecoded" class="headerlink" title="DecodeJob#onResourceDecoded"></a>DecodeJob#onResourceDecoded</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&lt;Z&gt; <span class="function">Resource&lt;Z&gt; <span class="title">onResourceDecoded</span><span class="params">(DataSource dataSource, <span class="meta">@NonNull</span> Resource&lt;Z&gt; decoded)</span> </span>&#123;</span><br><span class="line">  <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">  Class&lt;Z&gt; resourceSubClass = (Class&lt;Z&gt;) decoded.get().getClass();</span><br><span class="line">  Transformation&lt;Z&gt; appliedTransformation = <span class="keyword">null</span>;</span><br><span class="line">  Resource&lt;Z&gt; transformed = decoded;</span><br><span class="line">  <span class="keyword">if</span> (dataSource != DataSource.RESOURCE_DISK_CACHE) &#123;</span><br><span class="line">    appliedTransformation = decodeHelper.getTransformation(resourceSubClass);</span><br><span class="line">    <span class="comment">// 图片转换，和我们初始化设置有关，假设我们设置的是centercrop</span></span><br><span class="line">    transformed = appliedTransformation.transform(glideContext, decoded, width, height);</span><br><span class="line">  &#125;</span><br><span class="line"> 	<span class="comment">//...</span></span><br><span class="line">    <span class="keyword">final</span> Key key;</span><br><span class="line">    <span class="keyword">switch</span> (encodeStrategy) &#123;</span><br><span class="line">      <span class="comment">// 缓存的可以有2种，分别用来保存原始数据和转换后的图片数据</span></span><br><span class="line">      <span class="keyword">case</span> SOURCE:</span><br><span class="line">        key = <span class="keyword">new</span> DataCacheKey(currentSourceKey, signature);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> TRANSFORMED:</span><br><span class="line">        key =</span><br><span class="line">            <span class="keyword">new</span> ResourceCacheKey(</span><br><span class="line">                decodeHelper.getArrayPool(),</span><br><span class="line">                currentSourceKey,</span><br><span class="line">                signature,</span><br><span class="line">                width,</span><br><span class="line">                height,</span><br><span class="line">                appliedTransformation,</span><br><span class="line">                resourceSubClass,</span><br><span class="line">                options);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Unknown strategy: &quot;</span> + encodeStrategy);</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="CenterCrop-transform"><a href="#CenterCrop-transform" class="headerlink" title="CenterCrop#transform"></a>CenterCrop#transform</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Bitmap <span class="title">transform</span><span class="params">(<span class="meta">@NonNull</span> BitmapPool pool, <span class="meta">@NonNull</span> Bitmap toTransform, <span class="keyword">int</span> outWidth, <span class="keyword">int</span> outHeight)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> TransformationUtils.centerCrop(pool, toTransform, outWidth, outHeight);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="TransformationUtils-centerCrop"><a href="#TransformationUtils-centerCrop" class="headerlink" title="TransformationUtils#centerCrop"></a>TransformationUtils#centerCrop</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title">centerCrop</span><span class="params">(<span class="meta">@NonNull</span> BitmapPool pool, <span class="meta">@NonNull</span> Bitmap inBitmap, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (inBitmap.getWidth() == width &amp;&amp; inBitmap.getHeight() == height) &#123;</span><br><span class="line">        <span class="keyword">return</span> inBitmap;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Matrix m = <span class="keyword">new</span> Matrix();</span><br><span class="line">        <span class="keyword">float</span> scale;</span><br><span class="line">        <span class="keyword">float</span> dx;</span><br><span class="line">        <span class="keyword">float</span> dy;</span><br><span class="line">        <span class="keyword">if</span> (inBitmap.getWidth() * height &gt; width * inBitmap.getHeight()) &#123;</span><br><span class="line">            scale = (<span class="keyword">float</span>)height / (<span class="keyword">float</span>)inBitmap.getHeight();</span><br><span class="line">            dx = ((<span class="keyword">float</span>)width - (<span class="keyword">float</span>)inBitmap.getWidth() * scale) * <span class="number">0.5F</span>;</span><br><span class="line">            dy = <span class="number">0.0F</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            scale = (<span class="keyword">float</span>)width / (<span class="keyword">float</span>)inBitmap.getWidth();</span><br><span class="line">            dx = <span class="number">0.0F</span>;</span><br><span class="line">            dy = ((<span class="keyword">float</span>)height - (<span class="keyword">float</span>)inBitmap.getHeight() * scale) * <span class="number">0.5F</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        m.setScale(scale, scale);</span><br><span class="line">        m.postTranslate((<span class="keyword">float</span>)((<span class="keyword">int</span>)(dx + <span class="number">0.5F</span>)), (<span class="keyword">float</span>)((<span class="keyword">int</span>)(dy + <span class="number">0.5F</span>)));</span><br><span class="line">        Bitmap result = pool.get(width, height, getNonNullConfig(inBitmap));</span><br><span class="line">        setAlpha(inBitmap, result);</span><br><span class="line">        applyMatrix(inBitmap, result, m);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2、转码"><a href="#2、转码" class="headerlink" title="2、转码"></a>2、转码</h4><p>转码就是将转化后的图片转成相应的Gif或其他，默认的transcoder是<code>BitmapDrawableTranscoder</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Resource&lt;BitmapDrawable&gt; <span class="title">transcode</span><span class="params">(<span class="meta">@NonNull</span> Resource&lt;Bitmap&gt; toTranscode, <span class="meta">@NonNull</span> Options options)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> LazyBitmapDrawableResource.obtain(<span class="keyword">this</span>.resources, toTranscode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="/pics/image-20220213223212792.png" alt="image-20220213223212792" style="zoom:50%;" />

<h1 id="四、参考"><a href="#四、参考" class="headerlink" title="四、参考"></a>四、参考</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/guolin_blog/category_9268670.html">https://blog.csdn.net/guolin_blog/category_9268670.html</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/xx326664162/article/details/107663872">https://blog.csdn.net/xx326664162/article/details/107663872</a></p>

    </div>

    
    
    
      

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>sven
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://zhaoxiaowen-sven.github.io/2022/01/15/Notes/Android/02%E5%BC%80%E6%BA%90/open_08_GLIDE/" title="open_08_GLIDE">https://zhaoxiaowen-sven.github.io/2022/01/15/Notes/Android/02开源/open_08_GLIDE/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/10/26/Notes/Android/01%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6/base_01_Activity%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%92%8C%E5%90%AF%E5%8A%A8%E6%A8%A1%E5%BC%8F/" rel="prev" title="base_01_Activity生命周期和启动模式">
      <i class="fa fa-chevron-left"></i> base_01_Activity生命周期和启动模式
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/03/02/Notes/Interview/Java%20%E9%9D%A2%E8%AF%95%E9%A2%98/" rel="next" title="Java 面试题">
      Java 面试题 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#open-08-GLIDE"><span class="nav-text">open_08_GLIDE</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E6%A6%82%E8%BF%B0"><span class="nav-text">一、概述</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="nav-text">二、使用方法</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-text">三、源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1%E3%80%81with"><span class="nav-text">3.1、with</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-1%E3%80%81Glide-%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-text">3.1.1、Glide 初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81Glide-get"><span class="nav-text">1、Glide#get</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81Glide-initializeGlide"><span class="nav-text">2、Glide#initializeGlide</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81GlideBuilder-build"><span class="nav-text">3、GlideBuilder#build</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4%E3%80%81Glide-Glide"><span class="nav-text">4、Glide#Glide</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-2%E3%80%81%E7%BB%91%E5%AE%9ALifeCycle%E7%BB%84%E4%BB%B6"><span class="nav-text">3.1.2、绑定LifeCycle组件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81RequestManagerRetriever-get"><span class="nav-text">1、RequestManagerRetriever#get</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2%E3%80%81load"><span class="nav-text">3.2、load</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-1%E3%80%81RequestManager-load"><span class="nav-text">3.2.1、RequestManager#load</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-2%E3%80%81RequestManager-asDrawable"><span class="nav-text">3.2.2、RequestManager#asDrawable</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-3%E3%80%81RequestBuilder-load"><span class="nav-text">3.2.3、RequestBuilder#load</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3%E3%80%81into"><span class="nav-text">3.3、into</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-1%E3%80%81%E6%9E%84%E9%80%A0ImageviewTarget"><span class="nav-text">3.3.1、构造ImageviewTarget</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81GlideContext-buildImageViewTarget"><span class="nav-text">1、GlideContext # buildImageViewTarget</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81ImageViewTargetFactory-buildTarget"><span class="nav-text">2、ImageViewTargetFactory # buildTarget</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-2%E3%80%81%E6%9E%84%E9%80%A0Request%E8%AF%B7%E6%B1%82"><span class="nav-text">3.3.2、构造Request请求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-3%E3%80%81%E6%89%A7%E8%A1%8CRequest%E8%AF%B7%E6%B1%82"><span class="nav-text">3.3.3、执行Request请求</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81RequestTracker-runRequest"><span class="nav-text">1、RequestTracker#runRequest</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81SingleRequest-begin"><span class="nav-text">2、SingleRequest#begin</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81SingleRequest-onSizeReady"><span class="nav-text">3、SingleRequest #onSizeReady</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-4%E3%80%81Engine-load"><span class="nav-text">3.3.4、Engine # load</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-5%E3%80%81%E5%86%85%E5%AD%98%E7%BC%93%E5%AD%98%E5%8A%A0%E8%BD%BD"><span class="nav-text">3.3.5、内存缓存加载</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81%E5%8A%A0%E8%BD%BD%E5%BC%B1%E5%BC%95%E7%94%A8%E7%BC%93%E5%AD%98"><span class="nav-text">1、加载弱引用缓存</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81%E5%8A%A0%E8%BD%BDLru-%E7%BC%93%E5%AD%98"><span class="nav-text">2、加载Lru 缓存</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-6%E3%80%81%E4%BB%8E%E7%A3%81%E7%9B%98%E6%88%96%E7%BD%91%E7%BB%9C%E5%8A%A0%E8%BD%BD"><span class="nav-text">3.3.6、从磁盘或网络加载</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81EngineJob-start"><span class="nav-text">1、EngineJob#start</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81EngineJob-willDecodeFromCache"><span class="nav-text">2、EngineJob#willDecodeFromCache</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81EngineJob-getNextStage"><span class="nav-text">3、EngineJob#getNextStage</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4%E3%80%81DecodeJob-runWrapped"><span class="nav-text">4、DecodeJob#runWrapped</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5%E3%80%81DecodeJob-runGenerators"><span class="nav-text">5、DecodeJob#runGenerators</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-7%E3%80%81%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E5%92%8C%E5%9B%9E%E8%B0%83"><span class="nav-text">3.3.7、数据加载和回调</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81SourceGenerator-startNext"><span class="nav-text">1、SourceGenerator#startNext</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81SourceGenerator-startNextLoad"><span class="nav-text">2、SourceGenerator#startNextLoad</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81HttpUrlFetcher-loadData"><span class="nav-text">3、HttpUrlFetcher#loadData</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-8%E3%80%81%E6%95%B0%E6%8D%AE%E5%9B%9E%E8%B0%83%E8%BF%87%E7%A8%8B"><span class="nav-text">3.3.8、数据回调过程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81SourceGenerator-onDataReady"><span class="nav-text">1、SourceGenerator#onDataReady</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81DecodeJob-onDataFetcherReady"><span class="nav-text">2、DecodeJob#onDataFetcherReady</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81DecodeJob-decodeFromRetrievedData"><span class="nav-text">3、DecodeJob#decodeFromRetrievedData</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4%E3%80%81DecodeJob-notifyEncodeAndRelease"><span class="nav-text">4、DecodeJob#notifyEncodeAndRelease</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5%E3%80%81EngineJob-notifyComplete"><span class="nav-text">5、EngineJob#notifyComplete</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6%E3%80%81EngineJob-onResourceReady"><span class="nav-text">6、EngineJob#onResourceReady</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7%E3%80%81EngineJob-notifyCallbacksOfResult"><span class="nav-text">7、EngineJob#notifyCallbacksOfResult</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8%E3%80%81%E5%86%85%E9%83%A8%E7%B1%BBCallResourceReady-run"><span class="nav-text">8、内部类CallResourceReady # run</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9%E3%80%81SingleRequest-onResourceReady"><span class="nav-text">9、SingleRequest#onResourceReady</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-9%E3%80%81-%E8%AE%BE%E7%BD%AE%E5%9B%BE%E5%83%8F%E5%88%B0View"><span class="nav-text">3.3.9、 设置图像到View</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81ImageViewTarget-onResourceReady"><span class="nav-text">1、ImageViewTarget#onResourceReady</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81DrawableImageViewTarget-setResource"><span class="nav-text">2、DrawableImageViewTarget#setResource</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-10%E3%80%81%E6%95%B0%E6%8D%AE%E8%A7%A3%E7%A0%81%E4%B8%BA%E5%9B%BE%E7%89%87%E8%BF%87%E7%A8%8B"><span class="nav-text">3.3.10、数据解码为图片过程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81DecodeJob-decodeFromData"><span class="nav-text">1、DecodeJob#decodeFromData</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81DecodeJob-runLoadPath"><span class="nav-text">2、DecodeJob#runLoadPath</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81DecodePath-decode"><span class="nav-text">3、DecodePath#decode</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4%E3%80%81ByteBufferBitmapDecoder-decode"><span class="nav-text">4、ByteBufferBitmapDecoder # decode</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5%E3%80%81DownSampler-decode"><span class="nav-text">5、DownSampler#decode</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6%E3%80%81DownSampler-decodeFromWrappedStreams"><span class="nav-text">6、DownSampler#decodeFromWrappedStreams</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-12%E3%80%81%E5%BC%80%E5%90%AF%E7%BC%93%E5%AD%98"><span class="nav-text">3.3.12、开启缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81DecodeJob-runWrapped"><span class="nav-text">1、DecodeJob#runWrapped</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81SourceGenerator-onDataReadyInternal"><span class="nav-text">2、SourceGenerator#onDataReadyInternal</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81DataCacheGenerator-startNext"><span class="nav-text">3、DataCacheGenerator#startNext</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4%E3%80%81ByteBufferFetcher-loadData"><span class="nav-text">4、ByteBufferFetcher#loadData</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5%E3%80%81DataCacheGenerator-onDataReady"><span class="nav-text">5、DataCacheGenerator#onDataReady</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-13%E3%80%81%E5%9B%BE%E7%89%87%E8%BD%AC%E6%8D%A2%E5%92%8C%E8%BD%AC%E7%A0%81"><span class="nav-text">3.3.13、图片转换和转码</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81%E5%9B%BE%E7%89%87%E8%BD%AC%E6%8D%A2"><span class="nav-text">1、图片转换</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#DecodeJob-onResourceDecoded"><span class="nav-text">DecodeJob#onResourceDecoded</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#CenterCrop-transform"><span class="nav-text">CenterCrop#transform</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#TransformationUtils-centerCrop"><span class="nav-text">TransformationUtils#centerCrop</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81%E8%BD%AC%E7%A0%81"><span class="nav-text">2、转码</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E5%8F%82%E8%80%83"><span class="nav-text">四、参考</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="sven"
      src="/images/sven.jpeg">
  <p class="site-author-name" itemprop="name">sven</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">81</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/zhaoxiaowen-sven" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zhaoxiaowen-sven" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zhaoxiaowen-sven@gmail.com" title="E-Mail → mailto:zhaoxiaowen-sven@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">sven</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
