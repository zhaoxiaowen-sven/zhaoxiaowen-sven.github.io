<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zhaoxiaowen-sven.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Jetpack_05_WorkManager原理">
<meta property="og:type" content="article">
<meta property="og:title" content="Jetpack_05_WorkManager原理">
<meta property="og:url" content="https://zhaoxiaowen-sven.github.io/2022/05/21/Notes/Android/03Jetpack/Jetpack_05_WorkManager%E5%8E%9F%E7%90%86/index.html">
<meta property="og:site_name" content="Sven&#39;s blog">
<meta property="og:description" content="Jetpack_05_WorkManager原理">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://pic2.zhimg.com/v2-61b832aa9c912ffbeaec57769d166221_r.jpg">
<meta property="og:image" content="https://zhaoxiaowen-sven.github.io/pics/v2-fdae66d3ef4c350fbb4298935a831e64_r.jpg">
<meta property="og:image" content="https://zhaoxiaowen-sven.github.io/pics/image-20220528180120396.png">
<meta property="og:image" content="https://zhaoxiaowen-sven.github.io/pics/v2-bffd85c278ba2eb0bf8ef550e9b93b4f_r.jpg">
<meta property="article:published_time" content="2022-05-21T13:08:12.428Z">
<meta property="article:modified_time" content="2022-05-28T14:41:04.105Z">
<meta property="article:author" content="sven">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pic2.zhimg.com/v2-61b832aa9c912ffbeaec57769d166221_r.jpg">

<link rel="canonical" href="https://zhaoxiaowen-sven.github.io/2022/05/21/Notes/Android/03Jetpack/Jetpack_05_WorkManager%E5%8E%9F%E7%90%86/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Jetpack_05_WorkManager原理 | Sven's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>
      <a target="_blank" rel="noopener" href="https://github.com/zhaoxiaowen-sven" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Sven's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhaoxiaowen-sven.github.io/2022/05/21/Notes/Android/03Jetpack/Jetpack_05_WorkManager%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/sven.jpeg">
      <meta itemprop="name" content="sven">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sven's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Jetpack_05_WorkManager原理
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-05-21 21:08:12" itemprop="dateCreated datePublished" datetime="2022-05-21T21:08:12+08:00">2022-05-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/Lifecycle/" itemprop="url" rel="index"><span itemprop="name">Lifecycle</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Jetpack-05-WorkManager原理"><a href="#Jetpack-05-WorkManager原理" class="headerlink" title="Jetpack_05_WorkManager原理"></a>Jetpack_05_WorkManager原理</h1><span id="more"></span>

<p>在上一篇文章中介绍了<code>WorkManager</code>的使用方法，这篇文章我们来看下 <code>WorkManager</code>是如何执行任务的。</p>
<blockquote>
<p>本文基于<code>workManager 2.7.1</code>版本源码，程序demo基于<code>sdk 31</code></p>
</blockquote>
<h1 id="一、WorkManager的初始化"><a href="#一、WorkManager的初始化" class="headerlink" title="一、WorkManager的初始化"></a>一、<code>WorkManager</code>的初始化</h1><p>引入依赖后，<code>Manifest</code>中会注册一个<code>Provider</code> ，<code>Provider</code>中我们发现会默认注册一个<code>WorkManagerInitializer</code> 的类，就是用来初始化<code>WorkManager</code>的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;provider</span><br><span class="line">    android:name=<span class="string">&quot;androidx.startup.InitializationProvider&quot;</span></span><br><span class="line">    android:exported=<span class="string">&quot;false&quot;</span></span><br><span class="line">    android:authorities=<span class="string">&quot;com.example.easyjetpack.androidx-startup&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;meta-data</span><br><span class="line">        android:name=<span class="string">&quot;androidx.work.WorkManagerInitializer&quot;</span></span><br><span class="line">        android:value=<span class="string">&quot;androidx.startup&quot;</span> /&gt;</span><br><span class="line">    <span class="comment">//... </span></span><br><span class="line">&lt;/provider&gt;</span><br></pre></td></tr></table></figure>

<p>下面看下 <code>WorkManagerInitializer</code> 中的逻辑。</p>
<h2 id="1-1、WorkManagerInitializer"><a href="#1-1、WorkManagerInitializer" class="headerlink" title="1.1、WorkManagerInitializer"></a>1.1、<code>WorkManagerInitializer</code></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">WorkManagerInitializer</span> <span class="keyword">implements</span> <span class="title">Initializer</span>&lt;<span class="title">WorkManager</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = Logger.tagWithPrefix(<span class="string">&quot;WrkMgrInitializer&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WorkManager <span class="title">create</span><span class="params">(<span class="meta">@NonNull</span> Context context)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Initialize WorkManager with the default configuration.</span></span><br><span class="line">        Logger.get().debug(TAG, <span class="string">&quot;Initializing WorkManager with default configuration.&quot;</span>);</span><br><span class="line">        <span class="comment">// 初始化 WorkManager</span></span><br><span class="line">        WorkManager.initialize(context, <span class="keyword">new</span> Configuration.Builder().build());</span><br><span class="line">        <span class="keyword">return</span> WorkManager.getInstance(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Class&lt;? extends androidx.startup.Initializer&lt;?&gt;&gt;&gt; dependencies() &#123;</span><br><span class="line">        <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="meta">@NonNull</span> <span class="function">WorkManager <span class="title">getInstance</span><span class="params">(<span class="meta">@NonNull</span> Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> WorkManagerImpl.getInstance(context);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="meta">@NonNull</span> <span class="function">WorkManagerImpl <span class="title">getInstance</span><span class="params">(<span class="meta">@NonNull</span> Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (sLock) &#123;</span><br><span class="line">        WorkManagerImpl instance = getInstance();</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Context appContext = context.getApplicationContext();</span><br><span class="line">            <span class="keyword">if</span> (appContext <span class="keyword">instanceof</span> Configuration.Provider) &#123;</span><br><span class="line">                initialize(</span><br><span class="line">                        appContext,</span><br><span class="line">                        ((Configuration.Provider) appContext).getWorkManagerConfiguration());</span><br><span class="line">                instance = getInstance(appContext);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(<span class="meta">@NonNull</span> Context context, <span class="meta">@NonNull</span> Configuration configuration)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (sLock) &#123;</span><br><span class="line">       <span class="comment">// ..</span></span><br><span class="line">        <span class="keyword">if</span> (sDelegatedInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            context = context.getApplicationContext();</span><br><span class="line">            <span class="keyword">if</span> (sDefaultInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 构造WorkManagerImpl</span></span><br><span class="line">                sDefaultInstance = <span class="keyword">new</span> WorkManagerImpl(</span><br><span class="line">                        context,</span><br><span class="line">                        configuration,</span><br><span class="line">                        <span class="keyword">new</span> WorkManagerTaskExecutor(configuration.getTaskExecutor()));</span><br><span class="line">            &#125;</span><br><span class="line">            sDelegatedInstance = sDefaultInstance;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>经过以上的调用，最终会构造出一个<code>WorkManagerImpl</code>对象。</p>
<h2 id="1-2、WorkManagerImpl"><a href="#1-2、WorkManagerImpl" class="headerlink" title="1.2、WorkManagerImpl"></a>1.2、<code>WorkManagerImpl</code></h2><p><code>WorkManager</code> 的初始化逻辑最终会调用到 <code>WorkManagerImpl</code>的构造函数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">WorkManagerImpl</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@NonNull</span> Context context,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@NonNull</span> Configuration configuration,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@NonNull</span> TaskExecutor workTaskExecutor,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@NonNull</span> WorkDatabase database)</span> </span>&#123;</span><br><span class="line">    Context applicationContext = context.getApplicationContext();</span><br><span class="line">    Logger.setLogger(<span class="keyword">new</span> Logger.LogcatLogger(configuration.getMinimumLoggingLevel()));</span><br><span class="line">    <span class="comment">// 调度器</span></span><br><span class="line">    List&lt;Scheduler&gt; schedulers =</span><br><span class="line">            createSchedulers(applicationContext, configuration, workTaskExecutor);</span><br><span class="line">    <span class="comment">// 执行器</span></span><br><span class="line">    Processor processor = <span class="keyword">new</span> Processor(</span><br><span class="line">            context,</span><br><span class="line">            configuration,</span><br><span class="line">            workTaskExecutor,</span><br><span class="line">            database,</span><br><span class="line">            schedulers);</span><br><span class="line">    internalInit(context, configuration, workTaskExecutor, database, schedulers, processor);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">internalInit</span><span class="params">(<span class="meta">@NonNull</span> Context context,                       </span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@NonNull</span> Configuration configuration,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@NonNull</span> TaskExecutor workTaskExecutor,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@NonNull</span> WorkDatabase workDatabase,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@NonNull</span> List&lt;Scheduler&gt; schedulers,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@NonNull</span> Processor processor)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    context = context.getApplicationContext();</span><br><span class="line">    mContext = context;</span><br><span class="line">    <span class="comment">// workManager 的 config 配置，包含factory 等</span></span><br><span class="line">    mConfiguration = configuration;</span><br><span class="line">    <span class="comment">// 调度任务 线程</span></span><br><span class="line">    mWorkTaskExecutor = workTaskExecutor;</span><br><span class="line">    <span class="comment">// 默认是room 数据库，将任务信息以序列话的形式保存到本地</span></span><br><span class="line">    mWorkDatabase = workDatabase;</span><br><span class="line">    mSchedulers = schedulers;</span><br><span class="line">    mProcessor = processor;</span><br><span class="line">    mPreferenceUtils = <span class="keyword">new</span> PreferenceUtils(workDatabase);</span><br><span class="line">    mForceStopRunnableCompleted = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check for direct boot mode</span></span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.N &amp;&amp; context.isDeviceProtectedStorage()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Cannot initialize WorkManager in direct boot mode&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Checks for app force stops.</span></span><br><span class="line">  	<span class="comment">// 这个Runnable的作用就是在WorkManager初始化过程中，发现了未完成的，需要重新执行的任务，或者app被强制kill的情况下，直接对Scheduler进行调度。</span></span><br><span class="line">    mWorkTaskExecutor.executeOnBackgroundThread(<span class="keyword">new</span> ForceStopRunnable(context, <span class="keyword">this</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Scheduler"><a href="#Scheduler" class="headerlink" title="Scheduler"></a><code>Scheduler</code></h3><p><code>Scheduler</code>主要用来调度任务，可以分为2类：</p>
<ul>
<li>执行没有任何约束的非周期性的任务 <code>GreedyScheduler</code></li>
<li>执行周期性 或 有约束条件的任务<ul>
<li><code>SDK version &gt;= 23</code>时，则返回<code>SystemJobScheduler</code></li>
<li><code>SDK version &lt; 23</code>时，先尝试使用<code>GcmScheduler</code>进行管理。若无法创建<code>GcmScheduler</code>则创建<code>SystemAlarmScheduler</code>使用<code>AlamManager + 广播</code> 进行任务管理。</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Scheduler&gt; <span class="title">createSchedulers</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@NonNull</span> Context context,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@NonNull</span> Configuration configuration,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@NonNull</span> TaskExecutor taskExecutor)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Arrays.asList(</span><br><span class="line">            Schedulers.createBestAvailableBackgroundScheduler(context, <span class="keyword">this</span>),</span><br><span class="line">            <span class="comment">// Specify the task executor directly here as this happens before internalInit.</span></span><br><span class="line">            <span class="comment">// GreedyScheduler creates ConstraintTrackers and controllers eagerly.</span></span><br><span class="line">            <span class="keyword">new</span> GreedyScheduler(context, configuration, taskExecutor, <span class="keyword">this</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NonNull</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> Scheduler <span class="title">createBestAvailableBackgroundScheduler</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@NonNull</span> Context context,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@NonNull</span> WorkManagerImpl workManager)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    Scheduler scheduler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= WorkManagerImpl.MIN_JOB_SCHEDULER_API_LEVEL) &#123;</span><br><span class="line">        <span class="comment">// &gt; 23 使用</span></span><br><span class="line">        scheduler = <span class="keyword">new</span> SystemJobScheduler(context, workManager);</span><br><span class="line">        setComponentEnabled(context, SystemJobService.class, <span class="keyword">true</span>);</span><br><span class="line">        Logger.get().debug(TAG, <span class="string">&quot;Created SystemJobScheduler and enabled SystemJobService&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        scheduler = tryCreateGcmBasedScheduler(context);</span><br><span class="line">        <span class="keyword">if</span> (scheduler == <span class="keyword">null</span>) &#123;</span><br><span class="line">            scheduler = <span class="keyword">new</span> SystemAlarmScheduler(context);</span><br><span class="line">            setComponentEnabled(context, SystemAlarmService.class, <span class="keyword">true</span>);</span><br><span class="line">            Logger.get().debug(TAG, <span class="string">&quot;Created SystemAlarmScheduler&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> scheduler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总结下初始化过程：</p>
<img src="https://pic2.zhimg.com/v2-61b832aa9c912ffbeaec57769d166221_r.jpg" style="zoom:67%;" />

<ol>
<li><code>WorkManager</code>的初始化是在app冷启动后，由<code>WorkManagerInitializer</code>这个<code>ContentProvider</code>执行</li>
<li>初始化过程包含了对<code>Configuration/WorkManagerTaskExecutor/WorkDatabase/Schedulers/Processor</code>等的初始化。</li>
<li><code>Schedulers</code> 用来调度任务执行，根据SDK Version 创建不同的 <code>Scheduler</code>，最后再通过<code>Processor</code> 执行具体的任务。</li>
</ol>
<h1 id="二、WorkRequest创建"><a href="#二、WorkRequest创建" class="headerlink" title="二、WorkRequest创建"></a>二、<code>WorkRequest</code>创建</h1><p>创建任务时，我们通常是通过<code>WorkRequestBuilder</code>来构建，</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> request6 = OneTimeWorkRequestBuilder&lt;CallBackWorker&gt;().build()</span><br></pre></td></tr></table></figure>

<p>我们以<code>OneTimeWorkRequestBuilder</code>看下 <code>WorkRequest</code>的构建流程</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;<span class="keyword">reified</span> W : ListenableWorker&gt;</span> <span class="title">OneTimeWorkRequestBuilder</span><span class="params">()</span></span>:</span><br><span class="line">    <span class="comment">// OneTimeWorkRequest#Builder</span></span><br><span class="line">    OneTimeWorkRequest.Builder = OneTimeWorkRequest.Builder(W::<span class="keyword">class</span>.java)</span><br><span class="line"></span><br><span class="line"><span class="comment">// OneTimeWorkRequestBuilder#Builder</span></span><br><span class="line"><span class="keyword">public</span> Builder(<span class="meta">@NonNull</span> Class&lt;? extends ListenableWorker&gt; workerClass) &#123;</span><br><span class="line">       <span class="keyword">super</span>(workerClass);</span><br><span class="line">       mWorkSpec.inputMergerClassName = OverwritingInputMerger.<span class="keyword">class</span>.getName();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// WorkRequestBuilder#Builder</span></span><br><span class="line">Builder(<span class="meta">@NonNull</span> Class&lt;? extends ListenableWorker&gt; workerClass) &#123;</span><br><span class="line">    <span class="comment">// 生成 builder 的id</span></span><br><span class="line">    mId = UUID.randomUUID();</span><br><span class="line">    mWorkerClass = workerClass;</span><br><span class="line">    mWorkSpec = new WorkSpec(mId.toString(), workerClass.getName());</span><br><span class="line">    addTag(workerClass.getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>OneTimeWorkRequest</code>为builder对象创建了<code>WorkSpec</code>对象用来保存任务id和类名，其中</p>
<ul>
<li>id是通过UUID自动生成的，mId 会保存到 <code>WorkRequest</code>中</li>
<li>tag默认是通过类名生成的，外部也可调用addTag()方法设置标签</li>
<li>为<code>WorkSpec</code>设置了默认的任务输入流的合并规则：<code>OverwritingInputMerger</code></li>
</ul>
<h2 id="2-1、WorkSpec"><a href="#2-1、WorkSpec" class="headerlink" title="2.1、WorkSpec"></a>2.1、<code>WorkSpec</code></h2><p><code>WorkSpec</code> 包含了任务的详细信息，同时也是任务存储在数据库中的实体。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">WorkSpec</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> static <span class="keyword">final</span> String TAG = Logger.tagWithPrefix(<span class="string">&quot;WorkSpec&quot;</span>);</span><br><span class="line">    <span class="keyword">public</span> static <span class="keyword">final</span> long SCHEDULE_NOT_REQUESTED_YET = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ColumnInfo(name = <span class="meta-string">&quot;id&quot;</span>)</span></span><br><span class="line">    <span class="meta">@PrimaryKey</span></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="keyword">public</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ColumnInfo(name = <span class="meta-string">&quot;state&quot;</span>)</span></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="keyword">public</span> WorkInfo.State state = ENQUEUED;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ColumnInfo(name = <span class="meta-string">&quot;worker_class_name&quot;</span>)</span></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="keyword">public</span> String workerClassName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ColumnInfo(name = <span class="meta-string">&quot;input_merger_class_name&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> String inputMergerClassName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ColumnInfo(name = <span class="meta-string">&quot;input&quot;</span>)</span></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="keyword">public</span> Data input = Data.EMPTY;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ColumnInfo(name = <span class="meta-string">&quot;output&quot;</span>)</span></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="keyword">public</span> Data output = Data.EMPTY;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ColumnInfo(name = <span class="meta-string">&quot;initial_delay&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> long initialDelay;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ColumnInfo(name = <span class="meta-string">&quot;interval_duration&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> long intervalDuration;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ColumnInfo(name = <span class="meta-string">&quot;flex_duration&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> long flexDuration;</span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line">    <span class="keyword">public</span> WorkSpec(<span class="meta">@NonNull</span> String id, <span class="meta">@NonNull</span> String workerClassName) &#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.workerClassName = workerClassName;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="2-2、WorkRequest-build"><a href="#2-2、WorkRequest-build" class="headerlink" title="2.2、WorkRequest#build"></a>2.2、<code>WorkRequest#build</code></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="meta">@NonNull</span> <span class="function">W <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// buildInternal()方法返回了一个WorkRequest对象，这是个抽象方法</span></span><br><span class="line">    W returnValue = buildInternal();</span><br><span class="line">    Constraints constraints = mWorkSpec.constraints;</span><br><span class="line">    <span class="comment">// Create a new id and WorkSpec so this WorkRequest.Builder can be used multiple times.</span></span><br><span class="line">    mId = UUID.randomUUID();</span><br><span class="line">    mWorkSpec = <span class="keyword">new</span> WorkSpec(mWorkSpec);</span><br><span class="line">    mWorkSpec.id = mId.toString();</span><br><span class="line">    <span class="keyword">return</span> returnValue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// OneTimeWorkRequest#buildInternal</span></span><br><span class="line"><span class="meta">@NonNull</span> <span class="function">OneTimeWorkRequest <span class="title">buildInternal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mBackoffCriteriaSet</span><br><span class="line">            &amp;&amp; Build.VERSION.SDK_INT &gt;= <span class="number">23</span></span><br><span class="line">            &amp;&amp; mWorkSpec.constraints.requiresDeviceIdle()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                <span class="string">&quot;Cannot set backoff criteria on an idle mode job&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> OneTimeWorkRequest(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">OneTimeWorkRequest(Builder builder) &#123;</span><br><span class="line">    <span class="keyword">super</span>(builder.mId, builder.mWorkSpec, builder.mTags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">WorkRequest</span><span class="params">(<span class="meta">@NonNull</span> UUID id, <span class="meta">@NonNull</span> WorkSpec workSpec, <span class="meta">@NonNull</span> Set&lt;String&gt; tags)</span> </span>&#123;</span><br><span class="line">    mId = id;</span><br><span class="line">    mWorkSpec = workSpec;</span><br><span class="line">    mTags = tags;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>WorkRequest的创建是为了持有三个重要的成员变量。分别是：</p>
<ol>
<li>mId：由UUID生成的任务id。</li>
<li>mWorkSpec：每个任务的属性。</li>
<li>mTags：每个任务的标签。</li>
</ol>
<p>注意：<code>OneTimeWorkRequest#buildInternal</code>中为<code>Builder</code>创建了一个新的<code>WorkSpec</code>对象，并赋予了新的<code>UUID</code>。虽然与原先的<code>WorkSpec</code>对象中每个属性的值是一致的，但指向了不同的内存地址。这么做的目的是为了这个<code>Builder</code>对象可被重复利用。好了，现在我们一个任务的WorkRequest创建就完成了。</p>
<p><img src="/pics/v2-fdae66d3ef4c350fbb4298935a831e64_r.jpg" alt="request"></p>
<h1 id="三、任务的执行"><a href="#三、任务的执行" class="headerlink" title="三、任务的执行"></a>三、任务的执行</h1><p><code>WorkeRequest</code>任务创建完成后，下一步就是任务的执行了。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> request6 = OneTimeWorkRequestBuilder&lt;CallBackWorker&gt;().build()</span><br><span class="line">workManager.enqueue(request6)</span><br></pre></td></tr></table></figure>

<h2 id="3-1、workManager-enqueue"><a href="#3-1、workManager-enqueue" class="headerlink" title="3.1、workManager#enqueue"></a>3.1、<code>workManager#enqueue</code></h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Operation enqueue(<span class="meta">@NonNull</span> WorkRequest workRequest) &#123;</span><br><span class="line">    <span class="keyword">return</span> enqueue(Collections.singletonList(workRequest));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> Operation enqueue(</span><br><span class="line">            <span class="meta">@NonNull</span> List&lt;? extends WorkRequest&gt; requests) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This error is not being propagated as part of the Operation, as we want the</span></span><br><span class="line">        <span class="comment">// app to crash during development. Having no workRequests is always a developer error.</span></span><br><span class="line">        <span class="keyword">if</span> (requests.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> new IllegalArgumentException(</span><br><span class="line">                    <span class="string">&quot;enqueue needs at least one WorkRequest.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 创建WorkContinuationImpl 对象</span></span><br><span class="line">        <span class="keyword">return</span> new WorkContinuationImpl(<span class="keyword">this</span>, requests).enqueue();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>创建一个<code>WorkContinuationImpl</code>对象，再执行<code>enqueue</code>方法。</p>
<h3 id="WorkContinuationImpl"><a href="#WorkContinuationImpl" class="headerlink" title="WorkContinuationImpl"></a><code>WorkContinuationImpl</code></h3><p><code>WorkContinuationImpl</code>是<code>WorkContinuation</code>的子类。用来把多个<code>OneTimeWorkRequest</code>根据需求串行，并行或合并处理。我们熟悉的<code>then</code>，<code>enqueue</code>等都是这个类的方法。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> WorkContinuationImpl(<span class="meta">@NonNull</span> WorkManagerImpl workManagerImpl,</span><br><span class="line">        <span class="meta">@Nullable</span> String name,</span><br><span class="line">        <span class="meta">@NonNull</span> ExistingWorkPolicy existingWorkPolicy,</span><br><span class="line">        <span class="meta">@NonNull</span> List&lt;? extends WorkRequest&gt; work,</span><br><span class="line">        <span class="meta">@Nullable</span> List&lt;WorkContinuationImpl&gt; parents) &#123;</span><br><span class="line">    mWorkManagerImpl = workManagerImpl;</span><br><span class="line">    mName = name;</span><br><span class="line">    mExistingWorkPolicy = existingWorkPolicy;</span><br><span class="line">    mWork = work;</span><br><span class="line">    mParents = parents;</span><br><span class="line">    mIds = new ArrayList&lt;&gt;(mWork.size());</span><br><span class="line">    mAllIds = new ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (parents != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (WorkContinuationImpl parent : parents) &#123;</span><br><span class="line">            mAllIds.addAll(parent.mAllIds);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; work.size(); i++) &#123;</span><br><span class="line">        String id = work.<span class="keyword">get</span>(i).getStringId();</span><br><span class="line">        mIds.add(id);</span><br><span class="line">        mAllIds.add(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们继续看<code>enqueue</code> 方法的实现。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@NonNull</span> Operation enqueue() &#123;</span><br><span class="line">    <span class="comment">// Only enqueue if not already enqueued.</span></span><br><span class="line">    <span class="keyword">if</span> (!mEnqueued) &#123;</span><br><span class="line">        <span class="comment">// The runnable walks the hierarchy of the continuations</span></span><br><span class="line">        <span class="comment">// and marks them enqueued using the markEnqueued() method, parent first.</span></span><br><span class="line">        <span class="comment">// 1.创建 EnqueueRunnable</span></span><br><span class="line">        EnqueueRunnable runnable = new EnqueueRunnable(<span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">// 2.使用WorkManager的TaskExecutor执行 </span></span><br><span class="line">        mWorkManagerImpl.getWorkTaskExecutor().executeOnBackgroundThread(runnable);</span><br><span class="line">        mOperation = runnable.getOperation();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Logger.<span class="keyword">get</span>().warning(TAG,</span><br><span class="line">                String.format(<span class="string">&quot;Already enqueued work ids (%s)&quot;</span>, TextUtils.join(<span class="string">&quot;, &quot;</span>, mIds)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mOperation;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>WorkManager</code>的<code>TaskExecutor</code>执行<code>EnqueueRunnable</code>。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// EnqueueRunnable</span></span><br><span class="line"><span class="keyword">public</span> void run() &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mWorkContinuation.hasCycles()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> new IllegalStateException(</span><br><span class="line">                    String.format(<span class="string">&quot;WorkContinuation has cycles (%s)&quot;</span>, mWorkContinuation));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 1.将任务添加到 数据库 中</span></span><br><span class="line">        boolean needsScheduling = addToDatabase();</span><br><span class="line">        <span class="keyword">if</span> (needsScheduling) &#123;</span><br><span class="line">            <span class="comment">// Enable RescheduleReceiver, only when there are Worker&#x27;s that need scheduling.</span></span><br><span class="line">            <span class="keyword">final</span> Context context =</span><br><span class="line">                    mWorkContinuation.getWorkManagerImpl().getApplicationContext();</span><br><span class="line">            PackageManagerHelper.setComponentEnabled(context, RescheduleReceiver.<span class="keyword">class</span>, <span class="literal">true</span>);</span><br><span class="line">            <span class="comment">// 2.开始执行</span></span><br><span class="line">            scheduleWorkInBackground();</span><br><span class="line">        &#125;</span><br><span class="line">        mOperation.setState(Operation.SUCCESS);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable exception) &#123;</span><br><span class="line">        mOperation.setState(new Operation.State.FAILURE(exception));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> void scheduleWorkInBackground() &#123;</span><br><span class="line">    WorkManagerImpl workManager = mWorkContinuation.getWorkManagerImpl();</span><br><span class="line">    Schedulers.schedule(</span><br><span class="line">            workManager.getConfiguration(),</span><br><span class="line">            workManager.getWorkDatabase(),</span><br><span class="line">            workManager.getSchedulers());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Schedulers-schedule"><a href="#Schedulers-schedule" class="headerlink" title="Schedulers#schedule"></a><code>Schedulers#schedule</code></h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> static void schedule(</span><br><span class="line">        <span class="meta">@NonNull</span> Configuration configuration,</span><br><span class="line">        <span class="meta">@NonNull</span> WorkDatabase workDatabase,</span><br><span class="line">        List&lt;Scheduler&gt; schedulers) &#123;</span><br><span class="line">    <span class="keyword">if</span> (schedulers == <span class="literal">null</span> || schedulers.size() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    WorkSpecDao workSpecDao = workDatabase.workSpecDao();</span><br><span class="line">    <span class="comment">// 1、有限制条件的任务</span></span><br><span class="line">    List&lt;WorkSpec&gt; eligibleWorkSpecsForLimitedSlots;</span><br><span class="line">    <span class="comment">// 2、有限制条件的任务</span></span><br><span class="line">    List&lt;WorkSpec&gt; allEligibleWorkSpecs;</span><br><span class="line"></span><br><span class="line">    workDatabase.beginTransaction();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Enqueued workSpecs when scheduling limits are applicable.</span></span><br><span class="line">        eligibleWorkSpecsForLimitedSlots = workSpecDao.getEligibleWorkForScheduling(</span><br><span class="line">                configuration.getMaxSchedulerLimit());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Enqueued workSpecs when scheduling limits are NOT applicable.</span></span><br><span class="line">        allEligibleWorkSpecs = workSpecDao.getAllEligibleWorkSpecsForScheduling(</span><br><span class="line">                MAX_GREEDY_SCHEDULER_LIMIT);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        workDatabase.endTransaction();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (eligibleWorkSpecsForLimitedSlots != <span class="literal">null</span></span><br><span class="line">            &amp;&amp; eligibleWorkSpecsForLimitedSlots.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">        WorkSpec[] eligibleWorkSpecsArray =</span><br><span class="line">                new WorkSpec[eligibleWorkSpecsForLimitedSlots.size()];</span><br><span class="line">        eligibleWorkSpecsArray =</span><br><span class="line">                eligibleWorkSpecsForLimitedSlots.toArray(eligibleWorkSpecsArray);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Delegate to the underlying schedulers.</span></span><br><span class="line">        <span class="comment">// 3、执行有限制的周期任务</span></span><br><span class="line">        <span class="keyword">for</span> (Scheduler scheduler : schedulers) &#123;</span><br><span class="line">            <span class="keyword">if</span> (scheduler.hasLimitedSchedulingSlots()) &#123;</span><br><span class="line">                scheduler.schedule(eligibleWorkSpecsArray);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (allEligibleWorkSpecs != <span class="literal">null</span> &amp;&amp; allEligibleWorkSpecs.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        WorkSpec[] enqueuedWorkSpecsArray = new WorkSpec[allEligibleWorkSpecs.size()];</span><br><span class="line">        enqueuedWorkSpecsArray = allEligibleWorkSpecs.toArray(enqueuedWorkSpecsArray);</span><br><span class="line">        <span class="comment">// Delegate to the underlying schedulers.</span></span><br><span class="line">        <span class="keyword">for</span> (Scheduler scheduler : schedulers) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!scheduler.hasLimitedSchedulingSlots()) &#123;</span><br><span class="line">           			<span class="comment">// 4、执行无限制任务</span></span><br><span class="line">                scheduler.schedule(enqueuedWorkSpecsArray);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先进行了一系列的数据库操作，然后开始根据条件每个任务进行调度。其中eligibleWorkSpecs返回的是在ENQUEUED状态下，未被执行且未被取消的WorkSpec列表，然后更新这些任务的request状态到数据库。最后遍历schedulers调用scheduler.schedule()对每个任务进行调度处理。</p>
<p>先进行了一系列的数据库操作，然后开始根据条件每个任务进行调度。其中<code>eligibleWorkSpecs</code>返回的是在<code>ENQUEUED</code>状态下，未被执行且未被取消的<code>WorkSpec</code>列表，然后更新这些任务的状态到数据库。最后遍历<code>schedulers</code>调用<code>scheduler.schedule</code>对每个任务进行调度处理。</p>
<h2 id="3-2、无限制条件任务的执行"><a href="#3-2、无限制条件任务的执行" class="headerlink" title="3.2、无限制条件任务的执行"></a>3.2、无限制条件任务的执行</h2><h3 id="GreedyScheduler-schedule"><a href="#GreedyScheduler-schedule" class="headerlink" title="GreedyScheduler#schedule"></a><code>GreedyScheduler#schedule</code></h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> void schedule(<span class="meta">@NonNull</span> WorkSpec... workSpecs) &#123;</span><br><span class="line">    <span class="keyword">if</span> (mInDefaultProcess == <span class="literal">null</span>) &#123;</span><br><span class="line">        checkDefaultProcess();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mInDefaultProcess) &#123;</span><br><span class="line">        Logger.<span class="keyword">get</span>().info(TAG, <span class="string">&quot;Ignoring schedule request in a secondary process&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    registerExecutionListenerIfNeeded();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Keep track of the list of new WorkSpecs whose constraints need to be tracked.</span></span><br><span class="line">    <span class="comment">// Add them to the known list of constrained WorkSpecs and call replace() on</span></span><br><span class="line">    <span class="comment">// WorkConstraintsTracker. That way we only need to synchronize on the part where we</span></span><br><span class="line">    <span class="comment">// are updating mConstrainedWorkSpecs.</span></span><br><span class="line">    Set&lt;WorkSpec&gt; constrainedWorkSpecs = new HashSet&lt;&gt;();</span><br><span class="line">    Set&lt;String&gt; constrainedWorkSpecIds = new HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (WorkSpec workSpec : workSpecs) &#123;</span><br><span class="line">        long nextRunTime = workSpec.calculateNextRunTime();</span><br><span class="line">        long now = System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// 1、WorkSpec是ENQUEUED的状态</span></span><br><span class="line">        <span class="keyword">if</span> (workSpec.state == WorkInfo.State.ENQUEUED) &#123;</span><br><span class="line">            <span class="comment">//2、非延迟执行</span></span><br><span class="line">            <span class="keyword">if</span> (now &lt; nextRunTime) &#123;</span><br><span class="line">                <span class="comment">// Future work</span></span><br><span class="line">                <span class="keyword">if</span> (mDelayedWorkTracker != <span class="literal">null</span>) &#123;</span><br><span class="line">                    mDelayedWorkTracker.schedule(workSpec);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (workSpec.hasConstraints()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (SDK_INT &gt;= <span class="number">23</span> &amp;&amp; workSpec.constraints.requiresDeviceIdle()) &#123;</span><br><span class="line">                    <span class="comment">// Ignore requests that have an idle mode constraint.</span></span><br><span class="line">                    Logger.<span class="keyword">get</span>().debug(TAG,</span><br><span class="line">                            String.format(<span class="string">&quot;Ignoring WorkSpec %s, Requires device idle.&quot;</span>,</span><br><span class="line">                                    workSpec));</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SDK_INT &gt;= <span class="number">24</span> &amp;&amp; workSpec.constraints.hasContentUriTriggers()) &#123;</span><br><span class="line">                    <span class="comment">// Ignore requests that have content uri triggers.</span></span><br><span class="line">                    Logger.<span class="keyword">get</span>().debug(TAG,</span><br><span class="line">                            String.format(<span class="string">&quot;Ignoring WorkSpec %s, Requires ContentUri triggers.&quot;</span>,</span><br><span class="line">                                    workSpec));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    constrainedWorkSpecs.add(workSpec);</span><br><span class="line">                    constrainedWorkSpecIds.add(workSpec.id);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Logger.<span class="keyword">get</span>().debug(TAG, String.format(<span class="string">&quot;Starting work for %s&quot;</span>, workSpec.id));</span><br><span class="line">                <span class="comment">// 3、开始执行任务</span></span><br><span class="line">                mWorkManagerImpl.startWork(workSpec.id);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> <code>WorkSpec</code>是ENQUEUED的状态 &amp; 非延迟任务，调用<code>WorkManagerImpl</code>执行。</p>
<h3 id="WorkManager-startWork"><a href="#WorkManager-startWork" class="headerlink" title="WorkManager#startWork"></a><code>WorkManager#startWork</code></h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> void startWork(<span class="meta">@NonNull</span> String workSpecId) &#123;</span><br><span class="line">    startWork(workSpecId, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> void startWork(</span><br><span class="line">        <span class="meta">@NonNull</span> String workSpecId,</span><br><span class="line">        <span class="meta">@Nullable</span> WorkerParameters.RuntimeExtras runtimeExtras) &#123;</span><br><span class="line">    mWorkTaskExecutor</span><br><span class="line">            .executeOnBackgroundThread(</span><br><span class="line">                    new StartWorkRunnable(<span class="keyword">this</span>, workSpecId, runtimeExtras));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用<code>WorkTaskExecutor</code> 执行<code>StartWorkRunnable</code></p>
<h3 id="StartWorkRunnable-run"><a href="#StartWorkRunnable-run" class="headerlink" title="StartWorkRunnable#run"></a><code>StartWorkRunnable#run</code></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void run() &#123;</span><br><span class="line">    mWorkManagerImpl.getProcessor().startWork(mWorkSpecId, mRuntimeExtras);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>StartWorkRunnable</code>会将任务的信息交给<code>Processor</code>，由<code>Processor#startWork</code>执行任务:</p>
<h3 id="Processor-startWork"><a href="#Processor-startWork" class="headerlink" title="Processor#startWork"></a><code>Processor#startWork</code></h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> boolean startWork(</span><br><span class="line">        <span class="meta">@NonNull</span> String id,</span><br><span class="line">        <span class="meta">@Nullable</span> WorkerParameters.RuntimeExtras runtimeExtras) &#123;</span><br><span class="line"></span><br><span class="line">    WorkerWrapper workWrapper;</span><br><span class="line">    synchronized (mLock) &#123;</span><br><span class="line">        <span class="comment">// Work may get triggered multiple times if they have passing constraints</span></span><br><span class="line">        <span class="comment">// and new work with those constraints are added.</span></span><br><span class="line">        <span class="keyword">if</span> (isEnqueued(id)) &#123;</span><br><span class="line">            Logger.<span class="keyword">get</span>().debug(</span><br><span class="line">                    TAG,</span><br><span class="line">                    String.format(<span class="string">&quot;Work %s is already enqueued for processing&quot;</span>, id));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">				<span class="comment">//1、构建 workWrapper</span></span><br><span class="line">        workWrapper =</span><br><span class="line">                new WorkerWrapper.Builder(</span><br><span class="line">                        mAppContext,</span><br><span class="line">                        mConfiguration,</span><br><span class="line">                        mWorkTaskExecutor,</span><br><span class="line">                        <span class="keyword">this</span>,</span><br><span class="line">                        mWorkDatabase,</span><br><span class="line">                        id)</span><br><span class="line">                        .withSchedulers(mSchedulers)</span><br><span class="line">                        .withRuntimeExtras(runtimeExtras)</span><br><span class="line">                        .build();</span><br><span class="line">        </span><br><span class="line">        ListenableFuture&lt;<span class="built_in">Boolean</span>&gt; future = workWrapper.getFuture();</span><br><span class="line">        future.addListener(</span><br><span class="line">                <span class="comment">// 2、在 workWrapper 执行完成后 执行 FutureListener</span></span><br><span class="line">                new FutureListener(<span class="keyword">this</span>, id, future),</span><br><span class="line">                mWorkTaskExecutor.getMainThreadExecutor());</span><br><span class="line">        mEnqueuedWorkMap.put(id, workWrapper);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3、执行workWrapper</span></span><br><span class="line">    mWorkTaskExecutor.getBackgroundExecutor().execute(workWrapper);</span><br><span class="line">    Logger.<span class="keyword">get</span>().debug(TAG, String.format(<span class="string">&quot;%s: processing %s&quot;</span>, getClass().getSimpleName(), id));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建了一个<code>WorkerWrapper</code>对象，交由<code>WorkTaskExecutor</code>调度处理。</p>
<h3 id="WorkerWrapper-run"><a href="#WorkerWrapper-run" class="headerlink" title="WorkerWrapper#run"></a><code>WorkerWrapper#run</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WorkerThread</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mTags = mWorkTagDao.getTagsForWorkSpecId(mWorkSpecId);</span><br><span class="line">    mWorkDescription = createWorkDescription(mTags);</span><br><span class="line">    <span class="comment">// 执行runWorker</span></span><br><span class="line">    runWorker();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">runWorker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tryCheckForInterruptionAndResolve()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mWorkDatabase.beginTransaction();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 1、从数据库中查找任务</span></span><br><span class="line">        mWorkSpec = mWorkSpecDao.getWorkSpec(mWorkSpecId);</span><br><span class="line">        mWorkDatabase.setTransactionSuccessful();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mWorkDatabase.endTransaction();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">		<span class="comment">// 2、组装 WorkerParameters</span></span><br><span class="line">    <span class="keyword">final</span> WorkerParameters params = <span class="keyword">new</span> WorkerParameters(</span><br><span class="line">            UUID.fromString(mWorkSpecId),</span><br><span class="line">            input,</span><br><span class="line">            mTags,</span><br><span class="line">            mRuntimeExtras,</span><br><span class="line">            mWorkSpec.runAttemptCount,</span><br><span class="line">            mConfiguration.getExecutor(),</span><br><span class="line">            mWorkTaskExecutor,</span><br><span class="line">            mConfiguration.getWorkerFactory(),</span><br><span class="line">            <span class="keyword">new</span> WorkProgressUpdater(mWorkDatabase, mWorkTaskExecutor),</span><br><span class="line">            <span class="keyword">new</span> WorkForegroundUpdater(mWorkDatabase, mForegroundProcessor, mWorkTaskExecutor));</span><br><span class="line"></span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line">    <span class="keyword">if</span> (trySetRunning()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (tryCheckForInterruptionAndResolve()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">				<span class="comment">// 3、构造future 对象用来做任务调度</span></span><br><span class="line">        <span class="keyword">final</span> SettableFuture&lt;ListenableWorker.Result&gt; future = SettableFuture.create();</span><br><span class="line">        <span class="comment">// 4、构造 WorkForegroundRunnable</span></span><br><span class="line">        <span class="keyword">final</span> WorkForegroundRunnable foregroundRunnable =</span><br><span class="line">                <span class="keyword">new</span> WorkForegroundRunnable(</span><br><span class="line">                        mAppContext,</span><br><span class="line">                        mWorkSpec,</span><br><span class="line">                        mWorker,</span><br><span class="line">                        params.getForegroundUpdater(),</span><br><span class="line">                        mWorkTaskExecutor</span><br><span class="line">                );</span><br><span class="line">        <span class="comment">// 5、主线程中执行 foregroundRunnable</span></span><br><span class="line">        mWorkTaskExecutor.getMainThreadExecutor().execute(foregroundRunnable);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6、获取 foregroundRunnable的future 对象</span></span><br><span class="line">        <span class="keyword">final</span> ListenableFuture&lt;Void&gt; runExpedited = foregroundRunnable.getFuture();</span><br><span class="line">        runExpedited.addListener(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 7、等待 foregroundRunnable 执行完成</span></span><br><span class="line">                    runExpedited.get();</span><br><span class="line">                    Logger.get().debug(TAG,</span><br><span class="line">                            String.format(<span class="string">&quot;Starting work for %s&quot;</span>, mWorkSpec.workerClassName));</span><br><span class="line">                    <span class="comment">// Call mWorker.startWork() on the main thread.</span></span><br><span class="line">                    <span class="comment">// 8、执行任务，会进一步调用到Worker#doWork</span></span><br><span class="line">                    mInnerFuture = mWorker.startWork();</span><br><span class="line">                    <span class="comment">// 9、将future </span></span><br><span class="line">                    future.setFuture(mInnerFuture);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    future.setException(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, mWorkTaskExecutor.getMainThreadExecutor());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Avoid synthetic accessors.</span></span><br><span class="line">        <span class="keyword">final</span> String workDescription = mWorkDescription;</span><br><span class="line">        future.addListener(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="meta">@SuppressLint(&quot;SyntheticAccessor&quot;)</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// If the ListenableWorker returns a null result treat it as a failure.            // 10、等待后台任务返回结果</span></span><br><span class="line">                    ListenableWorker.Result result = future.get();</span><br><span class="line">                    <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        Logger.get().error(TAG, String.format(</span><br><span class="line">                                <span class="string">&quot;%s returned a null result. Treating it as a failure.&quot;</span>,</span><br><span class="line">                                mWorkSpec.workerClassName));</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        Logger.get().debug(TAG, String.format(<span class="string">&quot;%s returned a %s result.&quot;</span>,</span><br><span class="line">                                mWorkSpec.workerClassName, result));</span><br><span class="line">                        mResult = result;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (CancellationException exception) &#123;</span><br><span class="line">                    <span class="comment">// Cancellations need to be treated with care here because innerFuture</span></span><br><span class="line">                    <span class="comment">// cancellations will bubble up, and we need to gracefully handle that.</span></span><br><span class="line">                    Logger.get().info(TAG, String.format(<span class="string">&quot;%s was cancelled&quot;</span>, workDescription),</span><br><span class="line">                            exception);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException exception) &#123;</span><br><span class="line">                    Logger.get().error(TAG,</span><br><span class="line">                            String.format(<span class="string">&quot;%s failed because it threw an exception/error&quot;</span>,</span><br><span class="line">                                    workDescription), exception);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">// 11、后台任务执行完成回调</span></span><br><span class="line">                    onWorkFinished();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, mWorkTaskExecutor.getBackgroundExecutor());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resolveIncorrectStatus();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Worker 的执行过程涉及到比较复杂的线程调度，主要利用了<code>SettableFuture</code>和<code>ListenableFuture</code>的2个特性。    </p>
<ol>
<li><code>future#get</code>会阻塞当前线程的执行<ol start="2">
<li>addListener监听方法，当任务执行完成，会主动回调该方法</li>
</ol>
</li>
</ol>
<p>我们通过一张时序图来看下。</p>
<p><img src="/pics/image-20220528180120396.png" alt="image-20220528180120396"></p>
<p>run 方法的执行过程会涉及到3个线程的切换：</p>
<ol>
<li>Task 线程主要用来调度任务</li>
<li>主线程，获取 前台服务 的信息，任务执行完成回调到Processor 中</li>
<li>worker线程，执行后台任务</li>
</ol>
<h3 id="WorkerWrapper-onWorkFinished"><a href="#WorkerWrapper-onWorkFinished" class="headerlink" title="WorkerWrapper#onWorkFinished"></a><code>WorkerWrapper#onWorkFinished</code></h3><p><code>onWorkFinished</code>会对执行完毕的任务根据state作进一步处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">onWorkFinished</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!tryCheckForInterruptionAndResolve()) &#123;</span><br><span class="line">        mWorkDatabase.beginTransaction();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            WorkInfo.State state = mWorkSpecDao.getState(mWorkSpecId);</span><br><span class="line">            mWorkDatabase.workProgressDao().delete(mWorkSpecId);</span><br><span class="line">            <span class="keyword">if</span> (state == <span class="keyword">null</span>) &#123;</span><br><span class="line">                resolve(<span class="keyword">false</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == RUNNING) &#123;</span><br><span class="line">               <span class="comment">// 正常走这里</span></span><br><span class="line">                handleResult(mResult);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!state.isFinished()) &#123;</span><br><span class="line">                rescheduleAndResolve();</span><br><span class="line">            &#125;</span><br><span class="line">            mWorkDatabase.setTransactionSuccessful();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            mWorkDatabase.endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// handleResult()执行完毕后更新isWorkFinished。如果isWorkFinished为true，由于我们在GreedyScheduler已经处理了这个任务，为了避免这个任务被其他schedulers处理，WorkManager遍历了mSchedulers列表，并将这个任务从其他schedulers中移除。最后再次执行Schedulers.schedule()方法，schedule下一个任务。</span></span><br><span class="line">     <span class="keyword">if</span> (mSchedulers != <span class="keyword">null</span>) &#123;</span><br><span class="line">     <span class="keyword">for</span> (Scheduler scheduler : mSchedulers) &#123;</span><br><span class="line">         scheduler.cancel(mWorkSpecId);</span><br><span class="line">     &#125;</span><br><span class="line">     Schedulers.schedule(mConfiguration, mWorkDatabase, mSchedulers);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据任务的最终状态进行处理</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleResult</span><span class="params">(ListenableWorker.Result result)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (result <span class="keyword">instanceof</span> ListenableWorker.Result.Success) &#123;</span><br><span class="line">        Logger.get().info(</span><br><span class="line">                TAG,</span><br><span class="line">                String.format(<span class="string">&quot;Worker result SUCCESS for %s&quot;</span>, mWorkDescription));</span><br><span class="line">        <span class="keyword">if</span> (mWorkSpec.isPeriodic()) &#123;</span><br><span class="line">            resetPeriodicAndResolve();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            setSucceededAndResolve();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result <span class="keyword">instanceof</span> ListenableWorker.Result.Retry) &#123;</span><br><span class="line">        Logger.get().info(</span><br><span class="line">                TAG,</span><br><span class="line">                String.format(<span class="string">&quot;Worker result RETRY for %s&quot;</span>, mWorkDescription));</span><br><span class="line">        rescheduleAndResolve();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Logger.get().info(</span><br><span class="line">                TAG,</span><br><span class="line">                String.format(<span class="string">&quot;Worker result FAILURE for %s&quot;</span>, mWorkDescription));</span><br><span class="line">        <span class="keyword">if</span> (mWorkSpec.isPeriodic()) &#123;</span><br><span class="line">            resetPeriodicAndResolve();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            setFailedAndResolve();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>handleResult</code>方法中会根据任务类型和result结果进行不同的处理。例如周期性的任务会重新将这个任务的状态设置为ENQUEUED，更新其他相关参数，并更新数据库。具体的处理的过程就不展开了。</p>
<h2 id="3-3、有限制条件任务的执行"><a href="#3-3、有限制条件任务的执行" class="headerlink" title="3.3、有限制条件任务的执行"></a>3.3、有限制条件任务的执行</h2><p>上面我们分析了没有约束条件的一次性任务的执行过程。下面分析下有约束任务的执行。</p>
<p>创建一个非低电量才能执行的任务：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> constraints = Constraints.Builder()</span><br><span class="line">                .setRequiresBatteryNotLow(<span class="literal">true</span>)</span><br><span class="line">                .build()</span><br><span class="line"><span class="keyword">val</span> work2Request = OneTimeWorkRequestBuilder&lt;Worker2&gt;()</span><br><span class="line">                .setConstraints(constraints)</span><br><span class="line">                .build()</span><br><span class="line">WorkManager.getInstance(<span class="keyword">this</span>).enqueue(work2Request)</span><br></pre></td></tr></table></figure>

<p>任务的创建过程中，会为WorkSpec添加Constraints属性。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public final @NonNull B setConstraints(@NonNull Constraints constraints) &#123;</span><br><span class="line">            mWorkSpec.constraints = constraints;</span><br><span class="line">            return getThis();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>在任务执行的过程中，由于增加了约束条件，根据之前章节的分析，常驻的<code>GreedyScheduler#schedule</code>方法将不会执行，而是根据<code>SDKVersion</code>交由<code>SystemJobScheduler</code>或<code>SystemAlarmScheduler</code>进行处理。先来看使用<code>SystemJobScheduler</code>的情况：</p>
<h3 id="SystemJobScheduler-Version-gt-23"><a href="#SystemJobScheduler-Version-gt-23" class="headerlink" title="SystemJobScheduler(Version &gt;=23)"></a><code>SystemJobScheduler(Version &gt;=23)</code></h3><p><code>SystemJobScheduler</code>使用的是<code>JobScheduler</code>来调度执行任务。<code>WorkManager</code>是如何使用JobScheduler进行任务调度的。<code>JobScheduler</code>的分析<a target="_blank" rel="noopener" href="http://gityuan.com/2017/03/10/job_scheduler_service/%E3%80%82">http://gityuan.com/2017/03/10/job_scheduler_service/。</a></p>
<p><code>SystemJobScheduler</code></p>
<h4 id="SystemJobService"><a href="#SystemJobService" class="headerlink" title="SystemJobService"></a><code>SystemJobService</code></h4><p> <code>SystemJobService</code>是执行任务的服务类，在onStartJob中，会调用<code>WorkManagerImpl#startWork</code>执行任务。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">//SystemJobService</span><br><span class="line">@Override</span><br><span class="line">public boolean onStartJob(@NonNull JobParameters params) &#123;</span><br><span class="line">    ... ...</span><br><span class="line"></span><br><span class="line">    String workSpecId = getWorkSpecIdFromJobParameters(params);</span><br><span class="line">    ... ...</span><br><span class="line"></span><br><span class="line">    synchronized (mJobParameters) &#123;</span><br><span class="line">       ... ...</span><br><span class="line">        mJobParameters.put(workSpecId, params);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ...</span><br><span class="line">    mWorkManagerImpl.startWork(workSpecId, runtimeExtras);</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>startWork</code>的逻辑前面分析过了，这一次不同的是会调用到<code>SystemJobScheduler#schedule</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SystemJobScheduler</span><span class="params">(<span class="meta">@NonNull</span> Context context, <span class="meta">@NonNull</span> WorkManagerImpl workManager)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(context,</span><br><span class="line">            workManager,</span><br><span class="line">             <span class="comment">// 初始化SystemJobScheduler的时候会获取JobScheduler对象</span></span><br><span class="line">            (JobScheduler) context.getSystemService(JOB_SCHEDULER_SERVICE),</span><br><span class="line">            <span class="keyword">new</span> SystemJobInfoConverter(context));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">schedule</span><span class="params">(<span class="meta">@NonNull</span> WorkSpec... workSpecs)</span> </span>&#123;</span><br><span class="line">    WorkDatabase workDatabase = mWorkManager.getWorkDatabase();</span><br><span class="line">    IdGenerator idGenerator = <span class="keyword">new</span> IdGenerator(workDatabase);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (WorkSpec workSpec : workSpecs) &#123;</span><br><span class="line">        workDatabase.beginTransaction();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">// ...</span></span><br><span class="line">            <span class="comment">// </span></span><br><span class="line">            scheduleInternal(workSpec, jobId);</span><br><span class="line">					  <span class="comment">// ...</span></span><br><span class="line">            workDatabase.setTransactionSuccessful();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            workDatabase.endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SystemJobScheduler</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scheduleInternal</span><span class="params">(WorkSpec workSpec, <span class="keyword">int</span> jobId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1、将workspec 任务转化成 JobInfo 任务</span></span><br><span class="line">    JobInfo jobInfo = mSystemJobInfoConverter.convert(workSpec, jobId);</span><br><span class="line">    Logger.get().debug(</span><br><span class="line">            TAG,</span><br><span class="line">            String.format(<span class="string">&quot;Scheduling work ID %s Job ID %s&quot;</span>, workSpec.id, jobId));</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 2、使用JobScheduler 调度任务</span></span><br><span class="line">        mJobScheduler.schedule(jobInfo);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalStateException e) &#123;</span><br><span class="line">        ... ...</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(message, e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">        Logger.get().error(TAG, String.format(<span class="string">&quot;Unable to schedule %s&quot;</span>, workSpec), throwable);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SystemJobInfoConverter.convert</code>方法就是创建了一个<code>JobInfo</code>，并将<code>Constraints</code>里的约束条件赋予<code>JobInfo</code>对象，之后便执行了<code>JobScheduler.schedule</code>，根据约束条件对任务进行调度。</p>
<h3 id="SystemAlarmScheduler-Version-lt-23"><a href="#SystemAlarmScheduler-Version-lt-23" class="headerlink" title="SystemAlarmScheduler(Version &lt;23)"></a><code>SystemAlarmScheduler(Version &lt;23)</code></h3><p><code>SystemAlarmScheduler</code>使用的是<code>AlarmManager + Receviver</code>来调度执行任务。<code>WorkManager会</code>在mainfest中注册广播，我们以网络广播为例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;receiver    android:name=<span class="string">&quot;androidx.work.impl.background.systemalarm.ConstraintProxy$NetworkStateProxy&quot;</span></span><br><span class="line">    android:directBootAware=<span class="string">&quot;false&quot;</span></span><br><span class="line">    android:enabled=<span class="string">&quot;false&quot;</span></span><br><span class="line">    android:exported=<span class="string">&quot;false&quot;</span></span><br><span class="line">    tools:targetApi=<span class="string">&quot;n&quot;</span> &gt;</span><br><span class="line">    &lt;intent-filter&gt;</span><br><span class="line">        &lt;action android:name=<span class="string">&quot;android.net.conn.CONNECTIVITY_CHANGE&quot;</span> /&gt;</span><br><span class="line">    &lt;/intent-filter&gt;</span><br><span class="line">&lt;/receiver&gt;</span><br></pre></td></tr></table></figure>

<p>在网络变化时，收到的<code>CONNECTIVITY_CHANGE</code>广播，在<code>NetworkStateProxy</code>的<code>onReceive</code>进行处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ConstraintProxy</span> <span class="keyword">extends</span> <span class="title">BroadcastReceiver</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = Logger.tagWithPrefix(<span class="string">&quot;ConstraintProxy&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">        Logger.get().debug(TAG, String.format(<span class="string">&quot;onReceive : %s&quot;</span>, intent));</span><br><span class="line">        Intent constraintChangedIntent = CommandHandler.createConstraintsChangedIntent(context);</span><br><span class="line">      <span class="comment">// 启动SystemAlarmService</span></span><br><span class="line">        context.startService(constraintChangedIntent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">NetworkStateProxy</span> <span class="keyword">extends</span> <span class="title">ConstraintProxy</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 创建 action</span></span><br><span class="line">   <span class="function"><span class="keyword">static</span> Intent <span class="title">createConstraintsChangedIntent</span><span class="params">(<span class="meta">@NonNull</span> Context context)</span> </span>&#123;</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent(context, SystemAlarmService.class);</span><br><span class="line">        intent.setAction(ACTION_CONSTRAINTS_CHANGED);</span><br><span class="line">        <span class="keyword">return</span> intent;</span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动<code>SystemAlarmService</code>进行处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> SystemAlarmDispatcher mDispatcher;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onStartCommand(intent, flags, startId);</span><br><span class="line">    <span class="keyword">if</span> (mIsShutdown) &#123;</span><br><span class="line">        Logger.get().info(TAG,</span><br><span class="line">                <span class="string">&quot;Re-initializing SystemAlarmDispatcher after a request to shut-down.&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Destroy the old dispatcher to complete it&#x27;s lifecycle.</span></span><br><span class="line">        mDispatcher.onDestroy();</span><br><span class="line">        <span class="comment">// Create a new dispatcher to setup a new lifecycle.</span></span><br><span class="line">        initializeDispatcher();</span><br><span class="line">        <span class="comment">// Set mIsShutdown to false, to correctly accept new commands.</span></span><br><span class="line">        mIsShutdown = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (intent != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// SystemAlarmDispatcher # add </span></span><br><span class="line">        mDispatcher.add(intent, startId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the service were to crash, we want all unacknowledged Intents to get redelivered.</span></span><br><span class="line">    <span class="keyword">return</span> Service.START_REDELIVER_INTENT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用到 <code>SystemAlarmDispatcher#add</code> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(<span class="meta">@NonNull</span> <span class="keyword">final</span> Intent intent, <span class="keyword">final</span> <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">    Logger.get().debug(TAG, String.format(<span class="string">&quot;Adding command %s (%s)&quot;</span>, intent, startId));</span><br><span class="line">    assertMainThread();</span><br><span class="line">    String action = intent.getAction();</span><br><span class="line">    <span class="keyword">if</span> (TextUtils.isEmpty(action)) &#123;</span><br><span class="line">        Logger.get().warning(TAG, <span class="string">&quot;Unknown command. Ignoring&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (CommandHandler.ACTION_CONSTRAINTS_CHANGED.equals(action)</span><br><span class="line">            &amp;&amp; hasIntentWithAction(CommandHandler.ACTION_CONSTRAINTS_CHANGED)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    intent.putExtra(KEY_START_ID, startId);</span><br><span class="line">    <span class="keyword">synchronized</span> (mIntents) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> hasCommands = !mIntents.isEmpty();</span><br><span class="line">        mIntents.add(intent);</span><br><span class="line">        <span class="keyword">if</span> (!hasCommands) &#123;</span><br><span class="line">						<span class="comment">// 执行</span></span><br><span class="line">            processCommand();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>processCommand</code>中继续处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processCommand</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    assertMainThread();</span><br><span class="line">    PowerManager.WakeLock processCommandLock =</span><br><span class="line">            WakeLocks.newWakeLock(mContext, PROCESS_COMMAND_TAG);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        processCommandLock.acquire();</span><br><span class="line">        <span class="comment">// Process commands on the background thread.</span></span><br><span class="line">        mWorkManager.getWorkTaskExecutor().executeOnBackgroundThread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">												<span class="comment">// 调用</span></span><br><span class="line">                        mCommandHandler.onHandleIntent(mCurrentIntent, startId,</span><br><span class="line">                                SystemAlarmDispatcher.<span class="keyword">this</span>);</span><br><span class="line">              <span class="comment">//...</span></span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="CommandHandler-onHandleIntent"><a href="#CommandHandler-onHandleIntent" class="headerlink" title="CommandHandler#onHandleIntent"></a><code>CommandHandler#onHandleIntent</code></h4><p>调用过来后，此时的action是 <code>ACTION_CONSTRAINTS_CHANGE</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">onHandleIntent</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@NonNull</span> Intent intent,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">int</span> startId,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@NonNull</span> SystemAlarmDispatcher dispatcher)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    String action = intent.getAction();</span><br><span class="line">		<span class="comment">// 此时的action是 ACTION_CONSTRAINTS_CHANGED</span></span><br><span class="line">    <span class="keyword">if</span> (ACTION_CONSTRAINTS_CHANGED.equals(action)) &#123;</span><br><span class="line">        handleConstraintsChanged(intent, startId, dispatcher);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ACTION_RESCHEDULE.equals(action)) &#123;</span><br><span class="line">        handleReschedule(intent, startId, dispatcher);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Bundle extras = intent.getExtras();</span><br><span class="line">        <span class="keyword">if</span> (!hasKeys(extras, KEY_WORKSPEC_ID)) &#123;</span><br><span class="line">            Logger.get().error(TAG,</span><br><span class="line">                    String.format(<span class="string">&quot;Invalid request for %s, requires %s.&quot;</span>,</span><br><span class="line">                            action,</span><br><span class="line">                            KEY_WORKSPEC_ID));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (ACTION_SCHEDULE_WORK.equals(action)) &#123;</span><br><span class="line">                handleScheduleWorkIntent(intent, startId, dispatcher);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ACTION_DELAY_MET.equals(action)) &#123;</span><br><span class="line">                handleDelayMet(intent, startId, dispatcher);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ACTION_STOP_WORK.equals(action)) &#123;</span><br><span class="line">                handleStopWork(intent, dispatcher);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ACTION_EXECUTION_COMPLETED.equals(action)) &#123;</span><br><span class="line">                handleExecutionCompleted(intent, startId);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Logger.get().warning(TAG, String.format(<span class="string">&quot;Ignoring intent %s&quot;</span>, intent));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>处理<code>ACTION_CONSTRAINTS_CHANGE</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleConstraintsChanged</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@NonNull</span> Intent intent, <span class="keyword">int</span> startId,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@NonNull</span> SystemAlarmDispatcher dispatcher)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">    ConstraintsCommandHandler changedCommandHandler =</span><br><span class="line">            <span class="keyword">new</span> ConstraintsCommandHandler(mContext, startId, dispatcher);</span><br><span class="line">  <span class="comment">// 调用  </span></span><br><span class="line">  changedCommandHandler.handleConstraintsChanged();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handleConstraintsChanged</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1.从数据中查找需要执行的任务</span></span><br><span class="line">    List&lt;WorkSpec&gt; candidates = mDispatcher.getWorkManager().getWorkDatabase()</span><br><span class="line">            .workSpecDao()</span><br><span class="line">            .getScheduledWork();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update constraint proxy to potentially disable proxies for previously</span></span><br><span class="line">    <span class="comment">// completed WorkSpecs.</span></span><br><span class="line">    ConstraintProxy.updateAll(mContext, candidates);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This needs to be done to populate matching WorkSpec ids in every constraint controller.</span></span><br><span class="line">    mWorkConstraintsTracker.replace(candidates);</span><br><span class="line"></span><br><span class="line">    List&lt;WorkSpec&gt; eligibleWorkSpecs = <span class="keyword">new</span> ArrayList&lt;&gt;(candidates.size());</span><br><span class="line">    <span class="comment">// Filter candidates should have already been scheduled.</span></span><br><span class="line">    <span class="comment">// 2.过滤任务</span></span><br><span class="line">    <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">for</span> (WorkSpec workSpec : candidates) &#123;</span><br><span class="line">        String workSpecId = workSpec.id;</span><br><span class="line">        <span class="keyword">long</span> triggerAt = workSpec.calculateNextRunTime();</span><br><span class="line">        <span class="keyword">if</span> (now &gt;= triggerAt &amp;&amp; (!workSpec.hasConstraints()</span><br><span class="line">                || mWorkConstraintsTracker.areAllConstraintsMet(workSpecId))) &#123;</span><br><span class="line">            eligibleWorkSpecs.add(workSpec);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (WorkSpec workSpec : eligibleWorkSpecs) &#123;</span><br><span class="line">        String workSpecId = workSpec.id;</span><br><span class="line">        <span class="comment">// 3.创建 intent</span></span><br><span class="line">        Intent intent = CommandHandler.createDelayMetIntent(mContext, workSpecId);</span><br><span class="line">        Logger.get().debug(TAG, String.format(</span><br><span class="line">                <span class="string">&quot;Creating a delay_met command for workSpec with id (%s)&quot;</span>, workSpecId));</span><br><span class="line">        <span class="comment">// 4.再回到 Dispatcher 进行处理</span></span><br><span class="line">        mDispatcher.postOnMainThread(</span><br><span class="line">                <span class="keyword">new</span> SystemAlarmDispatcher.AddRunnable(mDispatcher, intent, mStartId));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mWorkConstraintsTracker.reset();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> Intent <span class="title">createDelayMetIntent</span><span class="params">(<span class="meta">@NonNull</span> Context context, <span class="meta">@NonNull</span> String workSpecId)</span> </span>&#123;</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent(context, SystemAlarmService.class);</span><br><span class="line">        <span class="comment">// 新的aciton</span></span><br><span class="line">        intent.setAction(ACTION_DELAY_MET);</span><br><span class="line">        intent.putExtra(KEY_WORKSPEC_ID, workSpecId);</span><br><span class="line">        <span class="keyword">return</span> intent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>handleConstraintsChanged</code>()方法的执行中，会创建一个action为<code>ACTION_DELAY_MET</code>的Intent然后由<code>SystemAlarmDispatcher</code>发送出去，再次重复上面的过程<code>SystemAlarmDispatcher#add</code> -&gt;<code>SystemAlarmDispatcher#processCommand</code> -&gt; <code>CommandHandler.onHandleIntent</code> ，然后由于此时的action是，进入到<code>handleDelayMet</code>中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleDelayMet</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@NonNull</span> Intent intent,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">int</span> startId,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@NonNull</span> SystemAlarmDispatcher dispatcher)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Bundle extras = intent.getExtras();</span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            String workSpecId = extras.getString(KEY_WORKSPEC_ID);</span><br><span class="line">							  <span class="comment">//...</span></span><br><span class="line">                DelayMetCommandHandler delayMetCommandHandler =</span><br><span class="line">                        <span class="keyword">new</span> DelayMetCommandHandler(mContext, startId, workSpecId, dispatcher);</span><br><span class="line">                mPendingDelayMet.put(workSpecId, delayMetCommandHandler);</span><br><span class="line">                <span class="comment">// 继续处理</span></span><br><span class="line">                delayMetCommandHandler.handleProcessWork();</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="meta">@WorkerThread</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handleProcessWork</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line">    WorkSpec workSpec = mDispatcher.getWorkManager()</span><br><span class="line">            .getWorkDatabase()</span><br><span class="line">            .workSpecDao()</span><br><span class="line">            .getWorkSpec(mWorkSpecId);</span><br><span class="line"></span><br><span class="line">    mHasConstraints = workSpec.hasConstraints();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mHasConstraints) &#123;</span><br><span class="line">        Logger.get().debug(TAG, String.format(<span class="string">&quot;No constraints for %s&quot;</span>, mWorkSpecId));</span><br><span class="line">      <span class="comment">// 所有条件都满足 </span></span><br><span class="line">      onAllConstraintsMet(Collections.singletonList(mWorkSpecId));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Allow tracker to report constraint changes</span></span><br><span class="line">        mWorkConstraintsTracker.replace(Collections.singletonList(workSpec));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAllConstraintsMet</span><span class="params">(<span class="meta">@NonNull</span> List&lt;String&gt; workSpecIds)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// WorkConstraintsTracker will call onAllConstraintsMet with list of workSpecs whose</span></span><br><span class="line">    <span class="comment">// constraints are met. Ensure the workSpecId we are interested is part of the list</span></span><br><span class="line">    <span class="comment">// before we call Processor#startWork().</span></span><br><span class="line">    <span class="keyword">if</span> (!workSpecIds.contains(mWorkSpecId)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mCurrentState == STATE_INITIAL) &#123;</span><br><span class="line">            mCurrentState = STATE_START_REQUESTED;</span><br><span class="line">						<span class="comment">// 启动</span></span><br><span class="line">            <span class="keyword">boolean</span> isEnqueued = mDispatcher.getProcessor().startWork(mWorkSpecId);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (isEnqueued) &#123;</span><br><span class="line">                <span class="comment">// setup timers to enforce quotas on workers that have</span></span><br><span class="line">                <span class="comment">// been enqueued</span></span><br><span class="line">                mDispatcher.getWorkTimer()</span><br><span class="line">                        .startTimer(mWorkSpecId, WORK_PROCESSING_TIME_IN_MS, <span class="keyword">this</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// if we did not actually enqueue the work, it was enqueued before</span></span><br><span class="line">                <span class="comment">// cleanUp and pretend this never happened.</span></span><br><span class="line">                cleanUp();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Logger.get().debug(TAG, String.format(<span class="string">&quot;Already started work for %s&quot;</span>, mWorkSpecId));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到这里终于看到由<code>SystemAlarmDispatcher</code>调用了<code>Processor#startWork</code>方法，回到了之前的任务执行流程中。</p>
<h1 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h1><p>至此，<code>WorkManager</code> 的基本原理就分析完毕了，其实<code>WorkManager</code>中任务的周期和约束条件都是依赖于系统的机制，<code>WorkManager</code> 运用策略模式很好的兼容了不同 android 版本。</p>
<p><img src="/pics/v2-bffd85c278ba2eb0bf8ef550e9b93b4f_r.jpg" alt="preview"></p>

    </div>

    
    
    
      

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>sven
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://zhaoxiaowen-sven.github.io/2022/05/21/Notes/Android/03Jetpack/Jetpack_05_WorkManager%E5%8E%9F%E7%90%86/" title="Jetpack_05_WorkManager原理">https://zhaoxiaowen-sven.github.io/2022/05/21/Notes/Android/03Jetpack/Jetpack_05_WorkManager原理/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/05/14/Notes/Android/03Jetpack/Jetpack_04_WorkManager%E4%BD%BF%E7%94%A8/" rel="prev" title="Jetpack_04_WorkManager使用">
      <i class="fa fa-chevron-left"></i> Jetpack_04_WorkManager使用
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/06/25/Notes/Android/05%E6%8F%92%E4%BB%B6%E5%8C%96/Android%E6%8F%92%E4%BB%B6%E5%8C%9601_ClassLoader/" rel="next" title="Java进阶04_ClassLoader">
      Java进阶04_ClassLoader <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Jetpack-05-WorkManager%E5%8E%9F%E7%90%86"><span class="nav-text">Jetpack_05_WorkManager原理</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81WorkManager%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-text">一、WorkManager的初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1%E3%80%81WorkManagerInitializer"><span class="nav-text">1.1、WorkManagerInitializer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2%E3%80%81WorkManagerImpl"><span class="nav-text">1.2、WorkManagerImpl</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Scheduler"><span class="nav-text">Scheduler</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81WorkRequest%E5%88%9B%E5%BB%BA"><span class="nav-text">二、WorkRequest创建</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1%E3%80%81WorkSpec"><span class="nav-text">2.1、WorkSpec</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2%E3%80%81WorkRequest-build"><span class="nav-text">2.2、WorkRequest#build</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E4%BB%BB%E5%8A%A1%E7%9A%84%E6%89%A7%E8%A1%8C"><span class="nav-text">三、任务的执行</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1%E3%80%81workManager-enqueue"><span class="nav-text">3.1、workManager#enqueue</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#WorkContinuationImpl"><span class="nav-text">WorkContinuationImpl</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Schedulers-schedule"><span class="nav-text">Schedulers#schedule</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2%E3%80%81%E6%97%A0%E9%99%90%E5%88%B6%E6%9D%A1%E4%BB%B6%E4%BB%BB%E5%8A%A1%E7%9A%84%E6%89%A7%E8%A1%8C"><span class="nav-text">3.2、无限制条件任务的执行</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#GreedyScheduler-schedule"><span class="nav-text">GreedyScheduler#schedule</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#WorkManager-startWork"><span class="nav-text">WorkManager#startWork</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#StartWorkRunnable-run"><span class="nav-text">StartWorkRunnable#run</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Processor-startWork"><span class="nav-text">Processor#startWork</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#WorkerWrapper-run"><span class="nav-text">WorkerWrapper#run</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#WorkerWrapper-onWorkFinished"><span class="nav-text">WorkerWrapper#onWorkFinished</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3%E3%80%81%E6%9C%89%E9%99%90%E5%88%B6%E6%9D%A1%E4%BB%B6%E4%BB%BB%E5%8A%A1%E7%9A%84%E6%89%A7%E8%A1%8C"><span class="nav-text">3.3、有限制条件任务的执行</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SystemJobScheduler-Version-gt-23"><span class="nav-text">SystemJobScheduler(Version &gt;&#x3D;23)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SystemJobService"><span class="nav-text">SystemJobService</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SystemAlarmScheduler-Version-lt-23"><span class="nav-text">SystemAlarmScheduler(Version &lt;23)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#CommandHandler-onHandleIntent"><span class="nav-text">CommandHandler#onHandleIntent</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E6%80%BB%E7%BB%93"><span class="nav-text">四、总结</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="sven"
      src="/images/sven.jpeg">
  <p class="site-author-name" itemprop="name">sven</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">78</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/zhaoxiaowen-sven" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zhaoxiaowen-sven" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zhaoxiaowen-sven@gmail.com" title="E-Mail → mailto:zhaoxiaowen-sven@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">sven</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
